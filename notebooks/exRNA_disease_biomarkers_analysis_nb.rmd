---
title: "exRNA_disease_biomarkers_nb"
output: html_notebook
author:
- name: "Roman E. Reggiardo"
  affiliation: "UC Santa Cruz Dept. of Biomolecular Engineering"
  email: "rreggiar@ucsc.edu"
editor_options: 
  chunk_output_type: console
---
# nb_setup
```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, collapse = T)
knitr::opts_chunk$set(message = F)
here::set_here('/home/rreggiar/')
here::here()
suppressPackageStartupMessages(library(tidyverse))
```

# global_init
## ggplot_theme
```{r}
library(ggplot2)
library(ggthemes)
base_size = 10

ggplot2::theme_set(ggthemes::theme_foundation(base_size = base_size,
                                              base_family = 'Helvetica') + 
                     theme(plot.title = element_blank(),
                           panel.background = element_rect(colour = NA),
                           plot.background = element_rect(colour = NA),
                           panel.border = element_rect(colour = NA), 
                           axis.line = element_line(), 
                           axis.line.x = NULL, 
                           axis.line.y = NULL, 
                           axis.text = element_text(size = rel(0.95)), 
                           axis.text.x = element_text(margin = 
                                                        margin(t = 0.8 * base_size/4)), 
                           axis.text.x.top = element_text(margin = 
                                                            margin(b = 0.8 * base_size/4), 
                                                          vjust = 0), 
                           axis.text.y = element_text(margin = 
                                                        margin(r = 0.5 * base_size/4), 
                                                      hjust = 1),
                           axis.text.y.right = element_text(margin = 
                                                              margin(l = 0.5 * base_size/4), 
                                                            hjust = 0), 
                           axis.ticks = element_line(), 
                           axis.ticks.length = unit(base_size/2.5, "pt"), axis.ticks.length.x = NULL, 
                           axis.ticks.length.x.top = NULL, axis.ticks.length.x.bottom = NULL, 
                           axis.ticks.length.y = NULL, axis.ticks.length.y.left = NULL, 
                           axis.ticks.length.y.right = NULL,
                           strip.text = element_text(size = rel(0.95), face = 'bold'),
                           strip.background = element_blank(),
                           legend.key.size= unit(0.08, "in"),
                           legend.spacing = unit(0, "in"),
                           legend.key = element_rect(colour = NA),
                           legend.title = element_text(face="italic"),
                           legend.text = element_text(face = 'bold'),
                           legend.justification = c("right", "top"),
                           legend.box.just = "right",
                           legend.margin = margin(6, 6, 6, 6),
                           plot.margin=margin(0.04,
                                              0.04,
                                              0.04,
                                              0.04,
                                              unit = "in"),
                           legend.box.spacing = unit(-0.02, 'in'),
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank()
                           )
                   )
```

## data_path_obj
```{r}
figure.dir <- here::here('manuscript/figures')
input_data.dir <- here::here('data/input_data')
output_data.dir <- here::here('data/output_data')
qc_data.dir <- here::here('data/output_data/rna_qc')
meta_data.dir <- here::here('data/meta_data')
reference.dir <- here::here('reference')
r_code.dir <- here::here('R')
```

## figure_export
```{r}
figure_single_column_width = unit(89, 'mm')
figure_double_column_with = unit(183, 'mm')
figure_depth = unit(247, 'mm')

# install.packages("import")

import::from(.directory = r_code.dir, .from = 'helper_analysisFunctions.R', save.manuscript.panel)
```

## analysis_const
```{r}
chr_order <- c('chr1', 'chr2', 'chr3', 
               'chr4', 'chr5', 'chr6', 
               'chr7', 'chr8', 'chr9',
               'chr10', 'chr11', 'chr12', 
               'chr13', 'chr14', 'chr15', 
               'chr16', 'chr17',
               'chr18', 'chr19', 'chr20', 
               'chr21', 'chr22', 'chrX', 'chrY')


gencode_ver <- 39

```

## meta_data_construction
```{r}

## reference meta data
if (! file.exists(file.path(meta_data.dir, 'reference_meta_data_df.rds'))) {
  
  reference_meta_data <- tibble::lst()
  
  reference_meta_data$ucsc_rmsk_insert_info.df <- 
    readr::read_tsv(file.path(reference.dir, 'ucsc.rmsk.insert.info.txt'),
             col_names = c('gene', 'clade', 'family'))
  
  reference_meta_data$gencode_tx_to_gene.df <- 
    readr::read_csv(file.path(reference.dir, 
                              paste0('gencode.v', gencode_ver, '.tx.to.gene.csv')),
                    col_names = c('tx', 'gene')) %>% 
    tidyr::separate(tx, sep = '\\|', 
                    into = c('enst','ensg',NA,NA,'tx','gene','len','biotype'))
  
  reference_meta_data$gencode_tx_to_gene.df %>% 
    dplyr::select(-enst) %>% 
    dplyr::group_by(biotype) %>% 
    dplyr::tally() -> reference_meta_data$gencode_biotype_count.df
  
  reference_meta_data$gencode_tx_to_gene.df %>% 
    dplyr::select(gene,biotype) %>% 
    dplyr::group_by(gene) %>% 
    dplyr::filter(all(biotype == 'lncRNA')) %>% 
    dplyr::distinct() -> reference_meta_data$gencode_lncRNA_gene_names.df
  
  reference_meta_data$ucsc_rmsk_tx_to_gene.df <-  
    readr::read_csv(file.path(reference.dir, 
                              'ucsc.rmsk.insert.analysis.tx.to.gene.csv'),
                    col_names = c('insert', 'info', 'gene', 'len', 'biotype')) %>% 
    mutate(enst = insert, ensg = info, tx = insert) %>% 
    select(enst, ensg, tx, gene, len, biotype, -insert, -info)
  
  reference_meta_data$total_tx_to_gene.df <- 
    rbind(reference_meta_data$gencode_tx_to_gene.df,
          reference_meta_data$ucsc_rmsk_tx_to_gene.df)
  
  saveRDS(reference_meta_data, file.path(meta_data.dir, 'reference_meta_data_df.rds'))
  
} else {
  reference_meta_data <- readRDS(file.path(meta_data.dir, 'reference_meta_data_df.rds'))
}

## sample_meta_data
if (! file.exists(file.path(meta_data.dir, 'sample_meta_data_df.rds'))) {
  
  list.files(meta_data.dir, pattern = '*_meta_data.csv') -> meta_file.list
  names(meta_file.list) <- meta_file.list
  
  meta_file.list %>% 
    purrr::imap(function(name, file) {
      readr::read_csv(file.path(meta_data.dir, file))
    }) -> sample_meta_data
  
  saveRDS(sample_meta_data, file.path(meta_data.dir, 'sample_meta_data_df.rds'))
  
} else {
  sample_meta_data <- readRDS(file.path(meta_data.dir, 'sample_meta_data_df.rds'))
}

```

# import_data
## load_tximeta_obj
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             load.tximeta.object.list,
             parse.tximeta.quant.metadata)

salmon_quant <- load.tximeta.object.list('salmon', 
                                         output_data.dir = output_data.dir)

salmon_quant <- parse.tximeta.quant.metadata(salmon_quant)

ucsc.rmsk.salmon_quant <- load.tximeta.object.list('ucsc.rmsk.salmon', 
                                                   output_data.dir = output_data.dir)

ucsc.rmsk.salmon_quant <- parse.tximeta.quant.metadata(ucsc.rmsk.salmon_quant)

process.aware.salmon_quant <- load.tximeta.object.list('process.aware.salmon', 
                                                       output_data.dir = output_data.dir)

process.aware.salmon_quant <- parse.tximeta.quant.metadata(process.aware.salmon_quant)
```

# analysis_INTERACTIVE
## QC_filter
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             subset.tximeta.se)

qc_fails <- c('panc.6.2.5', 'panc.7.2.5', 'panc.9.2.5', 'panc.10.2.5')

salmon_quant$bioIvt_panc_salmon <- 
  subset.tximeta.se(salmon_quant$bioIvt_panc_salmon, 
                    filter_list = qc_fails)

ucsc.rmsk.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 
  subset.tximeta.se(ucsc.rmsk.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon, 
                    filter_list = qc_fails)

process.aware.salmon_quant$bioIvt_panc_process.aware.salmon <- 
  subset.tximeta.se(process.aware.salmon_quant$bioIvt_panc_process.aware.salmon, 
                    filter_list = qc_fails)


```

## construct_analysis_sets
```{r}
tmp_fxn <- function(se_list,
                    se_1,
                    se_2 = NULL,
                    analysis_set_2 = NULL) { 
  
  if(! "SparseSummarizedExperiment" %in% rownames(installed.packages())) { 
    devtools::install_github("PeteHaitch/SparseSummarizedExperiment")
  }
  
  if(is.null(analysis_set_2) & !is.null(se_2)) { 
    
    quant_meta_return <- 
      bind_rows(se_list[['quant_meta']][names(se_list[['quant_meta']]) %in% c(se_1, se_2)])
  
    gxi_return <-
        SparseSummarizedExperiment::cbind(se_list[[se_1]]$gxi,
                                          se_list[[se_2]]$gxi)
  
    txi_return <- 
        SparseSummarizedExperiment::cbind(se_list[[se_1]]$txi,
                                        se_list[[se_2]]$txi)
  
    lst('gxi' = gxi_return,
        'txi' = txi_return,
        'quant_meta' = quant_meta_return)
    
  } else {
      
    quant_meta_return <- 
      rbind(se_list[['quant_meta']][names(se_list[['quant_meta']]) %in% c(se_1)][[1]],
            analysis_set_2[['quant_meta']]) %>% 
      distinct()
    
    gxi_return <-
        SparseSummarizedExperiment::cbind(se_list[[se_1]]$gxi,
                                          analysis_set_2[['gxi']])
    txi_return <-
        SparseSummarizedExperiment::cbind(se_list[[se_1]]$txi,
                                          analysis_set_2[['txi']])

    lst('gxi' = gxi_return,
        'txi' = txi_return,
        'quant_meta' = quant_meta_return)

    }

}


salmon_quant$analysis_set$panc_ctrl <- 
  tmp_fxn(se_list = salmon_quant, se_1 = 'bioIvt_panc_salmon', se_2 = 'pittsburgh_ctrl_salmon')

salmon_quant$analysis_set$covid_ctrl <- 
  tmp_fxn(se_list = salmon_quant, se_1 = 'bioIvt_covid_salmon', se_2 = 'pittsburgh_ctrl_salmon')

salmon_quant$analysis_set$ctrl_panc_covid <- 
  tmp_fxn(se_list = salmon_quant, se_1 = 'bioIvt_covid_salmon', 
          analysis_set_2 = salmon_quant$analysis_set$panc_ctrl)
```

## run_DESeq
```{r}

```

