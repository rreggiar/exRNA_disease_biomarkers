---
title: "exRNA_disease_biomarkers_nb"
output: html_notebook
date: "`r sys.Date()`"
author:
- name: "Roman E. Reggiardo"
  affiliation: "UC Santa Cruz Dept. of Biomolecular Engineering"
  email: "rreggiar@ucsc.edu"
editor_options: 
  chunk_output_type: console
---
# nb_setup
```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, collapse = T)
knitr::opts_chunk$set(message = F)
here::here()
suppressPackageStartupMessages(library(tidyverse))
```

# global_init

## ggplot_theme
```{r}
library(ggplot2)
library(ggthemes)
base_size = 7

ggplot2::theme_set(ggthemes::theme_foundation(base_size = base_size,
                                              base_family = 'Helvetica') + 
                     theme(plot.title = element_text(size = base_size, face = 'bold'),
                           panel.background = element_rect(colour = NA),
                           plot.background = element_rect(colour = NA),
                           panel.border = element_rect(colour = NA), 
                           axis.line = element_line(), 
                           axis.line.x = NULL, 
                           axis.line.y = NULL, 
                           axis.text = element_text(size = rel(0.95)), 
                           axis.text.x = element_text(margin = 
                                                        margin(t = 0.8 * base_size/4)), 
                           axis.text.x.top = element_text(margin = 
                                                            margin(b = 0.8 * base_size/4), 
                                                          vjust = 0), 
                           axis.text.y = element_text(margin = 
                                                        margin(r = 0.5 * base_size/4), 
                                                      hjust = 1),
                           axis.text.y.right = element_text(margin = 
                                                              margin(l = 0.5 * base_size/4), 
                                                            hjust = 0), 
                           axis.ticks = element_line(), 
                           axis.ticks.length = unit(base_size/2.5, "pt"), axis.ticks.length.x = NULL, 
                           axis.ticks.length.x.top = NULL, axis.ticks.length.x.bottom = NULL, 
                           axis.ticks.length.y = NULL, axis.ticks.length.y.left = NULL, 
                           axis.ticks.length.y.right = NULL,
                           strip.text = element_text(size = rel(0.8), face = 'bold'),
                           strip.background = element_rect(size = 0.5),
                           legend.key.size= unit(0.08, "in"),
                           legend.spacing = unit(0, "in"),
                           legend.key = element_rect(colour = NA),
                           legend.title = element_text(face="italic"),
                           legend.title.align=0.5,
                           legend.text = element_text(face = 'bold'),
                           legend.justification = c("right", "top"),
                           legend.background = element_rect(size = 0.25, colour = 'black'),
                           legend.box.just = "right",
                           legend.margin = margin(6, 6, 6, 6),
                           plot.tag = element_text(size = base_size, face = 'bold'),
                           plot.margin=margin(0.04,
                                              0.04,
                                              0.04,
                                              0.04,
                                              unit = "in"),
                           legend.box.spacing = unit(-0.02, 'in'),
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank()
                           )
                   )

theme_set_fun <- function(){
  
  ggplot2::theme_set(ggthemes::theme_foundation(base_size = base_size,
                                              base_family = 'Helvetica') + 
                     theme(plot.title = element_text(size = base_size, face = 'bold'),
                           panel.background = element_rect(colour = NA),
                           plot.background = element_rect(colour = NA),
                           panel.border = element_rect(colour = NA), 
                           axis.line = element_line(), 
                           axis.line.x = NULL, 
                           axis.line.y = NULL, 
                           axis.text = element_text(size = rel(0.95)), 
                           axis.text.x = element_text(margin = 
                                                        margin(t = 0.8 * base_size/4)), 
                           axis.text.x.top = element_text(margin = 
                                                            margin(b = 0.8 * base_size/4), 
                                                          vjust = 0), 
                           axis.text.y = element_text(margin = 
                                                        margin(r = 0.5 * base_size/4), 
                                                      hjust = 1),
                           axis.text.y.right = element_text(margin = 
                                                              margin(l = 0.5 * base_size/4), 
                                                            hjust = 0), 
                           axis.ticks = element_line(), 
                           axis.ticks.length = unit(base_size/2.5, "pt"), axis.ticks.length.x = NULL, 
                           axis.ticks.length.x.top = NULL, axis.ticks.length.x.bottom = NULL, 
                           axis.ticks.length.y = NULL, axis.ticks.length.y.left = NULL, 
                           axis.ticks.length.y.right = NULL,
                           strip.text = element_text(size = rel(0.8), face = 'bold'),
                           strip.background = element_rect(size = 0.5),
                           legend.key.size= unit(0.08, "in"),
                           legend.spacing = unit(0, "in"),
                           legend.key = element_rect(colour = NA),
                           legend.title = element_text(face="italic"),
                           legend.text = element_text(face = 'bold'),
                           legend.justification = c("right", "top"),
                           legend.background = element_rect(size = 0.25, colour = 'black'),
                           legend.box.just = "right",
                           legend.margin = margin(6, 6, 6, 6),
                           plot.tag = element_text(size = base_size, face = 'bold'),
                           plot.margin=margin(0.04,
                                              0.04,
                                              0.04,
                                              0.04,
                                              unit = "in"),
                           legend.box.spacing = unit(-0.02, 'in'),
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank()
                           )
                   )
  
}


txt.mm_to_pts <- function(ratio){ base_size * ratio * (25.4 / 72.27) }
```
## data_path_obj
```{r}
figure.dir <- here::here('manuscript/figures')
input_data.dir <- here::here('data/input_data')
output_data.dir <- here::here('data/output_data')
qc_data.dir <- here::here('data/output_data/rna_qc')
meta_data.dir <- here::here('data/meta_data')
reference.dir <- here::here('reference')
r_code.dir <- here::here('R')
```
## figure_export
```{r}
figure_single_column_width = unit(90, 'mm')
figure_double_column_width = unit(180, 'mm')
figure_depth = unit(170, 'mm')
panel_height_1 = unit(170/3, 'mm')

# install.packages("import")

import::from(.directory = r_code.dir, .from = 'helper_analysisFunctions.R', save.manuscript.panel)
```
## analysis_const
```{r}
chr_order <- c('chr1', 'chr2', 'chr3', 
               'chr4', 'chr5', 'chr6', 
               'chr7', 'chr8', 'chr9',
               'chr10', 'chr11', 'chr12', 
               'chr13', 'chr14', 'chr15', 
               'chr16', 'chr17',
               'chr18', 'chr19', 'chr20', 
               'chr21', 'chr22', 'chrX', 'chrY')


gencode_ver <- 39

three_color_pal <- RColorBrewer::brewer.pal(n = 3, 'Dark2')
eight_color_pal <- RColorBrewer::brewer.pal(n = 8, 'Dark2')
viridis_three_color_pal <- viridisLite::plasma(20)[c(1,9,16)]



orig_identity_color_pal <- c('ctrl' = viridis_three_color_pal[[1]],
                             'panc' = viridis_three_color_pal[[2]],
                             'covid' = viridis_three_color_pal[[3]])

disc_identity_color_pal <- c('normal' = viridis_three_color_pal[[1]],
                             'panc' = viridis_three_color_pal[[2]])

te_aware_annotation_levels <- c('GENCODE_coding',
                                 'GENCODE_lncRNA',
                                 'LINE',
                                 'SINE',
                                 'LTR',
                                 'DNA',
                                 'Simple_repeat',
                                 'other')

te_color_pal <- c('grey', RColorBrewer::brewer.pal(n = 7, 'Dark2'))
names(te_color_pal) <- te_aware_annotation_levels

te_alone_annotation_levels <- c('LINE',
                                'SINE',
                                'LTR',
                                'DNA',
                                'Simple_repeat',
                                'rRNA',
                                'tRNA')
te_alone_color_pal <- RColorBrewer::brewer.pal(n = 8, 'Dark2')[2:8]
names(te_alone_color_pal) <- te_alone_annotation_levels

import::from(.from = 'SummarizedExperiment',
             rowRanges)
disc_identity_shape_pal <- c('Male' = 23, 'Female' = 25)


```

# meta_data_construction

## reference meta data
```{r}

## reference meta data
if (!file.exists(file.path(meta_data.dir, 'reference_meta_data_df.rds'))) {
  reference_meta_data <- tibble::lst()
  
  reference_meta_data$ucsc_rmsk_insert_info.df <-
    readr::read_tsv(
      file.path(reference.dir, 'ucsc.rmsk.insert.info.txt'),
      col_names = c('gene', 'clade', 'family')
    )
  
  reference_meta_data$gencode_tx_to_gene.df <-
    readr::read_csv(file.path(
      reference.dir,
      paste0('gencode.v', gencode_ver, '.tx.to.gene.csv')
    ),
    col_names = c('tx', 'gene')) %>%
    tidyr::separate(
      tx,
      sep = '\\|',
      into = c('enst', 'ensg', NA, NA, 'tx', 'gene', 'len', 'biotype')
    )
  
  reference_meta_data$gencode_tx_to_gene.df %>%
    dplyr::select(-enst) %>%
    dplyr::group_by(biotype) %>%
    dplyr::tally() -> reference_meta_data$gencode_biotype_count.df
  
  reference_meta_data$gencode_tx_to_gene.df %>%
    dplyr::select(ensg, biotype) %>%
    dplyr::group_by(ensg) %>%
    dplyr::filter(all(biotype == 'lncRNA')) %>%
    dplyr::distinct() -> reference_meta_data$gencode_lncRNA_gene_names.df
  
  reference_meta_data$ucsc_rmsk_tx_to_gene.df <-
    readr::read_csv(
      file.path(reference.dir,
                'ucsc.rmsk.insert.analysis.tx.to.gene.csv'),
      col_names = c('insert', 'info', 'gene', 'len', 'biotype')
    ) %>%
    mutate(enst = insert, ensg = gene, tx = insert) %>%
    select(enst, ensg, tx, gene, len, biotype,-insert,-info)
  
  reference_meta_data$total_tx_to_gene.df <-
    rbind(
      reference_meta_data$gencode_tx_to_gene.df,
      reference_meta_data$ucsc_rmsk_tx_to_gene.df
    )
  
  saveRDS(reference_meta_data,
          file.path(meta_data.dir, 'reference_meta_data_df.rds'))
  
} else {
  reference_meta_data <-
    readRDS(file.path(meta_data.dir, 'reference_meta_data_df.rds'))
}
```
## original sample metadata
```{r}

## sample_meta_data
if (!file.exists(file.path(meta_data.dir, 'sample_meta_data_df.rds'))) {
  list.files(meta_data.dir, pattern = '*_meta_data.csv') -> meta_file.list
  names(meta_file.list) <- meta_file.list
  
  meta_file.list %>%
    purrr::imap(function(name, file) {
      readr::read_csv(file.path(meta_data.dir, file))
    }) -> sample_meta_data
  
  saveRDS(sample_meta_data,
          file.path(meta_data.dir, 'sample_meta_data_df.rds'))
  
} else {
  sample_meta_data <-
    readRDS(file.path(meta_data.dir, 'sample_meta_data_df.rds'))
}

original_roster_names <- read_csv(
  file.path(meta_data.dir,
            "original_roster_data_2020-09-30.csv"),
  col_names = c('sample', 'name')
  ) %>%
  mutate(sample = str_split_fixed(sample, '_S', 2)[, 1])

original_panc_staged_data <-
  read_csv(file.path(meta_data.dir, 'bioIVT_panc_staged_metadata_2023-03-06.csv'))


original_panc_meta_data <-
  sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv` %>% 
  filter(condition == 'panc') %>% 
  dplyr::rename(sample = patient, diagnosis = condition) %>% 
  merge(original_panc_staged_data %>% select(sample, stage), by ='sample') %>% 
  mutate(tmp = sample, dataset = 'pilot') %>% 
  mutate(input_vol = as.numeric(
      str_split_fixed(
      string = str_split_fixed(string = tmp, pattern = '[.]', n = 2)[,2],
      pattern = '[.]',
      n = 2)[,2]
    ) * 1000) # convert to uL

original_covid_meta_data <- 
  sample_meta_data$`2022.01.14_bioIVTCovid_meta_data.csv` %>% 
  dplyr::rename(sample = patient) %>% 
  mutate(tmp = sample, diagnosis = 'covid', dataset = 'pilot') %>% 
  mutate(input_vol = as.numeric(
      str_split_fixed(
      string = str_split_fixed(string = tmp, pattern = '[.]', n = 2)[,2],
      pattern = '[.]',
      n = 2)[,2]
    ) * 1000) #convert to uL


original_meta_data <- 
  sample_meta_data$`2022.01.14_combined_meta_data.csv` %>% 
  dplyr::rename(sample = patient, diagnosis = condition, gender = sex) %>% 
  mutate(tmp = sample, dataset = 'pilot') %>% 
  mutate(input_vol = as.numeric(
      str_split_fixed(
      string = str_split_fixed(string = tmp, pattern = '[.]', n = 2)[,2],
      pattern = '[.]',
      n = 2)[,2]
    ) * 1000)

```
## discovery cohort metadata
```{r}
discovery_meta_data <- read_csv(file.path(
  meta_data.dir,
  'discovery_meta_data_w_inputVol_2023-02-10.csv'
)) %>% 
  mutate(dataset = 'discovery')

colnames(discovery_meta_data) <-
  str_remove(str_remove_all(str_remove_all(colnames(
    discovery_meta_data
  ), pattern = 'sample_sku_'), pattern = 'patient_'),
  pattern = '_at_collection')
```
## external cohorts metadata
```{r}

# gut_meta_data <-
#   read_csv(file.path(meta_data.dir, 'ext_meta_data', 'GSE133684_meta.txt')) %>%
#   select(sample = Run,
#          diagnosis = disease_state) %>% 
#   mutate(input_vol = 1000, dataset = 'gut')

elife_meta_data <-
  read_csv(file.path(meta_data.dir, 'ext_meta_data', 'GSE174302_meta.txt')) %>% 
  select(
    sample = Run,
    age = Age,
    diagnosis = disease,
    gender
  ) %>%
  mutate(diagnosis = str_replace_all(
    string = diagnosis,
    pattern = ' patient',
    replacement = ''
  )) %>% 
  mutate(input_vol = 1000, dataset = 'elife')

# npj_meta_data <- 
#   read_csv(file.path(meta_data.dir, 'ext_meta_data', 'GSE182824_meta.txt')) %>% 
#   select(
#     sample = Run,
#     age = Age,
#     cohort = Cohort,
#     diagnosis = source_name,
#     gender
#   ) %>%
#   mutate(diagnosis = str_replace_all(
#     string = diagnosis,
#     pattern = ' plasma',
#     replacement = ''
#   )) %>% 
#   mutate(diagnosis = str_replace_all(
#     string = diagnosis,
#     pattern = 'Human ',
#     replacement = ''
#   )) %>% 
#   mutate(diagnosis = str_replace_all(
#     string = diagnosis,
#     pattern = ' donor',
#     replacement = ''
#   )) %>% 
#   mutate(input_vol = 3000, dataset = 'precision_onc')
```
## united metadata
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             matching_rbind)

united_metadata_df <- matching_rbind(
  # 'gut_meta_data',
  'elife_meta_data',
  # 'npj_meta_data',
  'discovery_meta_data',
  'original_panc_meta_data',
  'original_covid_meta_data'
)

original_discovery_meta_data <- 
  matching_rbind('original_meta_data',
                 'discovery_meta_data')

original_normal_meta_data <- 
  matching_rbind('original_panc_meta_data',
                 'discovery_meta_data')

origCovid_normal_meta_data <-
  matching_rbind('original_covid_meta_data',
                 'discovery_meta_data') %>% 
  filter(diagnosis %in% c('covid', 'normal'))

origCovid_normal_meta_data <-
  matching_rbind('original_covid_meta_data',
                 'discovery_meta_data') %>% 
  filter(diagnosis %in% c('covid', 'normal'))


```

# import_data

## load_tximeta_obj
```{r}
import::from(
  .directory = r_code.dir,
  .from = 'helper_analysisFunctions.R',
  load.tximeta.object.list,
  parse.tximeta.quant.metadata
)


internal_rmsk_quant <- load.tximeta.object.list('internal_rmsk_quant',
                                                 'rmsk')

internal_rmsk_quant <-
  parse.tximeta.quant.metadata(internal_rmsk_quant, extra_merge = original_roster_names)

internal_gencode_quant <- load.tximeta.object.list('internal_rmsk_quant',
                                                    'txonly')
internal_gencode_quant <-
  parse.tximeta.quant.metadata(internal_gencode_quant, extra_merge = original_roster_names)

# npj_rmsk_quant <-
#   load.tximeta.object.list('npj_rmsk_quant',
#                            'rmsk')
# npj_rmsk_quant <-
#   parse.tximeta.quant.metadata(npj_rmsk_quant)

elife_rmsk_quant <-
  load.tximeta.object.list('elife_rmsk_quant',
                           'rmsk')
elife_rmsk_quant <-
  parse.tximeta.quant.metadata(elife_rmsk_quant)

elife_gencode_quant <-
  load.tximeta.object.list('elife_rmsk_quant',
                           'txonly')
elife_gencode_quant <-
  parse.tximeta.quant.metadata(elife_gencode_quant)

# gut_rmsk_quant <-
#   load.tximeta.object.list('gut_rmsk_quant',
#                            'rmsk')
# gut_rmsk_quant <-
#   parse.tximeta.quant.metadata(gut_rmsk_quant)

```

# filter_data

## internal
```{r}
import::from(.directory = r_code.dir,
             .from = 'helper_analysisFunctions.R',
             subset.tximeta.se)

## create merged df that matches colData names to metaData names
merge(internal_rmsk_quant$rmsk$quant_meta,
      discovery_meta_data,
      by = 'sample') -> discovery_merge_meta_for_filt

qc_fails <- c('panc.6.2.5', 'panc.7.2.5', 'panc.9.2.5', 
              'panc.10.2.5', 'covid.427.0.80', 'covid.381.0.80')

# orig_covid_samples <-
#   internal_rmsk_quant$rmsk$quant_meta %>% 
#   filter(grepl('^covid', sample)) %>% 
#   pull(sample)

orig_panc_samples <-
  internal_rmsk_quant$rmsk$quant_meta %>%
  filter(grepl('^panc', sample)) %>%
  pull(sample)

unknown_samples <-
  internal_rmsk_quant$rmsk$quant_meta %>% 
  filter(grepl('^unknown', sample)) %>% 
  pull(sample)

pitts_samples <-
  internal_rmsk_quant$rmsk$quant_meta %>% 
  filter(grepl('^ctrl.', sample)) %>% 
  pull(sample)

esoph_samples <-
  internal_rmsk_quant$rmsk$quant_meta %>% 
  filter(grepl('^e', sample)) %>% 
  pull(sample)

normal_samples <-
  internal_rmsk_quant$rmsk$quant_meta %>% 
  filter(grepl('^n', sample)) %>% 
  pull(sample)

stage_IandII_select_list <- 
  discovery_merge_meta_for_filt %>% 
    filter(!stage %in% c('I-B', 'II-B', 'II'),
           diagnosis == 'panc') %>% 
  pull(sample)

stage_III_select_list <- 
  discovery_merge_meta_for_filt %>% 
    filter(!stage %in% c('III'),
           diagnosis == 'panc') %>% 
  pull(sample)

stage_IV_select_list <- 
  discovery_merge_meta_for_filt %>% 
    filter(!stage %in% c('IV', 'IV-B'),
           diagnosis == 'panc') %>% 
  pull(sample)

stage_IandII_select_list <- 
  discovery_merge_meta_for_filt %>% 
    filter(!stage %in% c('I-B', 'II-B', 'II'),
           diagnosis == 'panc') %>% 
  pull(sample)

stage_III_select_list <- 
  discovery_merge_meta_for_filt %>% 
    filter(!stage %in% c('III'),
           diagnosis == 'panc') %>% 
  pull(sample)

stage_IV_select_list <- 
  discovery_merge_meta_for_filt %>% 
    filter(!stage %in% c('IV', 'IV-B'),
           diagnosis == 'panc') %>% 
  pull(sample)

discovery_male_select_list <-
  discovery_merge_meta_for_filt %>% 
    filter(gender != 'Male' & diagnosis %in% c('panc', 'normal')) %>% 
  pull(sample)
  
discovery_female_select_list <-
  discovery_merge_meta_for_filt %>% 
    filter(gender != 'Female' & diagnosis %in% c('panc', 'normal')) %>% 
  pull(sample)

preTx_select_list <-
  discovery_merge_meta_for_filt %>%
  filter(diagnosis == 'panc') %>% 
  filter(if_any(
    c(
      treatment_status_radiation_treatment_status,
      treatment_status_resection_treatment_status
    ),
    ~ . != 'Pre Tx'
  )) %>% 
  pull(sample)

postTx_select_list <-
  discovery_merge_meta_for_filt %>%
  filter(diagnosis == 'panc') %>% 
  filter(if_all(
    c(
      treatment_status_radiation_treatment_status,
      treatment_status_resection_treatment_status
    ),
    ~ . == 'Pre Tx'
  )) %>% 
  pull(sample)

internal_rmsk_quant$panc_normal <-
  subset.tximeta.se(
    internal_rmsk_quant$rmsk,
    filter_list = c(
      qc_fails,
      orig_covid_samples,
      unknown_samples,
      esoph_samples,
      stage_IandII_select_list,
      stage_III_select_list,
      stage_IV_select_list,
      pitts_samples
    )
  )

internal_gencode_quant$panc_normal <-
  subset.tximeta.se(
    internal_gencode_quant$txonly,
    filter_list = c(
      qc_fails,
      orig_covid_samples,
      unknown_samples,
      esoph_samples,
      stage_IandII_select_list,
      stage_III_select_list,
      stage_IV_select_list,
      pitts_samples
    )
  )

internal_rmsk_quant$covid_ctrl <-
  subset.tximeta.se(
    internal_rmsk_quant$rmsk,
    filter_list = c(
      qc_fails,
      normal_samples,
      unknown_samples,
      orig_panc_samples,
      esoph_samples,
      stage_IandII_select_list,
      stage_III_select_list,
      stage_IV_select_list
    )
  )

rowRanges(internal_rmsk_quant$rmsk$gxi) %>%
  as.data.frame() %>%
  filter(seqnames == 'chrM') %>%
  select(group_name) %>%
  unlist() %>% unname() -> chrM.filter.list


```
## external elife
```{r}

merge(
  elife_rmsk_quant$rmsk$quant_meta,
    elife_meta_data,
    by = 'sample'
  ) -> elife_merge_meta_for_filt


elife_merge_meta_for_filt %>%
  filter(!diagnosis %in% c('Healthy donor', 'Colorectal Cancer')) %>%
  pull(sample) -> elife_colo_select

elife_merge_meta_for_filt %>%
  filter(!diagnosis %in% c('Healthy donor', 'Esophagus Cancer')) %>%
  pull(sample) -> elife_esoph_select

elife_merge_meta_for_filt %>%
  filter(!diagnosis %in% c('Healthy donor', 'Liver Cancer')) %>%
  pull(sample) -> elife_liver_select

elife_merge_meta_for_filt %>%
  filter(!diagnosis %in% c('Healthy donor', 'Lung Cancer')) %>%
  pull(sample) -> elife_lung_select

elife_merge_meta_for_filt %>%
  filter(!diagnosis %in% c('Healthy donor', 'Stomach Cancer')) %>% 
  pull(sample) -> elife_stomach_select

elife_rmsk_quant$colorectal_healthy <-
  subset.tximeta.se(elife_rmsk_quant$rmsk,
                    filter_list = c(elife_colo_select))

elife_rmsk_quant$esoph_healthy <-
  subset.tximeta.se(elife_rmsk_quant$rmsk,
                    filter_list = c(elife_esoph_select))

elife_rmsk_quant$liver_healthy <-
  subset.tximeta.se(elife_rmsk_quant$rmsk,
                    filter_list = c(elife_liver_select))

elife_rmsk_quant$lung_healthy <-
  subset.tximeta.se(elife_rmsk_quant$rmsk,
                    filter_list = c(elife_lung_select))

elife_rmsk_quant$stomach_healthy <-
  subset.tximeta.se(elife_rmsk_quant$rmsk,
                    filter_list = c(elife_stomach_select))
############

elife_gencode_quant$colorectal_healthy <-
  subset.tximeta.se(elife_gencode_quant$txonly,
                    filter_list = c(elife_colo_select))

elife_gencode_quant$esoph_healthy <-
  subset.tximeta.se(elife_gencode_quant$txonly,
                    filter_list = c(elife_esoph_select))

elife_gencode_quant$liver_healthy <-
  subset.tximeta.se(elife_gencode_quant$txonly,
                    filter_list = c(elife_liver_select))

elife_gencode_quant$lung_healthy <-
  subset.tximeta.se(elife_gencode_quant$txonly,
                    filter_list = c(elife_lung_select))

elife_gencode_quant$stomach_healthy <-
  subset.tximeta.se(elife_gencode_quant$txonly,
                    filter_list = c(elife_stomach_select))
```
## external npj
```{r}
# merge(
#   npj_rmsk_quant$rmsk$quant_meta,
#     npj_meta_data,
#     by = 'sample'
#   ) -> npj_merge_meta_for_filt
# 
# npj_select_list <-
#   filter(
#     external_quant$ucsc_rmsk_quant$quant_meta,
#     !sample %in% npj_merge_meta_for_filt$sample
#   ) %>% 
#   pull(sample)
# 
# external_quant$npj <-
#   subset.tximeta.se(external_quant$ucsc_rmsk_quant,
#                     filter_list = c(npj_select_list))
# 
# external_quant$npj_liverCancer <-
#   subset.tximeta.se(external_quant$ucsc_rmsk_quant,
#                     filter_list = c(npj_select_list,
#                                     npj_meta_data %>% 
#                                       filter(!diagnosis %in% c('liver cancer', 'non-cancer')) %>% 
#                                       pull(sample)))
# 
# external_quant$npj_liverCirrhosis <-
#   subset.tximeta.se(external_quant$ucsc_rmsk_quant,
#                     filter_list = c(npj_select_list,
#                                     npj_meta_data %>% 
#                                       filter(!diagnosis %in% c('liver cirrhosis', 'non-cancer')) %>% 
#                                       pull(sample)))


```
## external gut
```{r}
# merge(
#   gut_rmsk_quant$rmsk$quant_meta,
#     gut_meta_data,
#     by = 'sample'
#   ) -> gut_merge_meta_for_filt

```

# merge_metadata

## internal
```{r}
internal_rmsk_quant$panc_normal$quant_meta <-
  merge(
    internal_rmsk_quant$panc_normal$quant_meta,
    original_normal_meta_data,
    by = 'sample'
  )

internal_gencode_quant$panc_normal$quant_meta <-
  merge(
    internal_gencode_quant$panc_normal$quant_meta,
    original_normal_meta_data,
    by = 'sample'
  )

internal_rmsk_quant$covid_ctrl$quant_meta <-
  merge(
    internal_rmsk_quant$covid_ctrl$quant_meta,
    original_discovery_meta_data,
    by = 'sample'
  )

```
## external_elife
```{r}
elife_rmsk_quant$rmsk$quant_meta <-
  merge(elife_rmsk_quant$rmsk$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_rmsk_quant$colorectal_healthy$quant_meta <-
  merge(elife_rmsk_quant$colorectal_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_rmsk_quant$esoph_healthy$quant_meta <-
  merge(elife_rmsk_quant$esoph_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_rmsk_quant$liver_healthy$quant_meta <-
  merge(elife_rmsk_quant$liver_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_rmsk_quant$lung_healthy$quant_meta <-
  merge(elife_rmsk_quant$lung_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_rmsk_quant$stomach_healthy$quant_meta <-
  merge(elife_rmsk_quant$stomach_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

############
elife_gencode_quant$txonly$quant_meta <-
  merge(elife_gencode_quant$txonly$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_gencode_quant$colorectal_healthy$quant_meta <-
  merge(elife_gencode_quant$colorectal_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_gencode_quant$esoph_healthy$quant_meta <-
  merge(elife_gencode_quant$esoph_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_gencode_quant$liver_healthy$quant_meta <-
  merge(elife_gencode_quant$liver_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_gencode_quant$lung_healthy$quant_meta <-
  merge(elife_gencode_quant$lung_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

elife_gencode_quant$stomach_healthy$quant_meta <-
  merge(elife_gencode_quant$stomach_healthy$quant_meta,
        elife_meta_data,
        by = 'sample')

```
## external_npj
```{r}
# external_quant$npj$quant_meta <- 
#   merge(
#     external_quant$npj$quant_meta,
#     npj_meta_data,
#     by = 'sample'
#   )
```
## external_gut
```{r}
# gut_rmsk_quant$rmsk$quant_meta <- 
#   merge(
#     gut_rmsk_quant$rmsk$quant_meta,
#     gut_meta_data,
#     by = 'sample'
#   )
```
## construct_analysis_sets
```{r}
# import::from(.directory = r_code.dir, 
#              .from = 'helper_analysisFunctions.R', 
#              build.analysis.set)
# 
# 
# united_analysis_set <- list()
# 
# rbind(
#   internal_quant$filtered_data$quant_meta,
#   external_quant$elife$quant_meta %>% select(sample, contains('salmon')),
#   external_quant$npj$quant_meta %>% select(sample, contains('salmon')),
#   gut_quant$ucsc_rmsk_quant$quant_meta %>% select(sample, contains('salmon'))
# ) -> united_quant_meta
# 
# united_quant_meta %>%
#   merge(united_metadata_df, by = 'sample') %>%
#   mutate(diagnosis = ifelse(
#     diagnosis %in% c('Lung Cancer', 'non-cancer', 'PDAC', 'Liver Cancer'),
#     case_when(
#       diagnosis == 'Lung Cancer' ~ 'lung cancer',
#       diagnosis == 'non-cancer' ~ 'healthy',
#       diagnosis == 'PDAC' ~ 'panc',
#       diagnosis == 'Liver Cancer' ~ 'liver cancer'
#     ),
#     diagnosis
#   )) -> united_analysis_set$quant_meta
# 
# rm(united_quant_meta)
# 
# united_gxi_tmp <-
#       SparseSummarizedExperiment::cbind(internal_quant$filtered_data$gxi,
#                                         external_quant$ucsc_rmsk_quant$gxi)
# 
# united_analysis_set$gxi <-
#       SparseSummarizedExperiment::cbind(united_gxi_tmp,
#                                         gut_quant$ucsc_rmsk_quant$gxi)
# 
# united_analysis_set$gxi <-
#   SummarizedExperiment::subset(
#     united_analysis_set$gxi,
#     select = SummarizedExperiment::colData(united_analysis_set$gxi)$names %in% united_analysis_set$quant_meta$sample
#   )
# 
# rm(united_gxi_tmp)

##
# salmon_quant$analysis_set$panc_ctrl <- 
#   build.analysis.set(se_list = salmon_quant, 
#                      se_1 = 'bioIvt_panc_salmon', 
#                      se_2 = 'pittsburgh_ctrl_salmon',
#                      sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)
# 
# salmon_quant$analysis_set$covid_ctrl <- 
#   build.analysis.set(se_list = salmon_quant, 
#                      se_1 = 'bioIvt_covid_salmon', 
#                      se_2 = 'pittsburgh_ctrl_salmon',
#                      sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
# 
# salmon_quant$analysis_set$ctrl_panc_covid <- 
#   build.analysis.set(se_list = salmon_quant, 
#                      se_1 = 'bioIvt_panc_salmon', 
#                      analysis_set_2 = salmon_quant$analysis_set$covid_ctrl,
#                      sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
# ##
# ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl <- 
#     build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
#                        se_1 = 'bioIvt_panc_ucsc.rmsk.salmon', 
#                        se_2 = 'pittsburgh_ctrl_ucsc.rmsk.salmon',
#                        sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)
# 
# ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl <- 
#     build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
#                        se_1 = 'bioIvt_covid_ucsc.rmsk.salmon', 
#                        se_2 = 'pittsburgh_ctrl_ucsc.rmsk.salmon',
#                        sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
# 
# ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid <- 
#     build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
#                        se_1 = 'bioIvt_panc_ucsc.rmsk.salmon', 
#                        analysis_set_2 = ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl,
#                        sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
# ##
# process.aware.salmon_quant$analysis_set$panc_ctrl <- 
#     build.analysis.set(se_list = process.aware.salmon_quant, 
#                        se_1 = 'bioIvt_panc_process.aware.salmon', 
#                        se_2 = 'pittsburgh_ctrl_process.aware.salmon',
#                        sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)
# 
# process.aware.salmon_quant$analysis_set$covid_ctrl <- 
#     build.analysis.set(se_list = process.aware.salmon_quant, 
#                        se_1 = 'bioIvt_covid_process.aware.salmon', 
#                        se_2 = 'pittsburgh_ctrl_process.aware.salmon',
#                        sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
# 
# process.aware.salmon_quant$analysis_set$ctrl_panc_covid <- 
#     build.analysis.set(se_list = process.aware.salmon_quant, 
#                        se_1 = 'bioIvt_panc_process.aware.salmon', 
#                        analysis_set_2 = process.aware.salmon_quant$analysis_set$covid_ctrl,
#                        sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
```

# primary_analysis

## run_de_seq
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              run.de.seq,
              run.de.seq.individual)


internal_rmsk_quant$panc_normal$deseq <- 
  run.de.seq.individual(input_se = internal_rmsk_quant$panc_normal,
                        type = 'gxi',
                        base_level = 'normal',
                        top_level = 'panc',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = 
                          as.formula('~age+gender+input_vol+diagnosis'))

internal_gencode_quant$panc_normal$deseq <- 
  run.de.seq.individual(input_se = internal_gencode_quant$panc_normal,
                        type = 'gxi',
                        base_level = 'normal',
                        top_level = 'panc',
                        ref_type = 'salmon',
                        dds_formula = 
                          as.formula('~age+gender+input_vol+diagnosis'))

# gut$panc_normal$deseq <- 
#   run.de.seq.individual(input_se = internal_gencode_quant$panc_normal,
#                         type = 'gxi',
#                         base_level = 'normal',
#                         top_level = 'panc',
#                         ref_type = 'salmon',
#                         dds_formula = 
#                           as.formula('~age+gender+input_vol+diagnosis'))
```
## elife_de
```{r}

elife_rmsk_quant$rmsk$deseq <- 
  run.de.seq.individual(input_se = elife_rmsk_quant$rmsk,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Colorectal Cancer',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_rmsk_quant$colorectal_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_rmsk_quant$colorectal_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Colorectal Cancer',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_rmsk_quant$esoph_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_rmsk_quant$esoph_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Esophagus Cancer',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_rmsk_quant$liver_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_rmsk_quant$liver_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Liver Cancer',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_rmsk_quant$lung_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_rmsk_quant$lung_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Lung Cancer',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_rmsk_quant$stomach_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_rmsk_quant$stomach_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Stomach Cancer',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

######

elife_gencode_quant$colorectal_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_gencode_quant$colorectal_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Colorectal Cancer',
                        ref_type = 'salmon',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_gencode_quant$esoph_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_gencode_quant$esoph_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Esophagus Cancer',
                        ref_type = 'salmon',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_gencode_quant$liver_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_gencode_quant$liver_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Liver Cancer',
                        ref_type = 'salmon',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_gencode_quant$lung_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_gencode_quant$lung_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Lung Cancer',
                        ref_type = 'salmon',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))

elife_gencode_quant$stomach_healthy$deseq <- 
  run.de.seq.individual(input_se = elife_gencode_quant$stomach_healthy,
                        type = 'gxi',
                        base_level = 'Healthy donor',
                        top_level = 'Stomach Cancer',
                        ref_type = 'salmon',
                        dds_formula = 
                          as.formula('~age+gender+diagnosis'))


```
## run_pca
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              run.pca, extract.meta.pca.correlates)

internal_gencode_quant$panc_normal$pca <- 
  run.pca(input_de = internal_gencode_quant$panc_normal$deseq)
# 
# internal_gencode_quant$panc_normal$pca$pca_out.df %>% 
#   extract.meta.pca.correlates() %>% 
#   filter(pval < 0.05, abs(cor) > 0.5) -> internal_gencode_quant$panc_normal$pca$pc_sig_corr

internal_rmsk_quant$panc_normal$pca <- 
  run.pca(input_de = internal_rmsk_quant$panc_normal$deseq)

# internal_rmsk_quant$panc_normal$pca$pca_out.df %>% 
#   extract.meta.pca.correlates() %>% 
#   filter(pval < 0.05, abs(cor) > 0.6) -> internal_rmsk_quant$panc_normal$pca$pc_sig_corr



# internal_rmsk_quant$panc_normal$quant_meta %>%
#   mutate(reference = 'Repeat-aware') %>% 
#   rbind(internal_gencode_quant$panc_normal$quant_meta %>% 
#           mutate(reference = 'Repeat-naive')) %>% 
#   ggplot(aes(input_vol, salmon_percent_mapped, shape = gender, color = reference)) +
#   scale_color_grey(end = 0.6) +
#   scale_shape_manual(values = disc_identity_shape_pal) +
#   geom_point(aes(fill = after_scale(alpha(color, 0.4)))) 
# 
# internal_rmsk_quant$panc_normal$pca$pc_sig_corr %>% 
#   mutate(reference = 'Repeat-aware') %>% 
#   rbind(internal_gencode_quant$panc_normal$pca$pc_sig_corr %>% 
#           mutate(reference = 'Repeat-naive')) %>% 
#   mutate(var = str_remove_all(var, 'salmon_')) %>% 
#   ggplot(aes(reorder(var, -cor), abs(cor), color = reference)) +
#   geom_col(aes(fill = after_scale(alpha(color, 0.4))), position = position_dodge()) +
#   scale_color_grey(end = 0.6) +
#   ggforce::facet_row(~pc, scales = 'free_x')
  

```

# general_figures

## Fig_1
### Fig_flowchart_1A
```{r 1A}
install.packages('pdftools')
# install.packages('magick')
flow_chart.plt <- magick::image_read_pdf(path = file.path(figure.dir, 'fig.1', 'plasma_schematic_v8.pdf'))
flowchart_wrap_fig1A.plt <- patchwork::wrap_elements(full = magick::image_ggplot(flow_chart.plt))

```
### Fig_1D
```{r 1D}

internal_rmsk_quant$panc_normal$quant_meta %>%
  mutate(reference = 'Repeat-aware') %>%
  rbind(
    internal_gencode_quant$panc_normal$quant_meta %>%
      mutate(reference = 'Repeat-naive')
  ) %>%
  mutate(reference = factor(reference, levels = c('Repeat-naive', 'Repeat-aware')),
         sample = factor(sample)) %>%
  ggplot(aes(reference, salmon_percent_mapped, shape = gender, color = diagnosis)) +
  geom_boxplot(fill = NA, outlier.color = NULL, aes(group = reference), show.legend = F) +
  geom_point(size = txt.mm_to_pts(0.8), aes(fill = after_scale(alpha(color, 0.4)))) +
  geom_line(
    aes(group = sample),
    alpha = 0.2,
    show.legend = F
  ) +
  ylab('% of reads mapped') + xlab('') + 
  scale_shape_manual(values = disc_identity_shape_pal) +
  scale_color_manual(values = disc_identity_color_pal) +
  ggforce::facet_row( ~ diagnosis, strip.position = 'bottom') +
  ggpubr::stat_compare_means(comparisons = list(c('Repeat-naive', 'Repeat-aware')), 
                           method = 'wilcox', size = txt.mm_to_pts(1.2), 
                           method.args = list(exact = TRUE, paired = T), label = 'p.signif') -> fig.1D.plt




internal_rmsk_quant$panc_normal$deseq$norm_counts.df %>%
  rownames_to_column('gene') %>%
  merge(reference_meta_data$ucsc_rmsk_insert_info.df,
        by = 'gene',
        all.x = T) %>%
  mutate(
    family = ifelse(
      gene %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
      'GENCODE_lncRNA',
      family
    ),
    family = ifelse(is.na(family), 'GENCODE_coding', family),
    clade = ifelse(grepl('GENCODE', family), family, clade),
    clade = ifelse(
      clade %in% c(
        'GENCODE_coding',
        'GENCODE_lncRNA',
        'LINE',
        'SINE',
        'LTR',
        'DNA',
        'Simple_repeat'
      ),
      clade,
      'other'
    ),
    type = ifelse(grepl('GENCODE', family), family, 'TE')
  ) %>%
  group_by(type) %>%
  summarize(across(where(is.numeric), ~ .x / sum(.x))) %>%
  pivot_longer(names_to = 'sample',
               values_to = 'frequency',
               cols = where(is.numeric)) %>%
  group_by(sample, type) %>%
  filter(frequency > 0) %>%
  summarize(total_non_zero = n()) %>%
  merge(original_normal_meta_data, by = 'sample') %>%
  ggplot(aes(
    diagnosis,
    total_non_zero,
    shape = gender,
    color = diagnosis,
    fill = after_scale(alpha(color, 0.4))
  )) +
  geom_boxplot(fill = NA,
               outlier.shape = NA,
               aes(group = diagnosis),
               show.legend = F) +
  geom_jitter(size = txt.mm_to_pts(0.8), width = 0.125, show.legend = T) +
  # scale_y_continuous(breaks = c(1000, 5000, 10000)) +
  scale_shape_manual(values = disc_identity_shape_pal) +
  scale_color_manual(values = disc_identity_color_pal) +
  ylab('detected genes') + xlab('') +
  theme(legend.position = 'none') +
  ggforce::facet_row(~ type, strip.position = 'bottom', scales = 'free_y') +
  ggpubr::stat_compare_means(comparisons = list(c('panc', 'normal')), 
                         method = 'wilcox', size = txt.mm_to_pts(1.2), 
                         method.args = list(exact = TRUE, paired = F), label = 'p.signif') -> fig.1E.plt
```
### Fig_1_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


fig_1_layout <- "
AB
AC
EE
DD
"

wrap_plots(flowchart_wrap_fig1A.plt,
           fig.1D.plt+ coord_cartesian(clip = 'off'),
           fig.1E.plt+ coord_cartesian(clip = 'off'),
           # fig.1B.plt + coord_cartesian(clip = 'off'),
           # fig.1C.plt + coord_cartesian(clip = 'off'),
           plot_spacer(),
           guide_area(),
           design = fig_1_layout, 
           guides = 'collect',
           heights = c(0.8,0.8,0.2,0.8)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 1.25),
        legend.justification = c(0.9, 0.5)) -> fig.1.patchwork


save.manuscript.panel(figure = 1,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_1',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.1.patchwork)


```

## Fig_S1
### Fig_S1B/C
```{r 1B/C}
internal_gencode_quant$panc_normal$pca$pca_out.df %>%
  ggplot(aes(PC1, PC2,
             color = diagnosis, shape = gender)) +
  geom_point(size = txt.mm_to_pts(0.8),
             aes(fill = after_scale(alpha(color, 0.4)))) +
  geom_rug(show.legend = F) +
  xlab(paste('PC1', round(
    cumsum(internal_gencode_quant$panc_normal$pca$pc_props)[1],
    digits = 3
  ) * 100, '%', sep = ' ')) +
  ylab(paste('PC2', round(
    cumsum(internal_gencode_quant$panc_normal$pca$pc_props)[2] -
      cumsum(internal_gencode_quant$panc_normal$pca$pc_props)[1],
    digits = 3
  ) * 100, '%', sep = ' ')) +
  geom_vline(
    xintercept = 0,
    linetype = 'dotted',
    alpha = 0.3,
    size = 0.25
  ) +
  geom_hline(
    yintercept = 0,
    linetype = 'dotted',
    alpha = 0.3,
    size = 0.25
  ) +
  # ggforce::geom_mark_ellipse(
  #   aes(group = stage, label = stage),
  #   label.fontsize = txt.mm_to_pts(3),
  #   expand = 0.01,
  #   show.legend = F
  # ) +
  ggtitle('Repeat-naive') +
  scale_color_manual(values = disc_identity_color_pal) +
  scale_shape_manual(values = disc_identity_shape_pal) -> fig.S1A.plt

internal_rmsk_quant$panc_normal$pca$pca_out.df %>%
  ggplot(aes(PC1, PC2,
             color = diagnosis, shape = gender)) +
  geom_point(size = txt.mm_to_pts(0.8),
             aes(fill = after_scale(alpha(color, 0.4)))) +
  geom_rug(show.legend = F) +
  xlab(paste('PC1', round(
    cumsum(internal_rmsk_quant$panc_normal$pca$pc_props)[1],
    digits = 3
  ) * 100, '%', sep = ' ')) +
  ylab(paste('PC2', round(
    cumsum(internal_rmsk_quant$panc_normal$pca$pc_props)[2] -
      cumsum(internal_rmsk_quant$panc_normal$pca$pc_props)[1],
    digits = 3
  ) * 100, '%', sep = ' ')) +
  geom_vline(
    xintercept = 0,
    linetype = 'dotted',
    alpha = 0.3,
    size = 0.25
  ) +
  geom_hline(
    yintercept = 0,
    linetype = 'dotted',
    alpha = 0.3,
    size = 0.25
  ) +
  # ggforce::geom_mark_ellipse(
  #   aes(group = stage, filter = stage != 'none', label = stage), 
  #   label.fontsize = txt.mm_to_pts(3),
  #   expand = 0.01,
  #   show.legend = F
  # ) +
  ggtitle('Repeat-aware') +
  scale_color_manual(values = disc_identity_color_pal) +
  scale_shape_manual(values = disc_identity_shape_pal) -> fig.S1B.plt
    
    


```
### Fig_S1chm
```{r}
cor_in <-
    internal_rmsk_quant$panc_normal$deseq$norm_counts.df[!rownames(internal_rmsk_quant$panc_normal$deseq$norm_counts.df) %in% reference_meta_data$ucsc_rmsk_insert_info.df$gene, grepl('panc',
                                                                                                                                                                             colnames(internal_rmsk_quant$panc_normal$deseq$norm_counts.df))]


cor(cor_in) -> naive_hm_cor_data

cor_in <-
    internal_rmsk_quant$panc_normal$deseq$norm_counts.df[rownames(internal_rmsk_quant$panc_normal$deseq$norm_counts.df) %in% reference_meta_data$ucsc_rmsk_insert_info.df$gene, grepl('panc',
                                                                                                                                                                             colnames(internal_rmsk_quant$panc_normal$deseq$norm_counts.df))]


cor(cor_in) -> aware_hm_cor_data

hm_meta_data <-
  internal_rmsk_quant$panc_normal$deseq$scaled_quant_meta_for_de.df %>% 
  filter(condition == 'panc')

top_hma <-
  ComplexHeatmap::columnAnnotation(
    df = hm_meta_data %>% select(condition),
    col = list(condition = disc_identity_color_pal[2]),
    show_annotation_name = F,
    show_legend = T,
    simple_anno_size = unit(.3, "cm"),
    annotation_legend_param =
      list(title_gp = grid::gpar(
        fontsize = 6, fontface = 'bold'
      ))
  )

left_hma <-
  ComplexHeatmap::rowAnnotation(
    df = hm_meta_data %>% select(condition),
    col = list(condition = disc_identity_color_pal[2]),
    show_annotation_name = F,
    show_legend = F,
    simple_anno_size = unit(.3, "cm"),
    annotation_legend_param =
      list(title_gp = grid::gpar(
        fontsize = 6, fontface = 'bold'
      ))
  )

set.seed(2023 - 03 - 07)
ComplexHeatmap::Heatmap(
  naive_hm_cor_data,
  show_row_names = F,
  show_column_names = F,
  left_annotation = left_hma,
  row_dend_width = unit(.25, "cm"),
  column_dend_height = unit(.25, "cm"),
  heatmap_legend_param =
    list(
      legend_gp = grid::gpar(fontsize = 1),
      legend_direction = "horizontal",
      legend_height = unit(.35, "cm"),
      title_position = "lefttop",
      title_gp = grid::gpar(fontsize = 6, fontface = 'bold')
    ),
  top_annotation = top_hma,
  column_names_gp = grid::gpar(fontsize = 6),
  name = 'Repeat-naive'
) -> naive_panc_hm

set.seed(2023 - 03 - 07)
ComplexHeatmap::Heatmap(
  aware_hm_cor_data,
  show_row_names = F,
  show_column_names = F,
  left_annotation = left_hma,
  row_dend_width = unit(.25, "cm"),
  column_dend_height = unit(.25, "cm"),
  heatmap_legend_param =
    list(
      legend_gp = grid::gpar(fontsize = 1),
      legend_direction = "horizontal",
      legend_height = unit(.35, "cm"),
      title_position = "lefttop",
      title_gp = grid::gpar(fontsize = 6, fontface = 'bold')
    ),
  top_annotation = top_hma,
  column_names_gp = grid::gpar(fontsize = 6),
  name = 'Repeat-aware'
)  -> aware_panc_hm

patchwork::wrap_elements(full = grid::grid.grabExpr(ComplexHeatmap::draw(aware_panc_hm, 
                                                                         heatmap_legend_side = "bottom"),
                                                    merge_legend = T)) -> fig.S1D.chm

patchwork::wrap_elements(full = grid::grid.grabExpr(ComplexHeatmap::draw(naive_panc_hm, 
                                                                         heatmap_legend_side = "bottom"),
                                                    merge_legend = T)) -> fig.S1C.chm

```
### Fig_S1_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


internal_rmsk_quant$panc_normal$quant_meta %>%
  ggplot(aes(diagnosis,
             age,
             color = diagnosis)) +
  geom_boxplot(
    fill = NA,
    outlier.shape = NA,
    aes(group = diagnosis),
    show.legend = F
  ) +
  geom_jitter(width = 0.125,
              size = txt.mm_to_pts(0.8),
              aes(fill = after_scale(alpha(color, 0.4)))) +
  scale_color_manual(values = disc_identity_color_pal) +
  scale_shape_manual(values = disc_identity_shape_pal) +
  ggpubr::stat_compare_means(
    comparisons = list(c('normal', 'panc')),
    method = 'wilcox',
    size = 2.5,
    method.args = list(exact = TRUE, paired = F),
    label = 'p.signif',
    show.legend = F
  ) -> fig.S1D

internal_rmsk_quant$panc_normal$quant_meta %>%
  filter(diagnosis != 'esoph') %>% 
  group_by(diagnosis, gender) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(diagnosis, y = count, fill = gender)) +
  geom_col(position = position_dodge(1)) +
  scale_y_continuous(breaks= scales::pretty_breaks()) -> fig.S1E



fig_S1_layout <- "
AB
CD
EF
HH
GG
"

wrap_plots(fig.S1D + coord_cartesian(clip = 'off'),
           wrap_elements(full = fig.S1E),
           fig.S1C.chm,
           fig.S1D.chm,
           fig.S1A.plt,
           fig.S1B.plt,
           fig.S1C.plt,
           guide_area(),
           design = fig_S1_layout, 
           guides = 'collect',
           heights = c(0.8,1,0.8,0.2,0.8)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 1.25),
        legend.justification = c(0.5, 0.5)) -> fig.S1.patchwork


save.manuscript.panel(figure = 1,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S1',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S1.patchwork)


```

## Fig_2
### Fig_2A
```{r}
internal_rmsk_quant$panc_normal$deseq$norm_counts.df %>%
  rownames_to_column('gene') %>%
  merge(reference_meta_data$ucsc_rmsk_insert_info.df,
        by = 'gene',
        all.x = T) %>%
  mutate(
    family = ifelse(
      gene %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
      'GENCODE_lncRNA',
      family
    ),
    family = ifelse(is.na(family), 'GENCODE_coding', family),
    clade = ifelse(grepl('GENCODE', family), family, clade),
    clade = ifelse(
      clade %in% c(
        'GENCODE_coding',
        'GENCODE_lncRNA',
        'LINE',
        'SINE',
        'LTR',
        'DNA',
        'Simple_repeat'
      ),
      clade,
      'other'
    ),
    type = ifelse(grepl('GENCODE', family), 'GENCODE', 'TE'),
    clade = factor(clade, levels = te_aware_annotation_levels)
  ) %>%
  filter(!gene %in% chrM.filter.list) -> total_annotated_rmsk_counts

total_annotated_rmsk_counts %>%
  gather(sample, count, -gene, -clade, -family, -type) %>%
  filter(count > 0) %>%
  merge(internal_rmsk_quant$panc_normal$quant_meta,
        by = 'sample') -> tidy_total_annotated_rmsk_counts

tidy_total_annotated_rmsk_counts %>%
  group_by(sample, diagnosis, clade) %>%
  summarize(clade_sum = sum(count)) %>%
  mutate(clade_frac = clade_sum / sum(clade_sum)) %>%
  merge(internal_rmsk_quant$panc_normal$quant_meta %>% select(-diagnosis),
        by = 'sample') %>%
  distinct() %>%
  ggplot(aes(sample, clade_frac, fill = clade, color = diagnosis)) +
  geom_col(color = 'white', show.legend = T) +
  scale_fill_manual(values = te_color_pal, name = 'biotype/clade') +
  ggforce::facet_row(~ diagnosis + stage, scales = 'free_x', space = 'free') +
  scale_y_continuous(expand = c(0, 0)) +
  xlab('N = {normal: 22, panc: 10}') + ylab('normalized count fraction') +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) -> fig.2A.plt
```
### Fig_2B
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              calc_entropy)

calc_entropy(
  internal_rmsk_quant$panc_normal$deseq$norm_counts.df,
  original_discovery_meta_data,
  grouping_level = 'clade'
) %>%
  filter(
    clade %in% c(
      'GENCODE_coding',
      'GENCODE_lncRNA',
      'SINE',
      'LTR',
      'Simple_repeat'
    )
  ) %>%
  ggplot(aes(
    diagnosis,
    entropy,
    # shape = gender,
    color = diagnosis,
    fill = after_scale(alpha(color, 0.4))
  )) +
  geom_boxplot(
    fill = NA,
    outlier.shape = NA,
    aes(group = diagnosis),
    show.legend = F
  ) +
  geom_jitter(width = 0.125, show.legend = F, shape = 21) +
  ggforce::facet_row( ~ clade, space = 'free', strip.position = 'top') +
  ylim(0, 12) + ylab('Shannon Entropy') + xlab('') +
  # scale_shape_manual(values = disc_identity_shape_pal) +
  scale_color_manual(values = disc_identity_color_pal) +
  ggpubr::stat_compare_means(
    comparisons = list(c('normal', 'panc')),
    method = 'wilcox',
    size = 2.5,
    method.args = list(exact = TRUE, paired = F),
    label = 'p.signif'
  ) +
  theme(axis.text.x = element_text(angle = 40, hjust = 1),
        strip.text = element_text(size = txt.mm_to_pts(1.5))) -> fig.2B.plt
```
### Fig_2C
```{r}
internal_rmsk_quant$panc_normal$deseq$de_out %>%
  merge(reference_meta_data$ucsc_rmsk_insert_info.df,
        by = 'gene',
        all.x = T) %>%
  mutate(
    family = ifelse(
      ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
      'GENCODE_lncRNA',
      family
    ),
    family = ifelse(is.na(family), 'GENCODE_coding', family),
    clade = ifelse(grepl('GENCODE', family), family, clade),
    clade = ifelse(
      clade %in% c(
        'GENCODE_coding',
        'GENCODE_lncRNA',
        'LINE',
        'SINE',
        'LTR',
        'DNA',
        'Simple_repeat'
      ),
      clade,
      'other'
    ),
    type = ifelse(grepl('GENCODE', family), 'GENCODE', 'TE'),
    clade = factor(clade, levels = te_aware_annotation_levels)
  ) %>%
  filter(!ensg %in% chrM.filter.list,
         !grepl('^MT', gene)) -> panc_annotated_rmsk_de


panc_label_list <- panc_annotated_rmsk_de %>%
  filter(grepl('LTR|^L1|Alu|^SSU', gene), padj < 0.01) %>%
  top_n(7, wt = log2FoldChange)


panc_label_gencode_list_dn <- panc_annotated_rmsk_de %>%
  filter(clade == 'GENCODE_coding', padj < 0.01) %>%
  top_n(5, wt = -log2FoldChange)

panc_label_gencode_list_up <- panc_annotated_rmsk_de %>%
  filter(clade == 'GENCODE_coding', padj < 0.01) %>%
  top_n(8, wt = log2FoldChange)

panc_label_list <-
  rbind(panc_label_list, panc_label_gencode_list_dn, panc_label_gencode_list_up)

panc_annotated_rmsk_de %>%
  filter(clade == 'GENCODE_coding') %>%
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) +
  geom_point(size = 2,
             alpha = 0.6,
             show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt +
  geom_point(
    data = filter(panc_annotated_rmsk_de, clade != 'GENCODE_coding') %>%
      mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
    aes(log2FoldChange, -log10(padj), color = clade),
    size = 2,
    alpha = 0.8,
    show.legend = F
  ) +
  geom_hline(
    yintercept = -log10(0.01),
    linetype = 'dashed',
    alpha = 0.4
  ) +
  geom_vline(xintercept = 0,
             linetype = 'dashed',
             alpha = 0.4) +
  scale_color_manual(values = te_color_pal, name = 'biotype/clade') +
  ggrepel::geom_text_repel(
    data = panc_annotated_rmsk_de %>%
      mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
    aes(label = ifelse(gene %in% panc_label_list$gene, gene, '')),
    show.legend = F,
    color = 'black',
    size = txt.mm_to_pts(1),
    max.overlaps = 10000,
    box.padding = 0.3,
    segment.colour = 'grey'
  ) +
  xlim(-5, 5) -> fig.2C.plt

panc_annotated_rmsk_de %>%
  mutate(sig = factor(ifelse(padj < 0.01, T, F), levels = c(T, F))) %>%
  filter(sig == F) %>%
  ggplot(aes(log(baseMean), log2FoldChange)) +
  geom_point(color = 'grey', alpha = 0.2) -> unsig_ma_plt

unsig_ma_plt +
  geom_point(
    data = panc_annotated_rmsk_de %>%
      mutate(sig = factor(ifelse(padj < 0.01, T, F), levels = c(T, F))) %>%
      filter(sig == T),
    aes(color = clade, fill = after_scale(alpha(color, 0.4))),
    show.legend = F
  ) +
  ggrepel::geom_text_repel(
    data = panc_annotated_rmsk_de %>%
      mutate(sig = factor(ifelse(padj < 0.01, T, F), levels = c(T, F))) %>%
      filter(sig == T),
    aes(label = ifelse(sig == T & abs(log2FoldChange) > 2, gene, '')) ,
    size = txt.mm_to_pts(1),
    box.padding = 0.3,
    show.legend = F,
    max.overlaps = 25
  ) +
  geom_hline(yintercept = 0, linetype = 'dashed') +
  ylim(-5, 5) +
  scale_color_manual(values = te_color_pal, name = 'biotype/clade') +
  theme(legend.position = c(0.99, 0.25)) -> fig.S1C.plt

```
### Fig_2D
```{r}
# unique(c(filter(ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out,
#                 abs(log2FoldChange) > 3.5)$ensg,
#   filter(ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out,
#          abs(log2FoldChange) > 1.5)$ensg)) -> de_ensg_names


internal_rmsk_quant$panc_normal$deseq$norm_counts.df %>%
  # sample_n(100) %>% 
  rownames_to_column('ensg') %>%
  filter(ensg %in% filter(reference_meta_data$ucsc_rmsk_insert_info.df,
                          clade %in% c('SINE', 'Simple_repeat'))$gene) %>%
  filter(across(where(is.numeric), ~ any(.x != 0))) %>%
  rowwise() %>%
  mutate(sum = sum(c_across(where(is.numeric)))) %>%
  filter(sum > 34*5) %>% select(-sum) %>%
  ungroup() %>%
  column_to_rownames('ensg') %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column('ensg') %>% 
  mutate_if(is.numeric, ~ scale(log2(. + 1), center = T)) %>% 
  column_to_rownames('ensg') %>% as.matrix() %>% t() -> hm_count_data

hm_meta_data <-
  internal_rmsk_quant$panc_normal$deseq$scaled_quant_meta_for_de.df

top_hma <-
  ComplexHeatmap::columnAnnotation(
    df = hm_meta_data %>% select(condition),
    col = list(condition = disc_identity_color_pal),
    show_annotation_name = F,
    show_legend = F,
    simple_anno_size = unit(.3, "cm"),
    annotation_legend_param =
      list(title_gp = grid::gpar(
        fontsize = 6, fontface = 'bold'
      ))
  )

  

reference_meta_data$ucsc_rmsk_insert_info.df %>%
  filter(gene %in% rownames(hm_count_data)) %>%
  select(gene, clade) %>%
  mutate(clade = ifelse(clade %in% names(te_color_pal), clade, 'other')) %>%
  distinct() %>% 
  group_by(gene) %>% 
  mutate(count = n()) %>% 
  filter(n() > 1) %>% 
  filter(if (count==2) clade != 'other' else .) -> dupe_filt
  
reference_meta_data$ucsc_rmsk_insert_info.df %>%
  filter(gene %in% rownames(hm_count_data)) %>%
  select(gene, clade) %>%
  mutate(clade = ifelse(clade %in% names(te_color_pal), clade, 'other')) %>%
  distinct() %>% 
  filter(!gene %in% dupe_filt$gene) %>% 
  rbind(dupe_filt %>% select(gene, clade)) %>% 
  column_to_rownames('gene') -> hm_te_data

hm_te_data <- hm_te_data[match(rownames(hm_count_data), rownames(hm_te_data)), , drop = F]

left_hma <- ComplexHeatmap::rowAnnotation(
  df = hm_te_data,
  col = list(clade = te_alone_color_pal),
  show_annotation_name = T,
  annotation_name_side = 'top',
  annotation_name_gp = grid::gpar(fontsize = 8, fontface = 'italic'),
  show_legend = F,
  simple_anno_size = unit(.275, "cm")
)

set.seed(2023-03-07)
ComplexHeatmap::Heatmap(hm_count_data, 
                        show_row_names = F, 
                        show_column_names = F, 
                        left_annotation = left_hma, 
                        row_dend_width = unit(.45, "cm"),
                        column_dend_height = unit(.45, "cm"),
                        heatmap_legend_param = 
                          list(legend_gp = grid::gpar(fontsize = 1),
                               legend_direction = "horizontal", 
                               legend_height = unit(.35, "cm"),
                               title_position = "lefttop",
                               title_gp = grid::gpar(fontsize = 6, fontface = 'bold')),
                        top_annotation = top_hma,
                        column_names_gp = grid::gpar(fontsize = 6),
                        name = 'Z-score') -> fig.2D.chm

patchwork::wrap_elements(full = grid::grid.grabExpr(ComplexHeatmap::draw(fig.2D.chm, heatmap_legend_side = "bottom"),
                                                    merge_legend = T)) -> fig.2D.chm
  
```
### Fig_2_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)


fig_2_layout <- "
AA
EE
BD
CD
"

wrap_plots(fig.2A.plt,
           fig.2B.plt,
           fig.2C.plt,
           fig.2D.chm,
           # fig.2C.plt + labs(title = 'covid'),
           guide_area(),
           # plot_spacer(),
           # plot_spacer(),
           # patchwork::wrap_elements(full = grid::grid.grabExpr(ComplexHeatmap::draw(fig.2D.chm), 
           #                                                      width = figure_double_column_width)),
           design = fig_2_layout, 
           guides = 'collect',
           heights = c(1.25,0.225,1,1, .75)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 1),
        legend.justification = c(0.5, 0.5)) -> fig.2.patchwork

save.manuscript.panel(figure = 2,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_2',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.2.patchwork)


```

## Fig_S2
### Fig_S2A
```{r}
elife_rmsk_quant$rmsk$deseq$norm_counts.df %>%
  rownames_to_column('gene') %>%
  merge(reference_meta_data$ucsc_rmsk_insert_info.df,
        by = 'gene',
        all.x = T) %>%
  mutate(
    family = ifelse(
      gene %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
      'GENCODE_lncRNA',
      family
    ),
    family = ifelse(is.na(family), 'GENCODE_coding', family),
    clade = ifelse(grepl('GENCODE', family), family, clade),
    clade = ifelse(
      clade %in% c(
        'GENCODE_coding',
        'GENCODE_lncRNA',
        'LINE',
        'SINE',
        'LTR',
        'DNA',
        'Simple_repeat'
      ),
      clade,
      'other'
    ),
    type = ifelse(grepl('GENCODE', family), 'GENCODE', 'TE'),
    clade = factor(clade, levels = te_aware_annotation_levels)
  ) %>%
  filter(!gene %in% chrM.filter.list) -> total_annotated_rmsk_counts

total_annotated_rmsk_counts %>%
  gather(sample, count, -gene, -clade, -family, -type) %>%
  filter(count > 0) %>%
  merge(elife_rmsk_quant$rmsk$quant_met,
        by = 'sample') -> tidy_total_annotated_rmsk_counts

tidy_total_annotated_rmsk_counts %>%
  group_by(sample, diagnosis, clade) %>% 
  summarize(clade_sum = sum(count)) %>%
  mutate(clade_frac = clade_sum / sum(clade_sum)) %>%
  merge(elife_rmsk_quant$rmsk$quant_meta %>% select(-diagnosis),
        by = 'sample') %>%
  distinct() %>%
  ggplot(aes(sample, clade_frac, fill = clade, color = diagnosis)) +
  geom_col(color = 'white', show.legend = T) +
  scale_fill_manual(values = te_color_pal, name = 'biotype/clade') +
  ggforce::facet_col(~ diagnosis, scales = 'free_x', space = 'free') +
  scale_y_continuous(expand = c(0, 0)) +
  ylab('normalized count fraction') +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size = base_size-1),
        axis.ticks.x = element_blank()) -> fig.S2A.plt
```
### Fig_S2B
```{r}
elife_rmsk_quant$rmsk$quant_meta %>% 
  mutate(reference = 'Repeat-aware') %>%
  rbind(
    elife_gencode_quant$txonly$quant_meta %>%
      mutate(reference = 'Repeat-naive')
  ) %>%
  mutate(reference = factor(reference, levels = c('Repeat-naive', 'Repeat-aware')),
         sample = factor(sample)) %>%
  ggplot(aes(reference, salmon_percent_mapped, shape = gender)) +
  geom_boxplot(fill = NA, outlier.shape = NULL, aes(group = reference), show.legend = F) +
  geom_point(size = txt.mm_to_pts(0.8), aes(fill = after_scale(alpha(color, 0.4)))) +
  geom_line(
    aes(group = sample),
    alpha = 0.2,
    show.legend = F
  ) +
  ylab('% of reads mapped') + xlab('') + 
  scale_shape_manual(values = setNames(disc_identity_shape_pal, c('male', 'female'))) +
  # scale_color_manual(values = elife_identity_color_pal) +
  ggforce::facet_row( ~ diagnosis, strip.position = 'bottom') +
  ggpubr::stat_compare_means(comparisons = list(c('Repeat-naive', 'Repeat-aware')), 
                           method = 'wilcox', size = txt.mm_to_pts(1.2), 
                           method.args = list(exact = TRUE, paired = T), label = 'p.signif') -> fig.S2B.plt
```
### Fig_S2_patchwork
```{r}
import::from(.from = 'patchwork',
             plot_annotation,
             wrap_plots,
             guide_area,
             plot_spacer,
             wrap_elements)

fig_S2_layout <- "
AA
BB
CC
"

wrap_plots(
  fig.S2A.plt,
  guide_area(),
  fig.S2B.plt + coord_cartesian(clip = 'off') + theme(axis.text.x = element_text(angle = 40, hjust = 1)),
  heights = c(1.5, 0.2, 0.7),
  guides = 'collect',
  design = fig_S2_layout
) +
  plot_annotation(tag_levels = 'A') &
  theme(
    plot.tag.position = c(0.01, 0.99),
    legend.position = 'bottom',
    legend.title = element_text(vjust = 0.5),
    legend.justification = c(0.5, 0.5)
  ) -> fig.S2.patchwork

save.manuscript.panel(
  figure = 2,
  figure.dir = figure.dir,
  name = 'patchwork_full_fig_S2',
  width = figure_double_column_width,
  height = figure_depth,
  plot.in = fig.S2.patchwork
)
```

## Fig_3
### Fig_3A
```{r}

imap(elife_rmsk_quant[names(elife_rmsk_quant) != 'rmsk'], function(analysis_set, name) {
  analysis_set$deseq$de_out %>%
    filter(
      padj < 0.01,
      log2FoldChange <= -0.75,
      gene %in% reference_meta_data$ucsc_rmsk_insert_info.df$gene
    ) %>%
    mutate(set = name)
  
}) %>% bind_rows() %>%
  merge(
    reference_meta_data$ucsc_rmsk_insert_info.df %>% select(gene, clade) %>% distinct(),
    by = 'gene'
  ) %>%
  mutate(clade = ifelse(clade %in% names(te_color_pal), clade, 'other'),
       set = str_remove_all(set, '_healthy')) %>% 
  group_by(gene, clade) %>%
  summarize(set = list(set)) %>%
  ggplot(aes(set, fill = clade)) +
  geom_bar(show.legend = F, color = 'white', position = 'dodge') +
  geom_text(
    stat = 'count',
    aes(label = after_stat(count), color = clade),
    vjust = -.5,
    size = txt.mm_to_pts(1),
    position = position_dodge(width = 0.9),
    show.legend = F
  ) +
  scale_fill_manual(values = te_color_pal) +
  scale_color_manual(values = te_color_pal) +
  xlab('') + ylab('') +
  ggupset::scale_x_upset() -> fig.3E.plt


imap(elife_rmsk_quant[names(elife_rmsk_quant) != 'rmsk'], function(analysis_set, name) {
  analysis_set$deseq$de_out %>%
    filter(
      padj < 0.01,
      log2FoldChange >= 0.75,
      gene %in% reference_meta_data$ucsc_rmsk_insert_info.df$gene
    ) %>%
    mutate(set = name)
  
}) %>% bind_rows() %>%
  merge(
    reference_meta_data$ucsc_rmsk_insert_info.df %>% select(gene, clade) %>% distinct(),
    by = 'gene'
  ) %>%
  mutate(clade = ifelse(clade %in% names(te_color_pal), clade, 'other'),
         set = str_remove_all(set, '_healthy')) %>% 
  group_by(gene, clade) %>%
  summarize(set = list(set)) %>% 
  ggplot(aes(set, fill = clade)) +
  geom_bar(show.legend = F, color = 'white', position = 'dodge') +
  geom_text(
    stat = 'count',
    aes(label = after_stat(count), color = clade),
    vjust = -.5,
    size = txt.mm_to_pts(1),
    position = position_dodge(width = 0.9),
    show.legend = F
  ) +
  scale_fill_manual(values = te_color_pal) +
  scale_color_manual(values = te_color_pal) +
  xlab('') + ylab('') +
  ggupset::scale_x_upset() -> fig.3F.plt


calc_entropy(elife_rmsk_quant$rmsk$deseq$norm_counts.df,
             elife_meta_data,
             grouping_level = 'clade') %>%
  filter(clade %in% te_aware_annotation_levels) %>%
  ggplot(aes(diagnosis,
             entropy,
             # shape = gender,
             color = diagnosis,
             fill = after_scale(alpha(color, 0.4)))) +
  geom_boxplot(
    fill = NA,
    outlier.shape = NA,
    aes(group = diagnosis),
    show.legend = F
  ) + 
  ggforce::facet_row( ~ clade, space = 'free', strip.position = 'top')

filt_elife_de_list <- bind_rows(elife_de_list[names(elife_de_list) != 'rmsk'])

internal_rmsk_quant$panc_normal$deseq$norm_counts.df %>% head()
  sample_n(100) %>%
  rownames_to_column('ensg') %>%
  filter(ensg %in% reference_meta_data$ucsc_rmsk_insert_info.df$gene) %>%
  # filter(across(where(is.numeric), ~ any(.x != 0))) %>%
  # rowwise() %>%
  # mutate(sum = sum(c_across(where(is.numeric)))) %>%
  # filter(sum > 224 * 10) %>% select(-sum) %>%
  # ungroup() %>%
  column_to_rownames('ensg') %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column('ensg') %>%
  mutate_if(is.numeric, ~ scale(log2(. + 1), center = T)) %>%
  column_to_rownames('ensg') %>% as.matrix() %>% t() -> hm_count_data

  



reference_meta_data$ucsc_rmsk_insert_info.df %>%
  filter(gene %in% rownames(hm_count_data)) %>%
  select(gene, clade) %>%
  mutate(clade = ifelse(clade %in% names(te_color_pal), clade, 'other')) %>%
  distinct() %>% 
  group_by(gene) %>% 
  mutate(count = n()) %>% 
  filter(n() > 1) %>% 
  filter(if (count==2) clade != 'other' else .) -> dupe_filt
  
reference_meta_data$ucsc_rmsk_insert_info.df %>%
  filter(gene %in% rownames(hm_count_data)) %>%
  select(gene, clade) %>%
  mutate(clade = ifelse(clade %in% names(te_color_pal), clade, 'other')) %>%
  distinct() %>% 
  filter(!gene %in% dupe_filt$gene) %>% 
  rbind(dupe_filt %>% select(gene, clade)) %>% 
  column_to_rownames('gene') -> hm_te_data

hm_te_data <-
  hm_te_data[match(rownames(hm_count_data), rownames(hm_te_data)), , drop = F]

left_hma <- ComplexHeatmap::rowAnnotation(
  df = hm_te_data,
  col = list(clade = te_color_pal),
  show_annotation_name = T,
  annotation_name_side = 'top',
  annotation_name_gp = grid::gpar(fontsize = 8, fontface = 'italic'),
  show_legend = F,
  simple_anno_size = unit(.275, "cm")
)

set.seed(2023 - 03 - 07)
ComplexHeatmap::Heatmap(
  hm_count_data,
  show_row_names = F,
  show_column_names = F,
  left_annotation = left_hma,
  row_dend_width = unit(.25, "cm"),
  column_dend_height = unit(.25, "cm"),
  heatmap_legend_param =
    list(
      legend_gp = grid::gpar(fontsize = 1),
      legend_direction = "horizontal",
      legend_height = unit(.35, "cm"),
      title_position = "lefttop",
      title_gp = grid::gpar(fontsize = 6, fontface = 'bold')
    ),
  top_annotation = top_hma,
  column_names_gp = grid::gpar(fontsize = 6),
  name = 'Z-score'
) #-> fig.2D.chm

patchwork::wrap_elements(full = grid::grid.grabExpr(
  ComplexHeatmap::draw(fig.2D.chm, heatmap_legend_side = "bottom"),
  merge_legend = T
)) #-> fig.2D.chm
```
### Fig_3B
```{r}
elife_rmsk_quant$rmsk$pca <- 
  run.pca(input_de = elife_rmsk_quant$rmsk$deseq, te_only = FALSE)

elife_rmsk_quant$rmsk$pca$pca_out.df %>%
  ggplot(aes(PC3, PC4,
             color = diagnosis)) +
  geom_point(size = txt.mm_to_pts(0.8),
             aes(fill = after_scale(alpha(color, 0.4))),
             show.legend = F) +
  geom_rug(show.legend = F) +
  xlab(paste('PC1', round(
    cumsum(elife_rmsk_quant$rmsk$pca$pc_props)[1],
    digits = 3
  ) * 100, '%', sep = ' ')) +
  ylab(paste('PC2', round(
    cumsum(elife_rmsk_quant$rmsk$pca$pc_props)[2] -
      cumsum(elife_rmsk_quant$rmsk$pca$pc_props)[1],
    digits = 3
  ) * 100, '%', sep = ' ')) +
  geom_vline(
    xintercept = 0,
    linetype = 'dotted',
    alpha = 0.3,
    size = 0.25
  ) +
  geom_hline(
    yintercept = 0,
    linetype = 'dotted',
    alpha = 0.3,
    size = 0.25
  ) +
  scale_color_manual(values = elife_identity_color_pal)
```
### Fig_3C
```{r}
de_out_list <- list(elife_rmsk_quant$liver_healthy$deseq$de_out,
                 elife_rmsk_quant$lung_healthy$deseq$de_out,
                 elife_rmsk_quant$esoph_healthy$deseq$de_out,
                 elife_rmsk_quant$colorectal_healthy$deseq$de_out,
                 elife_rmsk_quant$stomach_healthy$deseq$de_out)

lapply(c(de_out_list), function(de_out) {
  
  de_out %>% 
    merge(reference_meta_data$ucsc_rmsk_insert_info.df,
          by = 'gene',
          all.x = T) %>%
    mutate(
      family = ifelse(
        ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
        'GENCODE_lncRNA',
        family
      ),
      family = ifelse(is.na(family), 'GENCODE_coding', family),
      clade = ifelse(grepl('GENCODE', family), family, clade),
      clade = ifelse(
        clade %in% c(
          'GENCODE_coding',
          'GENCODE_lncRNA',
          'LINE',
          'SINE',
          'LTR',
          'DNA',
          'Simple_repeat'
        ),
        clade,
        'other'
      ),
      type = ifelse(grepl('GENCODE', family), 'GENCODE', 'TE'),
      clade = factor(clade, levels = te_aware_annotation_levels)
    ) %>%
    filter(!ensg %in% chrM.filter.list,
           !grepl('^MT', gene)) -> panc_annotated_rmsk_de

  panc_annotated_rmsk_de %>%
    filter(clade == 'GENCODE_coding') %>%
    ggplot(aes(log2FoldChange, -log10(padj), color = clade)) +
    geom_point(size = 2,
               alpha = 0.6,
               show.legend = FALSE) -> gencode_layer.plt

  gencode_layer.plt +
    geom_point(
      data = filter(panc_annotated_rmsk_de, clade != 'GENCODE_coding') %>%
        mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
      aes(log2FoldChange, -log10(padj), color = clade, fill = after_scale(alpha(color,  0.4))),
      size = 2,
      alpha = 0.8
    ) +
    geom_hline(
      yintercept = -log10(0.01),
      linetype = 'dashed',
      alpha = 0.4
    ) +
    geom_vline(xintercept = 0,
               linetype = 'dashed',
               alpha = 0.4) +
    scale_color_manual(values = te_color_pal, name = 'biotype/clade') -> plt
  
  return(plt)
  
}) -> plt_list
```
### Fig_3_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)

fig_3_layout <- "
AB
CD
EF
GH
"

wrap_plots(plt_list[[1]] + ggtitle('liver cancer'),
           plt_list[[2]] + ggtitle('lung cancer'),
           plt_list[[3]] + ggtitle('esophagus cancer'),
           plt_list[[4]] + ggtitle('colorectal cancer'),
           plt_list[[5]] + ggtitle('stomach cancer'),
           guide_area(),
           wrap_elements(full = fig.3F.plt + ylim(0,95) + ggtitle('upregulated TEs')),
           wrap_elements(full = fig.3E.plt + ylim(0,95) + ggtitle('downregulated TEs')),
           heights = c(0.75,0.75,0.75,1.75),
           # widths = c(0.75, 1.25),
           guides = 'collect',
           design = fig_3_layout) +
  plot_annotation(tag_levels = 'A') &
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 0.5),
        legend.justification = c(0.5, 0.5)) -> fig.3.patchwork

save.manuscript.panel(figure = 3,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_3',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.3.patchwork)
```

## Fig_S3
### Fig_S3A
```{r}

internal_rmsk_quant$panc_normal$deseq$norm_counts.df %>%
  rownames_to_column('gene') %>%
  merge(reference_meta_data$ucsc_rmsk_insert_info.df,
        by = 'gene',
        all.x = T) %>%
  mutate(
    family = ifelse(
      gene %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
      'GENCODE_lncRNA',
      family
    ),
    family = ifelse(is.na(family), 'GENCODE_coding', family),
    clade = ifelse(grepl('GENCODE', family), family, clade),
    clade = ifelse(
      clade %in% c(
        te_alone_annotation_levels
      ),
      clade,
      'other'
    ),
    type = ifelse(grepl('GENCODE', family), 'GENCODE', 'TE'),
    clade = factor(clade, levels = te_alone_annotation_levels)
  ) %>%
  filter(!gene %in% chrM.filter.list, !is.na(clade)) -> total_annotated_rmsk_counts

total_annotated_rmsk_counts %>%
  gather(sample, count, -gene, -clade, -family, -type) %>%
  filter(count > 0) %>%
  merge(internal_rmsk_quant$panc_normal$quant_meta,
        by = 'sample') -> tidy_total_annotated_rmsk_counts

tidy_total_annotated_rmsk_counts %>%
  group_by(sample, diagnosis, clade) %>%
  summarize(clade_sum = sum(count)) %>%
  mutate(clade_frac = clade_sum / sum(clade_sum)) %>%
  merge(internal_rmsk_quant$panc_normal$quant_meta %>% select(-diagnosis),
        by = 'sample') %>%
  distinct() %>%
  ggplot(aes(sample, clade_frac, fill = clade, color = diagnosis)) +
  geom_col(color = 'white', show.legend = T) +
  scale_fill_manual(values = te_alone_color_pal, name = 'biotype/clade') +
  ggforce::facet_row(~ diagnosis + stage, scales = 'free_x', space = 'free') +
  scale_y_continuous(expand = c(0, 0)) +
  xlab('N = {normal: 22, panc: 10}') + ylab('normalized count fraction') +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) -> fig.S3A.plt

```
### Fig_S3B
```{r}
elife_rmsk_quant$rmsk$deseq$norm_counts.df %>%
  rownames_to_column('gene') %>%
  merge(reference_meta_data$ucsc_rmsk_insert_info.df,
        by = 'gene',
        all.x = T) %>%
  mutate(
    family = ifelse(
      gene %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
      'GENCODE_lncRNA',
      family
    ),
    family = ifelse(is.na(family), 'GENCODE_coding', family),
    clade = ifelse(grepl('GENCODE', family), family, clade),
    clade = ifelse(
      clade %in% c(
        te_alone_annotation_levels
      ),
      clade,
      'other'
    ),
    type = ifelse(grepl('GENCODE', family), 'GENCODE', 'TE'),
    clade = factor(clade, levels = te_alone_annotation_levels)
  ) %>% 
  filter(!gene %in% chrM.filter.list, !is.na(clade)) -> total_annotated_rmsk_counts

total_annotated_rmsk_counts %>%
  gather(sample, count, -gene, -clade, -family, -type) %>%
  filter(count > 0) %>%
  merge(elife_rmsk_quant$rmsk$quant_meta,
        by = 'sample') -> tidy_total_annotated_rmsk_counts

tidy_total_annotated_rmsk_counts %>%
  group_by(sample, diagnosis, clade) %>% 
  summarize(clade_sum = sum(count)) %>%
  mutate(clade_frac = clade_sum / sum(clade_sum)) %>%
  merge(elife_rmsk_quant$rmsk$quant_meta %>% select(-diagnosis),
        by = 'sample') %>%
  distinct() %>%
  ggplot(aes(sample, clade_frac, fill = clade, color = diagnosis)) +
  geom_col(color = 'white', show.legend = T) +
  scale_fill_manual(values = te_alone_color_pal, name = 'biotype/clade') +
  ggforce::facet_col(~ diagnosis, scales = 'free_x', space = 'free') +
  scale_y_continuous(expand = c(0, 0)) +
  ylab('normalized count fraction') +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) -> fig.S3B.plt
```
### Fig_S3_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)

fig_S3_layout <- "
AA
CC
BB
BB
"

wrap_plots(fig.S3A.plt,
           fig.S3B.plt,
           guide_area(),
           heights = c(0.75,0.125,1.5),
           guides = 'collect',
           design = fig_S3_layout) +
  plot_annotation(tag_levels = 'A') &
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 0.5),
        legend.justification = c(0.5, 0.5)) -> fig.S3.patchwork

save.manuscript.panel(figure = 3,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S3',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S3.patchwork)
```

## Fig_S4
### Fig_S4A-E
```{r}
lapply(c(de_out_list), function(de_out) {
  
  de_out %>%
    merge(reference_meta_data$ucsc_rmsk_insert_info.df,
          by = 'gene',
          all.x = T) %>%
    mutate(
      family = ifelse(
        ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
        'GENCODE_lncRNA',
        family
      ),
      family = ifelse(is.na(family), 'GENCODE_coding', family),
      clade = ifelse(grepl('GENCODE', family), family, clade),
      clade = ifelse(
        clade %in% c(
          'GENCODE_coding',
          'GENCODE_lncRNA',
          'LINE',
          'SINE',
          'LTR',
          'DNA',
          'Simple_repeat'
        ),
        clade,
        'other'
      ),
      type = ifelse(grepl('GENCODE', family), 'GENCODE', 'TE'),
      clade = factor(clade, levels = te_aware_annotation_levels)
    ) %>%
    filter(!ensg %in% chrM.filter.list,
           !grepl('^MT', gene)) -> panc_annotated_rmsk_de
  
  panc_annotated_rmsk_de %>%
    mutate(sig = factor(ifelse(padj < 0.01, T, F), levels = c(T, F))) %>%
    filter(sig == F) %>%
    ggplot(aes(log(baseMean), log2FoldChange)) +
    geom_point(color = 'grey', alpha = 0.2) -> unsig_ma_plt
  
  unsig_ma_plt +
    geom_point(
      data = panc_annotated_rmsk_de %>%
        mutate(sig = factor(ifelse(padj < 0.01, T, F), levels = c(T, F))) %>%
        filter(sig == T),
      aes(color = clade, fill = after_scale(alpha(color, 0.4))),
      # show.legend = F
    ) +
    ggrepel::geom_text_repel(
      data = panc_annotated_rmsk_de %>%
        mutate(sig = factor(ifelse(padj < 0.01, T, F), levels = c(T, F))) %>%
        filter(sig == T),
      aes(label = ifelse(sig == T &
                           abs(log2FoldChange) > 2, gene, '')) ,
      size = txt.mm_to_pts(1),
      box.padding = 0.3,
      show.legend = F,
      max.overlaps = 25
    ) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    scale_color_manual(values = te_color_pal, name = 'biotype/clade', drop = F) -> plt
  
  
  return(plt)
  
}) -> Fig_S4_ma_plt_list
```
### Fig_S4F
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              calc_entropy)
calc_entropy(
  elife_rmsk_quant$rmsk$deseq$norm_counts.df,
  elife_meta_data,
  grouping_level = 'clade'
) %>%
  filter(
    clade %in% c(
      names(te_color_pal)
    )
  ) %>%
  ggplot(aes(
    diagnosis,
    entropy,
    # shape = gender,
    color = clade,
    fill = after_scale(alpha(color, 0.4))
  )) +
  geom_boxplot(
    fill = NA,
    outlier.shape = NA,
    aes(group = diagnosis),
    show.legend = F
  ) +
  geom_jitter(width = 0.125, show.legend = F, shape = 21) +
  ggforce::facet_row( ~ clade, space = 'free', strip.position = 'top') +
  ylim(0, 24) + ylab('Shannon Entropy') + xlab('') +
  # scale_shape_manual(values = disc_identity_shape_pal) +
  scale_color_manual(values = te_color_pal) +
  ggpubr::stat_compare_means(
    comparisons = list(c('Healthy donor', 'Colorectal Cancer'),
                       c('Healthy donor', 'Esophagus Cancer'),
                       c('Healthy donor', 'Liver Cancer'),
                       c('Healthy donor', 'Lung Cancer'),
                       c('Healthy donor', 'Stomach Cancer')),
    method = 'wilcox',
    size = 2.5,
    method.args = list(exact = TRUE, paired = F),
    label = 'p.signif'
  ) +
  theme(axis.text.x = element_text(angle = 40, hjust = 1),
        strip.text = element_text(size = txt.mm_to_pts(1.5))) -> fig.S4.F
```
### Fig_S4_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)

fig_S4_layout <- "
AB
CD
EF
GG
"

wrap_plots(Fig_S4_ma_plt_list[[1]] + ggtitle('liver cancer'),
           Fig_S4_ma_plt_list[[2]] + ggtitle('lung cancer'),
           Fig_S4_ma_plt_list[[3]] + ggtitle('esophagus cancer'),
           Fig_S4_ma_plt_list[[4]] + ggtitle('colorectal cancer'),
           Fig_S4_ma_plt_list[[5]] + ggtitle('stomach cancer'),
           guide_area(),
           fig.S4.F,
           heights = c(0.75,0.75,0.75,1.75),
           guides = 'collect',
           design = fig_S4_layout) +
  plot_annotation(tag_levels = 'A') &
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 0.5),
        legend.justification = c(0.5, 0.5)) -> fig.S4.patchwork

save.manuscript.panel(figure = 4,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S4',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S4.patchwork)
```

# modeling_&_figures

## binomial_modeling_and_analysis
```{r}
doMC::registerDoMC(cores = 12)

# final_alpha_new is generated by running R/job_elifeTrainLoop.R

# final_alpha_new <- read_rds(file = file.path(output_data.dir, 'final_alpha_new.rds'))

inverse.logit.calc <- function(y_hat) { exp(y_hat)/(1+exp(y_hat)) }


lapply(final_alpha_new, function(cancer) {
  lapply(cancer, function(feature_set) {
    lapply(feature_set, function(alpha) {
      
      alpha$perf_list
      
    }) %>% bind_rows(.id = 'alpha')
    
  }) %>% bind_rows(.id = 'feature_set')
  
}) %>% bind_rows(.id = 'cancer') -> alpha_summary


alpha_summary %>% 
  group_by(cancer) %>% 
  slice(which.max(tpr)) %>% 
  mutate(auc = as.numeric(auc))-> top_alpha

alpha_summary %>% 
  filter(feature_set == 'gencode') %>% 
  group_by(cancer) %>% 
  slice(which.max(tpr)) -> gencode_alpha


alpha_order <- setNames(c(1:nrow(top_alpha)), top_alpha %>% pull(cancer))

imap(alpha_order, function(index, cancer) {
  message(cancer)
  
  feature_set <- top_alpha[index, 7, drop = T]
  best_alpha <- as.numeric(top_alpha[index, 6, drop = T])
  gencode_alpha <- as.numeric(gencode_alpha[index, 6, drop = T])
  
  best_model <-
    final_alpha_new[[cancer]][[feature_set]][[best_alpha]]

  gencode_model <-
    final_alpha_new[[cancer]][['gencode']][[gencode_alpha]]


  list('best_model' = best_model,
       'gencode_model' = gencode_model)
  
}) -> model_comparison


elife_meta_data %>% 
  mutate(diagnosis = ifelse(diagnosis == 'Healthy donor', 0, 1)) %>% 
  select(sample, diagnosis) %>% 
  column_to_rownames('sample') -> elife_labels

binom_CI <- function(x, n, l) {
    CI <- binom.test(round(x*n), n, 0.5, alternative =  "two.sided", conf.level = 0.90)$conf.int[l]
    return(CI)
}


lapply(model_comparison, function(model) {
  lapply(model, function(comparison) {
    
    y_hat_matrix <-
      comparison$model$fit.preval[, which(comparison$model$lambda == comparison$model$lambda.min)]
    
    filt_elife_labels <- elife_labels[rownames(elife_labels) %in% names(y_hat_matrix), ,drop=F]
    
    filt_elife_labels <- filt_elife_labels[match(names(y_hat_matrix), rownames(filt_elife_labels)), ]
    
    
    predictions <-
      ROCR::prediction(
        labels = filt_elife_labels,
        predictions = y_hat_matrix,
        label.ordering = c(0, 1)
      )

    performances <-
      ROCR::performance(
        prediction.obj = predictions,
        measure = "tpr",
        x.measure = "fpr"
      )

    cutoffs <-
      comparison$perf_list %>% 
      mutate(n = length(performances@y.values[[1]])) %>% 
      rowwise() %>%
      mutate(ci_low = binom_CI(tpr, n, 1),
             ci_high = binom_CI(tpr, n, 2))

    coef_tmp <-
      cbind(glmnet::coef.glmnet(comparison$model, s = comparison$model$lambda.min))

    beta <- coef_tmp[apply(coef_tmp != 0, 1, any),]

    colnames(beta) <-
      names(glmnet::coef.glmnet(comparison$model, s = comparison$model$lambda.min))

    
    rocCurve <-
      as.data.frame(cbind(unlist(slot(
        performances, "x.values"
      )[[1]]),
      unlist(slot(
        performances, "y.values"
      )[[1]])))

    colnames(rocCurve) <- c("X", "Y")

    ggplot(rocCurve, aes(x = X, y = Y)) +
      geom_line() +
      geom_abline(linetype = "dotted", color = "grey50") +
      labs(x = "False Positive Rate", y = "True Positive Rate") +
      ylim(0, 1) + xlim(0, 1) -> rocCurv.plt
    
    binomial_model_response_prob <- inverse.logit.calc(y_hat_matrix)
    
    list('roc' = rocCurv.plt,
         'response_prob' = binomial_model_response_prob,
         'beta' = beta,
         'perf' = performances,
         'pred' = predictions,
         'cutoffs' = cutoffs)
    
  })
}) -> training_performance

training_performance$Esophagus$best_model$beta


lapply(training_performance, function(model) {
  lapply(model, function(cancer) {
    lapply(model, function(comparison) {
      length(comparison$beta)
      
    }) %>% bind_rows(.id = 'comparison')
  }) %>% bind_rows(.id = 'model')
}) %>% bind_rows(.id = 'cancer') %>% distinct() %>% 
  filter(model == 'best_model')


lapply(model_comparison, function(model) {
  lapply(model, function(comparison) {
    
    test_y_hat <- predict(
      object = comparison$model,
      s = 'lambda.min',
      newx = comparison$test_x,
      newy = comparison$test_y,
      type = 'response'
    )
    
    test_y_hat <-
      ifelse(test_y_hat > comparison$perf_list$cut, 1, 0)
    
    data.frame('pred' = test_y_hat, 'label' = comparison$test_y) %>% 
      mutate(result = case_when(
        lambda.min == label & label == 1 ~ 'TP',
        lambda.min == label & label == 0 ~ 'TN',
        lambda.min != label & label == 1 ~ 'FN',
        lambda.min != label & label == 0 ~ 'FP'
      )) -> results
    
    TP <- sum(results$result == 'TP')
    TN <- sum(results$result == 'TN')
    FN <- sum(results$result == 'FN')
    FP <- sum(results$result == 'FP')
    
    sensitivity <- TP/(TP+FN)
    specificity <- TN/(TN+FP)
    
    data.frame('tpr' = sensitivity, 
               'fpr' = specificity,
               'n' = nrow(results)) %>% 
      rowwise() %>%
      mutate(ci_low = binom_CI(tpr, n, 1),
             ci_high = binom_CI(tpr, n, 2)) -> cutoffs
    
    list('results' = results,
         'sens' = sensitivity,
         'spec' = specificity,
         'cutoffs' = cutoffs)
    
  })
  
}) -> testing_performance

make_anno_de <- function(de_out) {
  de_out %>%
    merge(reference_meta_data$ucsc_rmsk_insert_info.df,
          by = 'gene',
          all.x = T) %>%
    mutate(
      family = ifelse(
        ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
        'GENCODE_lncRNA',
        family
      ),
      family = ifelse(is.na(family), 'GENCODE_coding', family),
      clade = ifelse(grepl('GENCODE', family), family, clade),
      clade = ifelse(
        clade %in% c(
          'GENCODE_coding',
          'GENCODE_lncRNA',
          'LINE',
          'SINE',
          'LTR',
          'DNA',
          'Simple_repeat'
        ),
        clade,
        'other'
      ),
      type = ifelse(grepl('GENCODE', family), 'GENCODE', 'TE'),
      clade = factor(clade, levels = te_aware_annotation_levels)
    ) %>%
    filter(!ensg %in% chrM.filter.list,
           !grepl('^MT', gene))
}
```

## Fig_4
### Fig_4A-T
```{r}
lapply(names(training_performance), function(cancer) {
  
  message(cancer)
  
  elife_select <- ifelse(cancer == 'Esophagus', 'esoph', tolower(cancer))
  elife_select <- paste0(elife_select, '_healthy')
  
  training_performance[[cancer]]$best_model$beta %>%
    as.matrix() %>%
    as.data.frame() %>%
    rownames_to_column('gene') %>%
    rename('beta' = V1) -> feature_df
  
  feature_df %>% 
    filter(gene %in% reference_meta_data$ucsc_rmsk_insert_info.df$gene) %>%
    merge(elife_rmsk_quant[[elife_select]]$deseq$de_out %>% make_anno_de()) %>%
    ggplot(aes(
      beta,
      log2FoldChange,
      color = clade,
      fill = after_scale(alpha(color, 0.4))
    )) +
    geom_hline(yintercept = 0,
               linetype = 'dashed',
               alpha = 0.4) +
    geom_vline(xintercept = 0,
               linetype = 'dashed',
               alpha = 0.4) +
    geom_point(shape = 21, show.legend = F) +
    scale_color_manual(values = te_color_pal) +
    ggtitle(paste0("# non-zero features: ", nrow(feature_df) - 1)) +
    ggrepel::geom_text_repel(aes(label = gene),
                             show.legend = F ,
                             size = txt.mm_to_pts(0.8)) -> beta_plot
  
  
  training_performance[[cancer]]$best_model$roc$data %>%
    as.data.frame() %>%
    mutate(model = 'aware') %>%
    rbind(
      training_performance[[cancer]]$gencode_model$roc$data %>%
        as.data.frame() %>%
        mutate(model = 'naive')
    ) %>%
    ggplot(aes(X, Y, color = model)) +
    geom_line() +
    geom_abline(linetype = "dotted", color = "grey50") +
    scale_color_colorblind() +
    ylab('sensitivity') +
    xlab('1 - specificity') +
    ggtitle(cancer) +
    annotate(
      "text",
      label = paste0(
        "AUC: ",
        round(as.numeric(training_performance[[cancer]]$best_model$cutoffs$auc), 2),
        ' > ',
        round(as.numeric(training_performance[[cancer]]$gencode_model$cutoffs$auc), 2)
        ),
        y = 0.125,
        x = 0.5,
        size = txt.mm_to_pts(0.8)
      ) +
        theme(
          legend.position = c(0.9, 0.7),
          legend.title = element_blank(),
          legend.background = element_blank()
        ) -> roc.plt
  
  training_performance[[cancer]]$best_model$cutoffs %>%
    mutate(model = 'aware') %>%
    rbind(training_performance[[cancer]]$gencode_model$cutoffs %>%
            mutate(model = 'naive')) %>%
    group_by(model) %>%
    mutate(model = factor(model, levels = c('naive', 'aware'))) %>%
    filter(fpr == model_comparison[[cancer]]$best_model$perf_list$fpr) %>%
    slice(which.max(tpr)) %>%
    mutate(split = 'Training') %>%
    ggplot(aes(
      model,
      ymin = ci_low,
      y = tpr,
      ymax = ci_high
    )) +
    geom_point() +
    geom_errorbar() +
    geom_text(aes(label = round(tpr, 2)), y = 0.075, size = txt.mm_to_pts(0.8)) +
    ggtitle(paste0('N: ', training_performance[[cancer]]$best_model$cutoff$n)) +
    ylim(0, 1) + xlab('') +
    ylab('sens. @ 90% spec.') +
    ggforce::facet_row(~ split) -> train.plt
  
  testing_performance[[cancer]]$best_model$cutoffs %>%
    mutate(model = 'aware') %>%
    rbind(testing_performance[[cancer]]$gencode_model$cutoffs %>%
            mutate(model = 'naive')) %>%
    group_by(model) %>%
    mutate(model = factor(model, levels = c('naive', 'aware'))) %>%
    mutate(split = 'Testing') %>%
    ggplot(aes(
      model,
      ymin = ci_low,
      y = tpr,
      ymax = ci_high
    )) +
    geom_point() +
    geom_errorbar() +
    geom_text(aes(label = round(tpr, 2)), y = 0.075, size = txt.mm_to_pts(0.8)) +
    ggtitle(paste0('N: ', testing_performance[[cancer]]$best_model$cutoff$n)) +
    ylim(0, 1) + xlab('') +
    ylab('testing sens.') +
    ggforce::facet_row( ~ split) -> test.plt
  
  list('roc' = roc.plt,
       'train' = train.plt,
       'test' = test.plt,
       'beta' = beta_plot)
  
}) -> plot_list

# wrap_elements(full = plot_list[[1]]$roc)

```
### Fig_4_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)

fig_4_layout <- "
ABCD
EFGH
IJKL
MNOP
QRST
"

wrap_plots(
  wrap_elements(full = plot_list[[3]]$roc),
  plot_list[[3]]$train,
  plot_list[[3]]$test,
  plot_list[[3]]$beta,
  wrap_elements(full = plot_list[[2]]$roc),
  plot_list[[2]]$train,
  plot_list[[2]]$test,
  plot_list[[2]]$beta,
  wrap_elements(full = plot_list[[1]]$roc),
  plot_list[[1]]$train,
  plot_list[[1]]$test,
  plot_list[[1]]$beta,
  wrap_elements(full = plot_list[[5]]$roc),
  plot_list[[5]]$train,
  plot_list[[5]]$test,
  plot_list[[5]]$beta,
  wrap_elements(full = plot_list[[4]]$roc),
  plot_list[[4]]$train,
  plot_list[[4]]$test,
  plot_list[[4]]$beta,
  widths = c(1.3, 0.7, 0.7, 1),
  # guides = 'collect',
  design = fig_4_layout
) +
  plot_annotation(tag_levels = 'A') &
  theme(
    plot.tag.position = c(0.01, 0.99),
    legend.position = 'bottom',
    legend.title = element_text(vjust = 0.5),
    legend.justification = c(0.5, 0.5)
  ) -> fig.4.patchwork

save.manuscript.panel(figure = 4,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_4',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.4.patchwork)
```

# nanopore_&_figures

## read_len_load
```{r}
panc.7.1.1_read_len <- read_csv(file.path(output_data.dir, 'nanopore', 
                                          'nanopore_read_len', 'panc.7.1.1_biotype_read_lengths.csv')) %>% 
  separate(sample, sep = '[.]', into = c(NA,NA,'biotype',NA)) %>% 
  mutate(biotype = sub('_extraction', '', biotype))

panc.6.1.1_read_len <- read_csv(file.path(output_data.dir, 'nanopore', 
                                          'nanopore_read_len', 'panc.6.1.1_biotype_read_lengths.csv')) %>% 
  separate(sample, sep = '[.]', into = c(NA,NA,'biotype',NA)) %>% 
  mutate(biotype = sub('_extraction', '', biotype))

# ctrl.6.1.5_read_len <- read_csv(file.path(output_data.dir, 'nanopore',
#                                           'nanopore_read_len', 'ctrl.6.1.5_biotype_read_lengths.csv')) %>%
#   separate(sample, sep = '[.]', into = c(NA,NA,'biotype',NA)) %>%
#   mutate(biotype = sub('_extraction', '', biotype))

panc.7.1.1_read_len %>% 
  mutate(sample = 'panc.7.1.1') %>% 
  rbind(panc.6.1.1_read_len %>%
         mutate(sample = 'panc.6.1.1')) %>% 
  # rbind(ctrl.6.1.5_read_len %>%
  #        mutate(sample = 'ctrl.6.1.5')) %>%
  group_by(biotype) -> panc_nanopore_read_length.df

# illumina_read_len <- list.files(file.path(output_data.dir, 'nanopore', 'illumina_read_len'), full.names = T)[1:31]
# names(illumina_read_len) <- gsub(basename(illumina_read_len), pattern = '.csv', replacement = '')[1:31]
# 
# name_conversion <- data.frame('in_name' = stringr::str_split_fixed(names(illumina_read_len), '[.]', n = 2)[,1])
# 
# name_conversion$out_name <- c('panc.1.2.3', 'panc.2.2.7', 'panc.4.3.9', 
#                               'panc.5.4.5', 'panc.6.2.5', 'panc.7.2.5',
#                               'panc.9.2.5', 'panc.7.1.1', 'panc.9.1.1', 
#                               'panc.10.1.2', 'panc.6.1.1', 'covid.400.0.56', 'covid.381.0.80',
#                               'covid.396.0.68', 'covid.411.0.75', 'covid.412.0.64',
#                               'covid.426.0.80', 'covid.432.0.58', 'covid.441.0.64',
#                               'covid.442.0.61', 'covid.450.0.84', 'ctrl.12.1.1', 
#                               'ctrl.5.1.3', 'ctrl.7.1.2', 'ctrl.9.1.2', 'ctrl.13.0.7', 
#                               'ctrl.8.1.2', 'ctrl.10.0.4', 'ctrl.6.1.5', 'ctrl.11.1.1','ctrl.4.1.3')
# 
# illumina_roster_names <- read_csv(file.path(output_data.dir, 'nanopore', 'illumina_read_len', 'ROSTER.csv'),
#                                   col_names = c('read', 'sample'))

# lapply(illumina_read_len, function(file) {
# 
#   read_len_file <- read_csv(file = file,
#                             col_names = c('read', 'read_length', 'seq_1',
#                                           'seq_2', 'originally_multisample',
#                                           'tx', 'sample'))
#   read_len_file %>%
#     mutate(tx = ifelse(grepl('^ENST', tx),
#             str_split_fixed(tx, pattern = '[|]', n = 10)[,1],
#             tx)) %>%
#     mutate(tx = ifelse(grepl('_range', tx),
#             str_split_fixed(tx, pattern = '::', n = 2)[,1],
#             tx)) %>%
#   mutate(sample = stringr::str_split_fixed(sample, '[.]', n = 2)[,1],
#          sample = gsub(pattern = 'panc_', replacement = 'panc', sample)) %>%
#     merge(name_conversion, by.x = 'sample', by.y = 'in_name') %>%
#     merge(reference_meta_data$total_tx_to_gene.df, by.x = 'tx', by.y = 'enst') %>%
#     dplyr::rename('sample_name' = 'out_name')
# 
# 
# }) -> illumina_read_len.list
# 
# 
# saveRDS(object = illumina_read_len.list, file = file.path(output_data.dir, 'nanopore', 'illumina_read_len.rds'))
# illumina_read_len.list <- readRDS(file = file.path(output_data.dir, 'nanopore', 'illumina_read_len.rds'))

# illumina_read_len.list %>%
#   bind_rows(.id = 'sample') %>%
#   filter(!sample %in% qc_fails) %>%
#   merge(sample_meta_data$`2022.01.14_combined_meta_data.csv`, by.x = 'sample_name', by.y = 'patient') %>%
#   group_by(condition, biotype) %>%
#   mutate(z_score = scale(abs(read_length))) %>%
#   filter(between(z_score, -2.5, 2.5)) -> illumina_read_len.df
# 
# saveRDS(object = illumina_read_len.df, file = file.path(output_data.dir, 'nanopore',
#                                                            'illumina_read_len.df.rds'))
# rm(illumina_read_len.list)

# illumina_read_len.df <- readRDS(file = file.path(output_data.dir, 'nanopore',
#                                                            'illumina_read_len.df.rds'))
# 
# illumina_read_len.df$seq_1 <- NULL
# illumina_read_len.df$seq_2 <- NULL
# 
# vroom::vroom_write(illumina_read_len.df, file = file.path(output_data.dir, 'nanopore','illumina_read_len_no_seq.tsv.gz'))

# illumina_read_len.df <-
#   vroom::vroom(file = file.path(output_data.dir,'nanopore','illumina_read_len_no_seq.tsv.gz'), num_threads = 16)
```
## short_long_compare
```{r}
panc.7.1.1_nanopore_tpm <- 
  read_tsv(file.path(output_data.dir, 
                     'nanopore', 'gencode_39_rmsk_nanopore_abundance', 'panc.7.1.1_gene_abundance.tsv'))

panc.6.1.1_nanopore_tpm <- 
  read_tsv(file.path(output_data.dir, 
                     'nanopore', 'gencode_39_rmsk_nanopore_abundance', 'panc.6.1.1_gene_abundance.tsv'))

import::from(.from = 'SummarizedExperiment', assay)

count_matrix.df <- 
  as.data.frame(as.matrix(assay(internal_rmsk_quant$panc_normal$gxi, 'counts')))

count_matrix.df[, 'panc.7.1.1', drop = F] %>% rownames_to_column('Gene ID') %>% 
  mutate(panc.7.1.1_tpm = panc.7.1.1*1e6/(sum(panc.7.1.1))) %>% 
  merge(panc.7.1.1_nanopore_tpm %>% select(`Gene ID`, TPM), by = 'Gene ID') %>% 
  dplyr::rename('panc.7.1.1_nanopore_tpm' = TPM) %>%
  group_by(`Gene ID`) %>% 
  summarize(panc_7_tpm = mean(panc.7.1.1_tpm),
            panc_7_nanopore_tpm = mean(panc.7.1.1_nanopore_tpm)) %>% 
  distinct() -> panc_7.1.1_tpm

count_matrix.df[, 'panc.6.1.1', drop = F] %>% rownames_to_column('Gene ID') %>%
  mutate(panc.6.1.1_tpm = panc.6.1.1 *1e6/(sum(panc.6.1.1))) %>% 
  merge(panc.6.1.1_nanopore_tpm %>% select(`Gene ID`, TPM), by = 'Gene ID') %>% 
  dplyr::rename('panc.6.1.1_nanopore_tpm' = TPM) %>% 
  group_by(`Gene ID`) %>% 
  summarize(panc_6_tpm = mean(panc.6.1.1_tpm),
            panc_6_nanopore_tpm = mean(panc.6.1.1_nanopore_tpm)) %>% 
  distinct() -> panc_6.1.1_tpm

merge(panc_7.1.1_tpm, panc_6.1.1_tpm, by = 'Gene ID') -> panc_compare.df


panc_compare.df %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by.x = 'Gene ID', by.y = 'gene', all.x = T) %>% 
  mutate(family = ifelse(`Gene ID` %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'GENCODE_lncRNA', family),
         family = ifelse(is.na(family), 'GENCODE_coding', family),
         clade = ifelse(grepl('GENCODE', family), family, clade),
         clade = ifelse(clade %in% c('GENCODE_coding',
                                     'GENCODE_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('GENCODE',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) -> panc_compare_annotated.df
```
## hex_to_plot
```{r}
panc_nanopore_read_length.df %>% 
  ungroup() %>% 
  mutate(originally_multisample = ifelse(grepl('^ENST', originally_multisample), 
            str_split_fixed(originally_multisample, pattern = '[|]', n = 10)[,1],
            originally_multisample)) %>% 
  mutate(originally_multisample = ifelse(grepl('_range', originally_multisample),
            str_split_fixed(originally_multisample, pattern = '::', n = 2)[,1],
            originally_multisample)) %>%
  merge(reference_meta_data$total_tx_to_gene.df, by.x = 'originally_multisample', by.y = 'enst') %>% 
  mutate(len = as.numeric(len)) -> len_compare.df

len_compare.df %>%
  filter(biotype.x == 'SINE', sample == 'panc.6.1.1') -> panc.6.1.1_nanopore_hex_to.plt

len_compare.df %>% 
  filter(biotype.x == 'SINE', sample == 'panc.7.1.1') -> panc.7.1.1_nanopore_hex_to.plt
```

## Fig_S5
### Fig_S5A
```{r}
panc_nanopore_read_length.df %>% 
  group_by(biotype) %>% 
  mutate(z_score = scale(abs(read_length))) %>% 
  filter(between(z_score, -2.5, 2.5))-> panc_nanopore_read_length.df

table(panc_nanopore_read_length.df$biotype) %>% 
  as.data.frame() %>% 
  select(biotype = Var1) %>% 
  mutate(biolabel = c('LINE', 'GENCODE_lncRNA', 'LTR', 'GENCODE_coding', 'SINE')) -> nanopore_biotype_labels

panc_nanopore_read_length.df %>% 
  group_by(biotype) %>% 
  # mutate(biotype = factor(biotype, levels = c('SINE', ')))
  # filter(!grepl('ctrl', sample)) %>% 
  merge(nanopore_biotype_labels, by = 'biotype') %>% 
  mutate(biolabel = factor(biolabel, levels = te_aware_annotation_levels),
         sample = case_when(sample == 'panc.7.1.1' ~ 'panc 7', 
                            sample == 'panc.6.1.1' ~ 'panc 6')) %>% 
  ggplot(aes(abs(read_length), fill = sample)) + 
  geom_histogram(aes(y=stat(density*width)), bins = 100) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01)) +
  ggforce::facet_col(~biolabel, scales = 'free') +
  scale_fill_manual(values = viridisLite::plasma(20)[c(8,10)]) +
  coord_cartesian(clip = 'off') +
  ylab('proportion of nanopore reads') + xlab('nanopore read length (bp)') +
  theme(legend.position = c(0.55,0.99), legend.direction = 'horizontal', plot.margin = margin(r = 3, unit = 'mm')) -> plt_NC.plt
```
### Fig_S5B
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)
install.packages('hexbin')

panc.6.1.1_nanopore_hex_to.plt %>% 
  group_by(tx, len, biotype.x, sample) %>% 
  summarize(read_length = mean(read_length)) %>% 
  merge(nanopore_biotype_labels, by.x = 'biotype.x', by.y = 'biotype') %>% 
  mutate(biolabel = factor(biolabel, levels = te_aware_annotation_levels),
         condition = ifelse(grepl('ctrl', sample), 'ctrl', 'panc')) %>% 
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  xlab('avg. observed SINE read length (bp)') + ylab('expected SINE insert length (bp)') +
  ggtitle('panc 6') + 
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', breaks = c(0,1)) +
  scale_y_continuous(breaks = c(100,200,300,400), limits = c(75,425)) +
  scale_x_continuous(breaks = c(100,200,300,400), limits = c(75,370)) +
  theme(legend.position = c(0.98,0.45), legend.direction = 'horizontal', legend.key.width = unit(1, 'mm')) +
  guides(fill = guide_colorbar(title.position = 'left', title.vjust = 1)) -> plt_NE.plt

panc.7.1.1_nanopore_hex_to.plt %>% 
  group_by(tx, len, biotype.x, sample) %>% 
  summarize(read_length = mean(read_length)) %>% 
  merge(nanopore_biotype_labels, by.x = 'biotype.x', by.y = 'biotype') %>% 
  mutate(biolabel = factor(biolabel, levels = te_aware_annotation_levels),
         condition = ifelse(grepl('ctrl', sample), 'ctrl', 'panc')) %>% 
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  xlab('avg. observed SINE read length (bp)') + ylab('expected SINE insert length (bp)') +
  ggtitle('panc 7') + 
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', guide = 'none') +
  scale_y_continuous(breaks = c(100,200,300,400), limits = c(75,425)) +
  scale_x_continuous(breaks = c(100,200,300,400), limits = c(75,370)) -> plt_SNA_3.plt

panel_SNA_layout <- "
AA
BB
"

wrap_plots(plt_NE.plt + xlab(''),
           plt_SNA_3.plt,
           design = panel_SNA_layout) -> panel.SNA.patchwork
```
### Fig_S5C
```{r}
devtools::install_github("SwampThingPaul/AnalystHelper")

panc.6.1.1_nanopore_hex_to.plt %>%
        pull(read_length) %>%
        AnalystHelper::ecdf_fun(CI = T, CI.interval = 0.99) %>%
          mutate(sample = 'panc 6') %>%
  rbind(panc.7.1.1_nanopore_hex_to.plt %>%
        pull(read_length) %>%
        AnalystHelper::ecdf_fun(CI = T, CI.interval = 0.99) %>%
          mutate(sample = 'panc 7')) %>%
  ggplot(aes(x = value, y = proportion, min = lwr.CI, ymax = upr.CI, color = sample)) +
  geom_ribbon(alpha = 0.05) +
  geom_step() +
  xlim(130,315) +
  scale_color_manual(values = viridisLite::plasma(20)[c(8,10)], guide = 'none') +
  ylab('cumulative prop. (99% CI)') +
  xlab('nanopore SINE read length (bp)') +
  theme(legend.position = c(0.25, 0.99)) -> plt_ND_2.plt
```
### Fig_S5_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


fig_S5_layout <- "
AB
AB
AB
AD
CC
"

wrap_plots(plt_NC.plt,
           wrap_elements(full = panel.SNA.patchwork, clip = F),
           guide_area(),
           plt_ND_2.plt + coord_cartesian(clip = 'off'),
           design = fig_S5_layout, 
           guides = 'collect',
           heights = c(1,1,1,1,0.17)) +
  plot_annotation(tag_levels = 'A') &
  theme(legend.justification = 'center', legend.position = 'bottom') -> fig.S5.patchwork

save.manuscript.panel(figure = 5,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S5',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S5.patchwork)
```

## Fig_S6
### Fig_S6A
```{r}
lm(panc_7_nanopore_tpm ~ panc_7_tpm, data = panc_compare_annotated.df) %>% 
  summary() -> panc_lm_out

b <- round(panc_lm_out$coefficients[1,1], 2)
m <- round(panc_lm_out$coefficients[2,1], 2)
r2 <- round(panc_lm_out$adj.r.squared, 2)

panc_compare_annotated.df %>% 
  ggplot(aes(log2(panc_7_nanopore_tpm + 1), log2(panc_7_tpm + 1), color = clade, fill = clade)) + 
  geom_hex(alpha = 0.4, bins = 250) +
  annotate(geom = 'text', x = 6, y = 16, fontface = 'italic',
         label = paste0('y', ' ', ' = ',b,' + ',m,'x; adj. R2 = ', r2), 
         size = rel(3.75), alpha = 0.8) + 
  scale_color_manual(values = te_color_pal) + 
  scale_fill_manual(values = te_color_pal)-> plt_SN2B.plt
```
### Fig_S6B
```{r}
lm(panc_6_nanopore_tpm ~ panc_6_tpm, data = panc_compare_annotated.df) %>% 
  summary() -> panc_lm_out

b <- round(panc_lm_out$coefficients[1,1], 2)
m <- round(panc_lm_out$coefficients[2,1], 2)
r2 <- round(panc_lm_out$adj.r.squared, 2)

panc_compare_annotated.df %>% 
  ggplot(aes(log2(panc_6_nanopore_tpm + 1), log2(panc_6_tpm + 1), color = clade, fill = clade)) + 
  geom_hex(alpha = 0.4, bins = 250) +
  annotate(geom = 'text', x = 6, y = 16, fontface = 'italic',
         label = paste0('y', ' ', ' = ',b,' + ',m,'x; adj. R2 = ', r2), 
         size = rel(3.75), alpha = 0.8) +
  scale_color_manual(values = te_color_pal) + 
  scale_fill_manual(values = te_color_pal) -> plt_SN2C.plt
```
### Fig_S6_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


fig_S6_layout <- "
AA
BB
DD
"

wrap_plots(plt_SN2B.plt + ggtitle('panc 7 nanopore v illumina'),
           guide_area(),
           plt_SN2C.plt + ggtitle('panc 6 nanopore v illumina'),
           guides = 'collect',
           design = fig_S6_layout,
           heights = c(1,0.25,1,1)) +
  plot_annotation(tag_levels = 'A') & 
  theme(legend.position = 'bottom', 
        legend.justification = c(0.5, 0.5))-> fig.S6.patchwork

save.manuscript.panel(figure = 6,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S6',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S6.patchwork)
```