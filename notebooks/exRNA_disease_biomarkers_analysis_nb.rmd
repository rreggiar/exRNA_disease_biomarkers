---
title: "exRNA_disease_biomarkers_nb"
output: html_notebook
author:
- name: "Roman E. Reggiardo"
  affiliation: "UC Santa Cruz Dept. of Biomolecular Engineering"
  email: "rreggiar@ucsc.edu"
editor_options: 
  chunk_output_type: console
---
# nb_setup
```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, collapse = T)
knitr::opts_chunk$set(message = F)
# here::set_here('/home/rreggiar/')
here::here()
suppressPackageStartupMessages(library(tidyverse))
```

# global_init
## ggplot_theme
```{r}
library(ggplot2)
library(ggthemes)
base_size = 10

ggplot2::theme_set(ggthemes::theme_foundation(base_size = base_size,
                                              base_family = 'Helvetica') + 
                     theme(plot.title = element_text(size = base_size, face = 'bold'),
                           panel.background = element_rect(colour = NA),
                           plot.background = element_rect(colour = NA),
                           panel.border = element_rect(colour = NA), 
                           axis.line = element_line(), 
                           axis.line.x = NULL, 
                           axis.line.y = NULL, 
                           axis.text = element_text(size = rel(0.95)), 
                           axis.text.x = element_text(margin = 
                                                        margin(t = 0.8 * base_size/4)), 
                           axis.text.x.top = element_text(margin = 
                                                            margin(b = 0.8 * base_size/4), 
                                                          vjust = 0), 
                           axis.text.y = element_text(margin = 
                                                        margin(r = 0.5 * base_size/4), 
                                                      hjust = 1),
                           axis.text.y.right = element_text(margin = 
                                                              margin(l = 0.5 * base_size/4), 
                                                            hjust = 0), 
                           axis.ticks = element_line(), 
                           axis.ticks.length = unit(base_size/2.5, "pt"), axis.ticks.length.x = NULL, 
                           axis.ticks.length.x.top = NULL, axis.ticks.length.x.bottom = NULL, 
                           axis.ticks.length.y = NULL, axis.ticks.length.y.left = NULL, 
                           axis.ticks.length.y.right = NULL,
                           strip.text = element_text(size = rel(0.95), face = 'bold'),
                           strip.background = element_blank(),
                           legend.key.size= unit(0.08, "in"),
                           legend.spacing = unit(0, "in"),
                           legend.key = element_rect(colour = NA),
                           legend.title = element_text(face="italic"),
                           legend.text = element_text(face = 'bold'),
                           legend.justification = c("right", "top"),
                           legend.box.just = "right",
                           legend.margin = margin(6, 6, 6, 6),
                           plot.tag = element_text(size = base_size, face = 'bold'),
                           plot.margin=margin(0.04,
                                              0.04,
                                              0.04,
                                              0.04,
                                              unit = "in"),
                           legend.box.spacing = unit(-0.02, 'in'),
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank()
                           )
                   )
```

## data_path_obj
```{r}
figure.dir <- here::here('manuscript/figures')
input_data.dir <- here::here('data/input_data')
output_data.dir <- here::here('data/output_data')
qc_data.dir <- here::here('data/output_data/rna_qc')
meta_data.dir <- here::here('data/meta_data')
reference.dir <- here::here('reference')
r_code.dir <- here::here('R')
```

## figure_export
```{r}
figure_single_column_width = unit(89, 'mm')
figure_double_column_width = unit(183, 'mm')
figure_depth = unit(247, 'mm')
panel_height_1 = unit(247/3, 'mm')

# install.packages("import")

import::from(.directory = r_code.dir, .from = 'helper_analysisFunctions.R', save.manuscript.panel)
```

## analysis_const
```{r}
chr_order <- c('chr1', 'chr2', 'chr3', 
               'chr4', 'chr5', 'chr6', 
               'chr7', 'chr8', 'chr9',
               'chr10', 'chr11', 'chr12', 
               'chr13', 'chr14', 'chr15', 
               'chr16', 'chr17',
               'chr18', 'chr19', 'chr20', 
               'chr21', 'chr22', 'chrX', 'chrY')


gencode_ver <- 39

three_color_pal <- RColorBrewer::brewer.pal(n = 3, 'Dark2')
eight_color_pal <- RColorBrewer::brewer.pal(n = 8, 'Dark2')
viridis_three_color_pal <- viridisLite::plasma(20)[c(1,9,16)]


identity_color_pal <- c('ctrl' = viridis_three_color_pal[[1]],
                        'panc' = viridis_three_color_pal[[2]],
                        'covid' = viridis_three_color_pal[[3]])

te_aware_annotation_levels <- c('gencode_coding',
                                 'gencode_lncRNA',
                                 'LINE',
                                 'SINE',
                                 'LTR',
                                 'DNA',
                                 'Simple_repeat',
                                 'other')

te_color_pal <- c('grey', RColorBrewer::brewer.pal(n = 7, 'Dark2'))
names(te_color_pal) <- te_aware_annotation_levels

te_alone_annotation_levels <- c('LINE',
                                'SINE',
                                'LTR',
                                'DNA',
                                'Simple_repeat',
                                'rRNA',
                                'tRNA')
te_alone_color_pal <- RColorBrewer::brewer.pal(n = 8, 'Dark2')[2:8]
names(te_alone_color_pal) <- te_alone_annotation_levels



```

## meta_data_construction
```{r}

## reference meta data
if (! file.exists(file.path(meta_data.dir, 'reference_meta_data_df.rds'))) {
  
  reference_meta_data <- tibble::lst()
  
  reference_meta_data$ucsc_rmsk_insert_info.df <- 
    readr::read_tsv(file.path(reference.dir, 'ucsc.rmsk.insert.info.txt'),
             col_names = c('gene', 'clade', 'family'))
  
  reference_meta_data$gencode_tx_to_gene.df <- 
    readr::read_csv(file.path(reference.dir, 
                              paste0('gencode.v', gencode_ver, '.tx.to.gene.csv')),
                    col_names = c('tx', 'gene')) %>% 
    tidyr::separate(tx, sep = '\\|', 
                    into = c('enst','ensg',NA,NA,'tx','gene','len','biotype'))
  
  reference_meta_data$gencode_tx_to_gene.df %>% 
    dplyr::select(-enst) %>% 
    dplyr::group_by(biotype) %>% 
    dplyr::tally() -> reference_meta_data$gencode_biotype_count.df
  
  reference_meta_data$gencode_tx_to_gene.df %>% 
    dplyr::select(ensg,biotype) %>% 
    dplyr::group_by(ensg) %>% 
    dplyr::filter(all(biotype == 'lncRNA')) %>% 
    dplyr::distinct() -> reference_meta_data$gencode_lncRNA_gene_names.df
  
  reference_meta_data$ucsc_rmsk_tx_to_gene.df <-  
    readr::read_csv(file.path(reference.dir, 
                              'ucsc.rmsk.insert.analysis.tx.to.gene.csv'),
                    col_names = c('insert', 'info', 'gene', 'len', 'biotype')) %>% 
    mutate(enst = insert, ensg = gene, tx = insert) %>% 
    select(enst, ensg, tx, gene, len, biotype, -insert, -info)
  
  reference_meta_data$total_tx_to_gene.df <- 
    rbind(reference_meta_data$gencode_tx_to_gene.df,
          reference_meta_data$ucsc_rmsk_tx_to_gene.df)
  
  saveRDS(reference_meta_data, file.path(meta_data.dir, 'reference_meta_data_df.rds'))
  
} else {
  reference_meta_data <- readRDS(file.path(meta_data.dir, 'reference_meta_data_df.rds'))
}

## sample_meta_data
if (! file.exists(file.path(meta_data.dir, 'sample_meta_data_df.rds'))) {
  
  list.files(meta_data.dir, pattern = '*_meta_data.csv') -> meta_file.list
  names(meta_file.list) <- meta_file.list
  
  meta_file.list %>% 
    purrr::imap(function(name, file) {
      readr::read_csv(file.path(meta_data.dir, file))
    }) -> sample_meta_data
  
  saveRDS(sample_meta_data, file.path(meta_data.dir, 'sample_meta_data_df.rds'))
  
} else {
  sample_meta_data <- readRDS(file.path(meta_data.dir, 'sample_meta_data_df.rds'))
}

```

# import_data
## load_tximeta_obj
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             load.tximeta.object.list,
             parse.tximeta.quant.metadata)

salmon_quant <- load.tximeta.object.list('salmon', 
                                         output_data.dir = output_data.dir)

salmon_quant <- parse.tximeta.quant.metadata(salmon_quant)


ucsc.rmsk.salmon_quant <- load.tximeta.object.list('ucsc.rmsk.salmon', 
                                                   output_data.dir = output_data.dir)


ucsc.rmsk.salmon_quant <- parse.tximeta.quant.metadata(ucsc.rmsk.salmon_quant)


process.aware.salmon_quant <- load.tximeta.object.list('process.aware.salmon', 
                                                       output_data.dir = output_data.dir)

process.aware.salmon_quant <- parse.tximeta.quant.metadata(process.aware.salmon_quant)
```

# analysis_INTERACTIVE
## QC_filter
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             subset.tximeta.se)

qc_fails <- c('panc.6.2.5', 'panc.7.2.5', 'panc.9.2.5', 
              'panc.10.2.5', 'covid.427.0.80', 'covid.381.0.80')

salmon_quant$bioIvt_panc_salmon <- 
  subset.tximeta.se(salmon_quant$bioIvt_panc_salmon, 
                    filter_list = qc_fails)

ucsc.rmsk.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 
  subset.tximeta.se(ucsc.rmsk.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon, 
                    filter_list = qc_fails)

process.aware.salmon_quant$bioIvt_panc_process.aware.salmon <- 
  subset.tximeta.se(process.aware.salmon_quant$bioIvt_panc_process.aware.salmon, 
                    filter_list = qc_fails)

##

salmon_quant$bioIvt_covid_salmon <- 
  subset.tximeta.se(salmon_quant$bioIvt_covid_salmon, 
                    filter_list = qc_fails)

ucsc.rmsk.salmon_quant$bioIvt_covid_ucsc.rmsk.salmon <- 
  subset.tximeta.se(ucsc.rmsk.salmon_quant$bioIvt_covid_ucsc.rmsk.salmon, 
                    filter_list = qc_fails)

process.aware.salmon_quant$bioIvt_covid_process.aware.salmon <- 
  subset.tximeta.se(process.aware.salmon_quant$bioIvt_covid_process.aware.salmon, 
                    filter_list = qc_fails)
```

## construct_analysis_sets
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             build.analysis.set)
##
salmon_quant$analysis_set$panc_ctrl <- 
  build.analysis.set(se_list = salmon_quant, 
                     se_1 = 'bioIvt_panc_salmon', 
                     se_2 = 'pittsburgh_ctrl_salmon',
                     sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)

salmon_quant$analysis_set$covid_ctrl <- 
  build.analysis.set(se_list = salmon_quant, 
                     se_1 = 'bioIvt_covid_salmon', 
                     se_2 = 'pittsburgh_ctrl_salmon',
                     sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)

salmon_quant$analysis_set$ctrl_panc_covid <- 
  build.analysis.set(se_list = salmon_quant, 
                     se_1 = 'bioIvt_panc_salmon', 
                     analysis_set_2 = salmon_quant$analysis_set$covid_ctrl,
                     sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
##
ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl <- 
    build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
                       se_1 = 'bioIvt_panc_ucsc.rmsk.salmon', 
                       se_2 = 'pittsburgh_ctrl_ucsc.rmsk.salmon',
                       sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)

ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl <- 
    build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
                       se_1 = 'bioIvt_covid_ucsc.rmsk.salmon', 
                       se_2 = 'pittsburgh_ctrl_ucsc.rmsk.salmon',
                       sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid <- 
    build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
                       se_1 = 'bioIvt_panc_ucsc.rmsk.salmon', 
                       analysis_set_2 = ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl,
                       sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
##
process.aware.salmon_quant$analysis_set$panc_ctrl <- 
    build.analysis.set(se_list = process.aware.salmon_quant, 
                       se_1 = 'bioIvt_panc_process.aware.salmon', 
                       se_2 = 'pittsburgh_ctrl_process.aware.salmon',
                       sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)

process.aware.salmon_quant$analysis_set$covid_ctrl <- 
    build.analysis.set(se_list = process.aware.salmon_quant, 
                       se_1 = 'bioIvt_covid_process.aware.salmon', 
                       se_2 = 'pittsburgh_ctrl_process.aware.salmon',
                       sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)

process.aware.salmon_quant$analysis_set$ctrl_panc_covid <- 
    build.analysis.set(se_list = process.aware.salmon_quant, 
                       se_1 = 'bioIvt_panc_process.aware.salmon', 
                       analysis_set_2 = process.aware.salmon_quant$analysis_set$covid_ctrl,
                       sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
```

## save memory
```{r}
salmon_quant$bioIvt_covid_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$bioIvt_ctrl_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$bioIvt_luad_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$panc1_intra_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$pittsburgh_ctrl_ucsc.rmsk.salmon <- 'NULL'

ucsc.rmsk.salmon_quant$bioIvt_covid_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$bioIvt_ctrl_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$bioIvt_luad_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$panc1_intra_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$pittsburgh_ctrl_ucsc.rmsk.salmon <- 'NULL'

process.aware.salmon_quant$bioIvt_covid_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$bioIvt_ctrl_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$bioIvt_luad_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$panc1_intra_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$pittsburgh_ctrl_ucsc.rmsk.salmon <- 'NULL'
```

## run_de_seq
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              run.de.seq,
              run.de.seq.individual)

salmon_quant$analysis_set$ctrl_panc_covid$deseq <- 
  run.de.seq(type = 'gxi', 
             input_se = salmon_quant$analysis_set$ctrl_panc_covid, 
             ref_type = 'salmon')

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq <- 
  run.de.seq(type = 'gxi', 
             input_se = ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid, 
             ref_type = 'ucsc.rmsk')


salmon_quant$analysis_set$panc_ctrl$deseq <- 
  run.de.seq.individual(input_se = salmon_quant$analysis_set$panc_ctrl,
                        type = 'gxi',
                        base_level = 'panc',
                        top_level = 'ctrl',
                        ref_type = 'salmon',
                        dds_formula = as.formula('~age+diabetes+condition'))

salmon_quant$analysis_set$covid_ctrl$deseq <- 
  run.de.seq.individual(input_se = salmon_quant$analysis_set$covid_ctrl,
                        type = 'gxi',
                        base_level = 'ctrl',
                        top_level = 'covid',
                        ref_type = 'salmon',
                        dds_formula = as.formula('~age+condition'))

ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq <- 
  run.de.seq.individual(input_se = ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl,
                        type = 'gxi',
                        base_level = 'panc',
                        top_level = 'ctrl',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = as.formula('~age+diabetes+condition'))

ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq <- 
  run.de.seq.individual(input_se = ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl,
                        type = 'gxi',
                        base_level = 'ctrl',
                        top_level = 'covid',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = as.formula('~age+condition'))
```

## run_pca
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              run.pca, extract.meta.pca.correlates)

salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca <-
  run.pca(input_de = salmon_quant$analysis_set$ctrl_panc_covid$deseq,
          identity_color_pal = identity_color_pal)

salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_corr_out.df <- 
  extract.meta.pca.correlates(pca.out =
                            salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_out.df)

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca <-
  run.pca(input_de = ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq,
          identity_color_pal = identity_color_pal)

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_corr_out.df <- 
  extract.meta.pca.correlates(pca.out =
                            ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_out.df)


te_only_deseq <- ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq


te_only_deseq$vst_counts.df <- 
  te_only_deseq$vst_counts.df[!rownames(te_only_deseq$vst_counts.df) %in% 
                                reference_meta_data$gencode_tx_to_gene.df$gene, ]

te_only_deseq$pca <-
  run.pca(input_de = te_only_deseq,
          identity_color_pal = identity_color_pal)

```

## run_fgsea
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              make.fgsea.ranks)

import::from(.from = 'msigdbr',
             msigdbr)

msig.df <- 
  msigdbr(species = 'Homo sapiens', category = 'H') %>% 
  dplyr::select(gene_symbol, gs_name) %>% 
  split(x = .$gene_symbol, f = .$gs_name)

salmon_quant$analysis_set$ctrl_panc_covid$deseq$fgsea$panc_v_ctrl <- 
  make.fgsea.ranks(de.seq = salmon_quant$analysis_set$panc_ctrl$deseq$de_out)

salmon_quant$analysis_set$ctrl_panc_covid$deseq$fgsea$covid_v_ctrl <- 
  make.fgsea.ranks(de.seq = salmon_quant$analysis_set$covid_ctrl$deseq$de_out)

```

## run_process_aware
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             generate.unsplice.data)

process.aware.salmon_quant$analysis_set$ctrl_panc_covid$unsplice_data.df <- 
  generate.unsplice.data(process.aware.salmon_quant$analysis_set$ctrl_panc_covid)
```

# Figures
# Fig_1
## Fig_1A
```{r 1A}
# save.manuscript.panel(figure = 1,
#                       figure.dir = figure.dir,
#                       name = 'pca_total_1A',
#                       width = figure_single_column_width,
#                       height = figure_depth/2,
#                       plot.in = salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_total.plt)

fig.1A_1.plt <- 
  salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_1v2.plt + labs(tag = 'B')
fig.1A_2.plt <- 
  salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_2v3.plt

```
## Fig_1B
```{r 1B}
salmon_quant$analysis_set$ctrl_panc_covid$quant_meta %>% 
  gather(var, value, -sample, -condition, -sex, -context) %>% 
  mutate(value = as.numeric(value),
         condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) -> tidy_quant_meta.df

meta_of_interest <- c('star_multimapped_percent',
                      'star_uniquely_mapped_percent')

tidy_quant_meta.df %>%  
  filter(var %in% meta_of_interest) %>% 
  mutate(var = sub('star_', '', var),
         var = factor(var, levels = c('uniquely_mapped_percent', 'multimapped_percent'))) %>% 
  ggplot(aes(condition, value, color = condition)) + 
  geom_boxplot(fill = NA, outlier.colour = NA, show.legend = F) + 
  geom_point(position = position_jitter(width = 0.2), size = rel(2), alpha = 1) +
  # scale_shape_manual(values = c(21,25)) +
  ylab('%') + xlab('') +
  ggforce::facet_col(~var, scales = 'free_y') + 
  scale_color_manual(values = identity_color_pal) + 
  theme(legend.position = 'right', legend.justification = 'center') +
  ggpubr::stat_compare_means(comparisons = list(c('panc', 'covid'),
                                                c('ctrl', 'covid'), 
                                                c('ctrl', 'panc')), 
                             method = 'wilcox', size = 2.5) -> mapping_rate_dist.plt

# save.manuscript.panel(figure = 1,
#                       figure.dir = figure.dir,
#                       name = 'mapping_rate_dist_1B',
#                       width = figure_single_column_width,
#                       height = figure_depth/2,
#                       plot.in = mapping_rate_dist.plt)

fig.1B.plt <- mapping_rate_dist.plt + labs(tag = 'C')
```
## Fig_1C
```{r 1C}

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$quant_meta %>% 
  gather(var, value, -sample, -condition, -sex, -context) %>% 
  mutate(value = as.numeric(value),
         condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  filter(var == 'salmon_percent_mapped') %>% 
  dplyr::rename('TE-aware' = value) %>% 
  merge(tidy_quant_meta.df %>% select(sample, var, value) %>% 
        filter(var == 'salmon_percent_mapped') %>% 
               dplyr::rename('gencode' = value) %>% 
          select(-var), by = 'sample') -> mapping_rate_compare.df

mapping_rate_compare.df %>% 
  gather(var, value, -sample, -context, -sex, -condition, -var) %>% 
  ggplot(aes(var, value, color = condition)) + 
  geom_boxplot(fill = NA, outlier.colour = NA, show.legend = F) + 
  geom_point(size = rel(2), alpha = 1) +
  geom_line(aes(group = sample), alpha = 0.2, show.legend = F) +
  # scale_shape_manual(values = c(21,25)) +
  ylab('salmon % mapped') + xlab('') + 
  ggforce::facet_row(~condition, scales = 'free_y') +
  scale_color_manual(values = identity_color_pal) + 
  ggpubr::stat_compare_means(comparisons = list(c('gencode', 'TE-aware')), 
                             method = 'wilcox', paired = T, size = 2.5) -> mapping_rate_compare.plt

fig.1C.plt <- mapping_rate_compare.plt + labs(tag = 'D')

```
### Fig_1_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)


fig_1_layout <- "
FF
AC
BC
DD
EE
"

wrap_plots(fig.1A_1.plt,
           fig.1A_2.plt,
           fig.1B.plt,
           guide_area(),
           fig.1C.plt,
           plot_spacer(),
           design = fig_1_layout, 
           guides = 'collect',
           heights = c(1,1,1,0.0625,1)) & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 1.25),
        legend.justification = c(0.5, 0.5)) -> fig.1.patchwork


fig.1.patchwork

save.manuscript.panel(figure = 1,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_1',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.1.patchwork)


```
# Fig_S1
## Fig_S1A
```{r S1A}
fig.S1A.plt <- 
  salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_3v4.plt
```
## Fig_S1B
```{r S1A}
salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_corr_out.df %>% 
  group_by(pc) %>% 
  mutate(pc = paste0('PC', pc)) %>% 
  filter(!grepl('num', var),
         ! var %in% c('input_vol', 'age')) %>% 
  top_n(7, wt = abs(cor)) %>% 
  dplyr::rename('gencode' = 'cor') -> salmon_pca_corr_top_7.df

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_corr_out.df %>% 
  group_by(pc) %>% 
  mutate(pc = paste0('PC', pc)) %>% 
  filter(var %in% salmon_pca_corr_top_7.df$var) %>% 
  dplyr::rename('TE-aware' = 'cor') -> ucsc.rmsk.salmon_pca_corr_compare.df

salmon_pca_corr_top_7.df %>% 
  merge(ucsc.rmsk.salmon_pca_corr_compare.df, by = c('pc', 'var')) %>% 
  gather(reference, cor, -pc, -var) %>% 
  ggplot(aes(reorder(var, -abs(cor)), abs(cor), fill = reference)) + 
  geom_col(color = 'white', position = position_dodge()) +
  coord_flip() + 
  ggforce::facet_col(~pc, scales = 'free_y') + 
  xlab('') + ylab('pearson coeff.') + 
  geom_hline(yintercept = c(0.5), linetype = 'dashed', alpha = 0.4) + 
  theme(legend.position = 'bottom', legend.justification = 'center') + 
  scale_fill_manual(values =RColorBrewer::brewer.pal(n = 3, 'Dark2')[1:2]) -> pca_correlation_top7.plt
  
  
  
fig.S1B.plt <- pca_correlation_top7.plt

# save.manuscript.panel(figure = 's1',
#                       figure.dir = figure.dir,
#                       name = 'pca_correlation_s1A',
#                       width = figure_single_column_width,
#                       height = figure_depth,
#                       plot.in = pca_correlation_top7.plt)
```
## Fig_S1C
```{r 1B}
tidy_quant_meta.df %>% 
  filter(var %in% c('age')) %>%  
  ggplot(aes(condition, value, color = condition)) + 
  geom_boxplot(fill = NA, outlier.colour = NA, show.legend = F) + 
  geom_point(size = rel(2), alpha = 1) +
  # scale_shape_manual(values = c(21,25)) +
  scale_color_manual(values = identity_color_pal) + 
  ylab('Age -- years') + xlab('') -> fig.S1C.plt
```
## Fig_S1D
```{r}
tidy_quant_meta.df %>% 
  filter(var %in% c('input_vol')) %>%  
  ggplot(aes(condition, value, color = condition)) + 
  geom_boxplot(fill = NA, outlier.colour = NA, show.legend = F) + 
  geom_point(size = rel(2), alpha = 1) +
  # scale_shape_manual(values = c(21,25)) +
  scale_color_manual(values = identity_color_pal) + 
  ylab('Input Volume -- mL') + xlab('') -> fig.S1D.plt

```
### Fig_S1_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)


fig_S1_layout <- "
AB
CB
DB
EB
"

wrap_plots(fig.S1A.plt,
           fig.S1B.plt,
           guide_area(),
           fig.S1C.plt,
           fig.S1D.plt,
           design = fig_S1_layout, 
           guides = 'collect',
           heights = c(1,0.25,1,1,1),
           widths = c(1,1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'left',
        legend.direction = 'horizontal',
        legend.title = element_text(vjust = 1.25),
        legend.justification = c(0.5, 0.5)) -> fig.S1.patchwork


fig.S1.patchwork

save.manuscript.panel(figure = 's1',
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_s1',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S1.patchwork)


```
# Fig_2
## Fig_2A
```{r}
import::from(.from = 'SummarizedExperiment',
             rowRanges)

rowRanges(ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$gxi) %>% 
  as.data.frame() %>% 
  filter(seqnames == 'chrM') %>% 
  select(group_name) %>% 
  unlist() %>% unname() -> chrM.filter.list

ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out %>% 
# ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$panc_vs_ctrl %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(!ensg %in% chrM.filter.list,
         !grepl('^MT', gene)) -> panc_annotated_rmsk_de

panc_label_list <- panc_annotated_rmsk_de %>% 
  top_n(3, wt = log2FoldChange)

panc_annotated_rmsk_de %>%
  filter(clade == 'gencode_coding') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) + 
  geom_point(size = 2, alpha = 0.6, show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt + 
  geom_point(data = filter(panc_annotated_rmsk_de, clade != 'gencode_coding') %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
             aes(log2FoldChange, -log10(padj), color = clade), size = 2, alpha = 0.8) +
  scale_color_manual(values = te_color_pal) + 
  ggrepel::geom_text_repel(data = panc_annotated_rmsk_de %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
                      aes(label = ifelse(gene %in% panc_label_list$gene, gene, '')), 
                           show.legend = F, color = 'black', max.overlaps = 1000) -> fig.2A.plt

fig.2A.plt

```
## Fig_2B
```{r}
ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out %>% 
# ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$covid_vs_ctrl %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(!ensg %in% chrM.filter.list,
         !grepl('^MT', gene)) -> covid_annotated_rmsk_de

covid_label_list <- covid_annotated_rmsk_de %>% 
  top_n(3, wt = log2FoldChange)

covid_annotated_rmsk_de %>%
  filter(clade == 'gencode_coding') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) + 
  geom_point(size = 2, alpha = 0.6, show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt + 
  geom_point(data = filter(covid_annotated_rmsk_de, clade != 'gencode_coding') %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
             aes(log2FoldChange, -log10(padj), color = clade), size = 2, alpha = 0.8) +
  scale_color_manual(values = te_color_pal) + 
  ggrepel::geom_text_repel(data = covid_annotated_rmsk_de %>% 
             mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
                    aes(label = ifelse(gene %in% covid_label_list$gene, gene, '')), 
                         show.legend = F, color = 'black', max.overlaps = 1000) + 
  xlim(-7.5,7.5) -> fig.2B.plt

fig.2B.plt
```
## Fig_2C
```{r}
ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$norm_counts.df %>% 
  rownames_to_column('gene') %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(gene %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(!gene %in% chrM.filter.list) -> total_annotated_rmsk_counts

total_annotated_rmsk_counts %>% 
  gather(sample, count, -gene, -clade, -family, -type) %>% 
  merge(ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$scaled_quant_meta_for_de.df %>%
          select(sample, condition), by = 'sample') -> tidy_total_annotated_rmsk_counts

tidy_total_annotated_rmsk_counts %>% 
  group_by(sample, condition, clade) %>% 
  summarize(clade_sum = sum(count)) %>% 
  mutate(clade_frac = clade_sum/sum(clade_sum),
         condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  ggplot(aes(sample, clade_frac, fill = clade)) + 
  geom_col(color = 'white', show.legend = F) + 
  scale_fill_manual(values = te_color_pal) + 
  ggforce::facet_row(~condition, scales = 'free_x') +
  theme(axis.text.x = element_blank()) + 
  xlab('sample') + ylab('norm. count fraction') -> fig.2C.plt


```
## Fig_2D
```{r}
unique(c(filter(ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out,
                abs(log2FoldChange) > 3.5)$ensg,
  filter(ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out,
         abs(log2FoldChange) > 1.5)$ensg)) -> de_ensg_names


ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$norm_counts.df %>% 
  rownames_to_column('ensg') %>% 
  filter(ensg %in% de_ensg_names,
         ensg %in% reference_meta_data$ucsc_rmsk_insert_info.df$gene) %>% 
  mutate_if(is.numeric, ~scale(log2(. + 1), center = T)) %>% 
  column_to_rownames('ensg') %>% as.matrix() %>% t() -> hm_count_data

hm_meta_data <- ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$scaled_quant_meta_for_de.df

left_hma <- ComplexHeatmap::rowAnnotation(df = hm_meta_data %>% select(condition), 
                                          col = list(condition = identity_color_pal), 
                                          show_annotation_name = F, simple_anno_size = unit(.3, "cm"))


reference_meta_data$ucsc_rmsk_insert_info.df %>% 
  filter(gene %in% colnames(hm_count_data)) %>% 
  select(gene, clade) %>% 
  mutate(clade = ifelse(clade %in% names(te_color_pal), clade, 'other')) %>% 
  column_to_rownames('gene') -> hm_te_data

hm_te_data <- hm_te_data[match(colnames(hm_count_data), rownames(hm_te_data)), , drop = F]

top_hma <- ComplexHeatmap::columnAnnotation(df = hm_te_data, 
                                            col = list(clade = te_color_pal), 
                                            show_annotation_name = T,
                                            annotation_name_side = 'left',
                                            annotation_name_gp = grid::gpar(fontsize = 10, fontface = 'italic'),
                                            show_legend = F, 
                                            simple_anno_size = unit(.375, "cm"))

set.seed(129)
ComplexHeatmap::Heatmap(hm_count_data, 
                        show_row_names = F, 
                        show_column_names = T, 
                        heatmap_width = figure_double_column_width * 0.85,
                        left_annotation = left_hma, 
                        column_dend_height = unit(.75, "cm"),
                        heatmap_legend_param = 
                          list(legend_gp = grid::gpar(fontsize = 8)),
                        # col = circlize::colorRamp2(breaks = c(-4,-2,0,2,4),
                        #                            colors = viridis::rocket(n = 5)),
                        top_annotation = top_hma,
                        column_names_gp = grid::gpar(fontsize = 8),
                        name = 'Z-score') -> fig.2D.chm
  
```
### Fig_2_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)


fig_2_layout <- "
AA
BC
DD
EE
"

wrap_plots(fig.2C.plt,
           fig.2A.plt + labs(title = 'panc'),
           fig.2B.plt + labs(title = 'covid'),
           guide_area(),
           patchwork::wrap_elements(full = grid::grid.grabExpr(ComplexHeatmap::draw(fig.2D.chm), 
                                                                width = figure_double_column_width)),
           design = fig_2_layout, 
           guides = 'collect',
           heights = c(0.75,0.75,0.0937,1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 0.5),
        legend.justification = c(0.5, 0.5)) -> fig.2.patchwork


# fig.2.patchwork

save.manuscript.panel(figure = 2,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_2',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.2.patchwork)


```
# Fig_S2
## Fig_S2A
```{r}
bind_rows(list('panc' = salmon_quant$analysis_set$ctrl_panc_covid$deseq$fgsea$panc_v_ctrl,
          'covid' = salmon_quant$analysis_set$ctrl_panc_covid$deseq$fgsea$covid_v_ctrl),
          .id = 'condition') %>% 
  select(condition, pathway, padj, NES) %>% 
  gridExtra::tableGrob(theme = gridExtra::ttheme_minimal()) -> fig.S2A.fgsea_table.grob

```
## Fig_S2B
```{r}
de_compare_list <- list('panc' = ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out,
                        'covid' = ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out)

purrr::imap(de_compare_list, function(de, de_name) {
  
  de %>% 
    filter(gene %in% msig.df$HALLMARK_MYC_TARGETS_V1,
           padj < 0.05,
           abs(log2FoldChange) > 0.5) %>% 
    mutate(id = de_name)
  
}) %>% bind_rows() -> de_upset.df

de_upset.df %>% 
  group_by(gene) %>% 
  summarize(context = list(id)) %>% 
  ggplot(aes(context)) + 
  geom_bar(fill = 'white', color = 'black') + 
  ggupset::scale_x_upset() +
  geom_text(stat='count', aes(label=after_stat(count)), nudge_y = -2) + 
  xlab('') + ylab('MYC Target V1 genes') -> fig.S2B.plt


de_upset.df %>% 
  group_by(id) %>% 
  top_n(5, wt = log2FoldChange) %>% 
  ggplot(aes(reorder(gene, -log2FoldChange), log2FoldChange)) + 
  geom_col(fill = NA, color = 'black') + 
  coord_flip() + 
  ggforce::facet_col(~id, scales = 'free_y') + 
  geom_hline(yintercept = 1.0, linetype = 'dashed', alpha = 0.6) + 
  xlab('')

de_upset.df %>% 
  select(gene, log2FoldChange, id) %>% 
  spread(id, log2FoldChange) %>% 
  ggplot(aes(covid, panc, label = gene)) + 
  geom_point() + 
  geom_hline(yintercept = 0, linetype = 'dashed', alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = 'dashed', alpha = 0.6) + 
  ggrepel::geom_text_repel() -> fig.S2B_2.plt

```

## Fig_S2C
```{r}
import::from(.from = 'SummarizedExperiment',
             rowRanges)

rowRanges(ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$gxi) %>% 
  as.data.frame() %>% 
  filter(seqnames == 'chrM') %>% 
  select(group_name) %>% 
  unlist() %>% unname() -> chrM.filter.list

ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out %>% 
# ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$panc_vs_ctrl %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(ensg %in% chrM.filter.list | grepl('^MT', gene)) -> mt_panc_annotated_rmsk_de

mt_panc_label_list <- mt_panc_annotated_rmsk_de %>% 
  top_n(6, wt = abs(log2FoldChange))

mt_panc_annotated_rmsk_de %>%
  filter(clade == 'gencode_coding') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) + 
  geom_point(size = 2, alpha = 0.6, show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt + 
  geom_point(data = filter(mt_panc_annotated_rmsk_de, clade != 'gencode_coding') %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
             aes(log2FoldChange, -log10(padj), color = clade), size = 2, alpha = 0.8) +
  scale_color_manual(values = te_color_pal) + 
  ggrepel::geom_text_repel(data = mt_panc_annotated_rmsk_de %>% 
             mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
                    aes(label = ifelse(gene %in% mt_panc_label_list$gene, gene, '')), 
                         show.legend = F, color = 'black', max.overlaps = 1000) + 
  xlim(-8.5,8.5) + 
  ggtitle('panc') -> fig.S2C.plt

fig.S2C.plt
```

## Fig_S2D
```{r}
ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(ensg %in% chrM.filter.list | grepl('^MT', gene)) -> mt_covid_annotated_rmsk_de

mt_covid_label_list <- mt_covid_annotated_rmsk_de %>% 
  top_n(6, wt = abs(log2FoldChange))

mt_covid_annotated_rmsk_de %>%
  filter(clade == 'gencode_coding') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) + 
  geom_point(size = 2, alpha = 0.6, show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt + 
  geom_point(data = filter(mt_covid_annotated_rmsk_de, clade != 'gencode_coding') %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
             aes(log2FoldChange, -log10(padj), color = clade), size = 2, alpha = 0.8) +
  scale_color_manual(values = te_color_pal) + 
  ggrepel::geom_text_repel(data = mt_covid_annotated_rmsk_de %>% 
             mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
                    aes(label = ifelse(gene %in% mt_covid_label_list$gene, gene, '')), 
                         show.legend = F, color = 'black', max.overlaps = 1000) + 
  xlim(-7.5,7.5) + 
  ggtitle('covid') -> fig.S2D.plt

fig.S2D.plt
```
### Fig_S2_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)


fig_S2_layout <- "
AA
BC
DD
EF
"

wrap_plots(patchwork::wrap_elements(fig.S2A.fgsea_table.grob, ignore_tag = F),
           fig.S2B.plt,
           fig.S2B_2.plt,
           guide_area(),
           fig.S2C.plt,
           fig.S2D.plt,
           design = fig_S2_layout, 
           guides = 'collect',
           heights = c(0.35,1,0.0937,1,1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 0.5),
        legend.justification = c(0.5, 0.5)) -> fig.S2.patchwork


fig.S2.patchwork

save.manuscript.panel(figure = 's2',
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S2',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S2.patchwork)


```

## compare_samples_w_nanopore
```{r}
panc.7.1.1_nanopore_tpm <- read_tsv(file.path(output_data.dir, 'nanopore', 'gencodev39', 'panc.7.1.1_gene_abundance.tsv'))
panc.6.1.1_nanopore_tpm <- read_tsv(file.path(output_data.dir, 'nanopore', 'gencodev39', 'panc.6.1.1_gene_abundance.tsv'))


input_set_dds_norm_counts.df[, 'panc.7.1.1', drop = F] %>% rownames_to_column('Gene ID') %>% 
  merge(panc.7.1.1_nanopore_tpm, by = 'Gene ID') %>% 
  dplyr::rename('nanopore_tpm' = TPM) %>% 
  mutate(illumina_tpm = panc.7.1.1*1e6/(sum(panc.7.1.1))) -> panc.7.1.1_seq_compare.df

input_set_dds_norm_counts.df[, 'panc.6.1.1', drop = F] %>% rownames_to_column('Gene ID') %>% 
  merge(panc.6.1.1_nanopore_tpm, by = 'Gene ID') %>% 
  dplyr::rename('nanopore_tpm' = TPM) %>% 
  mutate(illumina_tpm = panc.6.1.1*1e6/(sum(panc.6.1.1))) -> panc.6.1.1_seq_compare.df


panc.7.1.1_seq_compare.df %>% 
  filter(illumina_tpm > 1 & nanopore_tpm > 1) %>% 
  ggplot(aes(log2(illumina_tpm + 1), log2(nanopore_tpm + 1), label = `Gene ID`)) + 
  geom_point(alpha = 0.4)

panc.6.1.1_seq_compare.df %>% 
  filter(illumina_tpm > 1 & nanopore_tpm > 1) %>% 
  ggplot(aes(log2(illumina_tpm + 1), log2(nanopore_tpm + 1), label = `Gene ID`)) + 
  geom_point(alpha = 0.4) 


count_matrix.df[, 'panc.7.1.1', drop = F] %>% rownames_to_column('Gene ID') %>% 
  mutate(panc.7.1.1_tpm = panc.7.1.1*1e6/(sum(panc.7.1.1))) %>% 
  merge(panc.7.1.1_nanopore_tpm %>% select(`Gene ID`, TPM), by = 'Gene ID') %>% 
  dplyr::rename('panc.7.1.1_nanopore_tpm' = TPM) %>% 
  merge(count_matrix.df[, 'panc.6.1.1', drop = F] %>% rownames_to_column('Gene ID') %>% 
        mutate(panc.6.1.1_tpm = panc.6.1.1 *1e6/(sum(panc.6.1.1))) %>% 
            merge(panc.6.1.1_nanopore_tpm %>% select(`Gene ID`, TPM), by = 'Gene ID') %>% 
            dplyr::rename('panc.6.1.1_nanopore_tpm' = TPM), by = 'Gene ID') -> panc_compare.df

panc_compare.df %>% 
  # filter_if(is.numeric, ~. > 1) %>% 
  # ggplot(aes(log2(ctrl.10.0.4_tpm + 1), log2(panc.7.1.1_tpm + 1))) + 
  ggplot(aes(panc.6.1.1_tpm, panc.7.1.1_tpm)) + 
  geom_point(alpha = 0.4) -> plt.1

panc_compare.df %>% 
  # filter_if(is.numeric, ~. > 1) %>% 
  ggplot(aes(log2(panc.6.1.1_nanopore_tpm + 1), log2(panc.7.1.1_nanopore_tpm + 1))) + 
  geom_point(alpha = 0.4) -> plt.2

panc_compare.df %>% 
  # filter_if(is.numeric, ~. > 1) %>% 
  ggplot(aes(log2(panc.6.1.1_nanopore_tpm + 1), log2(ctrl.10.0.4_tpm + 1))) + 
  geom_point(alpha = 0.4) -> plt.3

panc_compare.df %>% 
  # filter_if(is.numeric, ~. > 1) %>% 
  ggplot(aes(log2(panc.7.1.1_nanopore_tpm + 1), log2(panc.7.1.1_tpm + 1))) + 
  geom_point(alpha = 0.4) -> plt.4

plt.1 + plt.3 / plt.4 + plt.2


```



# Figure_process_aware
```{r}
process.aware.salmon_quant$analysis_set$ctrl_panc_covid$unsplice_data.df %>% 
  merge(process.aware.salmon_quant$analysis_set$ctrl_panc_covid$quant_meta, by = 'sample') %>% 
  mutate(condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  ggplot(aes(condition, unsplice_rate, color = condition)) + 
  geom_boxplot(fill = NA, outlier.colour = NA) + 
  geom_point() + 
  scale_color_manual(values = identity_color_pal)


process.aware.salmon_quant$analysis_set$ctrl_panc_covid$unsplice_data.df %>% 
  merge(process.aware.salmon_quant$analysis_set$ctrl_panc_covid$quant_meta, by = 'sample') %>%
  mutate(condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  ggplot(aes(unsplice_rate, star_multimapped_percent, color = condition)) + 
  geom_point() + 
  ggforce::facet_col(~condition, scales = 'free_y') + 
  geom_smooth(method = 'lm', se = F) + 
  scale_color_manual(values = identity_color_pal)



```

