---
title: "exRNA_disease_biomarkers_nb"
output: html_notebook
author:
- name: "Roman E. Reggiardo"
  affiliation: "UC Santa Cruz Dept. of Biomolecular Engineering"
  email: "rreggiar@ucsc.edu"
editor_options: 
  chunk_output_type: console
---
# nb_setup
```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, collapse = T)
knitr::opts_chunk$set(message = F)
# here::set_here('/home/rreggiar/')
here::here()
suppressPackageStartupMessages(library(tidyverse))
```

# global_init
## ggplot_theme
```{r}
library(ggplot2)
library(ggthemes)
base_size = 10

ggplot2::theme_set(ggthemes::theme_foundation(base_size = base_size,
                                              base_family = 'Helvetica') + 
                     theme(plot.title = element_text(size = base_size, face = 'bold'),
                           panel.background = element_rect(colour = NA),
                           plot.background = element_rect(colour = NA),
                           panel.border = element_rect(colour = NA), 
                           axis.line = element_line(), 
                           axis.line.x = NULL, 
                           axis.line.y = NULL, 
                           axis.text = element_text(size = rel(0.95)), 
                           axis.text.x = element_text(margin = 
                                                        margin(t = 0.8 * base_size/4)), 
                           axis.text.x.top = element_text(margin = 
                                                            margin(b = 0.8 * base_size/4), 
                                                          vjust = 0), 
                           axis.text.y = element_text(margin = 
                                                        margin(r = 0.5 * base_size/4), 
                                                      hjust = 1),
                           axis.text.y.right = element_text(margin = 
                                                              margin(l = 0.5 * base_size/4), 
                                                            hjust = 0), 
                           axis.ticks = element_line(), 
                           axis.ticks.length = unit(base_size/2.5, "pt"), axis.ticks.length.x = NULL, 
                           axis.ticks.length.x.top = NULL, axis.ticks.length.x.bottom = NULL, 
                           axis.ticks.length.y = NULL, axis.ticks.length.y.left = NULL, 
                           axis.ticks.length.y.right = NULL,
                           strip.text = element_text(size = rel(0.8), face = 'bold'),
                           strip.background = element_blank(),
                           legend.key.size= unit(0.08, "in"),
                           legend.spacing = unit(0, "in"),
                           legend.key = element_rect(colour = NA),
                           legend.title = element_text(face="italic"),
                           legend.text = element_text(face = 'bold'),
                           legend.justification = c("right", "top"),
                           legend.box.just = "right",
                           legend.margin = margin(6, 6, 6, 6),
                           plot.tag = element_text(size = base_size, face = 'bold'),
                           plot.margin=margin(0.04,
                                              0.04,
                                              0.04,
                                              0.04,
                                              unit = "in"),
                           legend.box.spacing = unit(-0.02, 'in'),
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank()
                           )
                   )

txt.mm_to_pts <- function(ratio){ base_size * ratio * (25.4 / 72.27) }
```

## data_path_obj
```{r}
figure.dir <- here::here('manuscript/figures')
input_data.dir <- here::here('data/input_data')
output_data.dir <- here::here('data/output_data')
qc_data.dir <- here::here('data/output_data/rna_qc')
meta_data.dir <- here::here('data/meta_data')
reference.dir <- here::here('reference')
r_code.dir <- here::here('R')
```

## figure_export
```{r}
figure_single_column_width = unit(89, 'mm')
figure_double_column_width = unit(183, 'mm')
figure_depth = unit(247, 'mm')
panel_height_1 = unit(247/3, 'mm')

# install.packages("import")

import::from(.directory = r_code.dir, .from = 'helper_analysisFunctions.R', save.manuscript.panel)
```

## analysis_const
```{r}
chr_order <- c('chr1', 'chr2', 'chr3', 
               'chr4', 'chr5', 'chr6', 
               'chr7', 'chr8', 'chr9',
               'chr10', 'chr11', 'chr12', 
               'chr13', 'chr14', 'chr15', 
               'chr16', 'chr17',
               'chr18', 'chr19', 'chr20', 
               'chr21', 'chr22', 'chrX', 'chrY')

qc_fails <- c('panc.6.2.5', 'panc.7.2.5', 'panc.9.2.5', 
              'panc.10.2.5', 'covid.427.0.80', 'covid.381.0.80')


gencode_ver <- 39

three_color_pal <- RColorBrewer::brewer.pal(n = 3, 'Dark2')
eight_color_pal <- RColorBrewer::brewer.pal(n = 8, 'Dark2')
viridis_three_color_pal <- viridisLite::plasma(20)[c(1,9,16)]


identity_color_pal <- c('ctrl' = viridis_three_color_pal[[1]],
                        'panc' = viridis_three_color_pal[[2]],
                        'covid' = viridis_three_color_pal[[3]])

te_aware_annotation_levels <- c('gencode_coding',
                                 'gencode_lncRNA',
                                 'LINE',
                                 'SINE',
                                 'LTR',
                                 'DNA',
                                 'Simple_repeat',
                                 'other')

te_color_pal <- c('grey', RColorBrewer::brewer.pal(n = 7, 'Dark2'))
names(te_color_pal) <- te_aware_annotation_levels

te_alone_annotation_levels <- c('LINE',
                                'SINE',
                                'LTR',
                                'DNA',
                                'Simple_repeat',
                                'rRNA',
                                'tRNA')
te_alone_color_pal <- RColorBrewer::brewer.pal(n = 8, 'Dark2')[2:8]
names(te_alone_color_pal) <- te_alone_annotation_levels



```

## meta_data_construction
```{r}

## reference meta data
if (! file.exists(file.path(meta_data.dir, 'reference_meta_data_df.rds'))) {
  
  reference_meta_data <- tibble::lst()
  
  reference_meta_data$ucsc_rmsk_insert_info.df <- 
    readr::read_tsv(file.path(reference.dir, 'ucsc.rmsk.insert.info.txt'),
             col_names = c('gene', 'clade', 'family'))
  
  reference_meta_data$gencode_tx_to_gene.df <- 
    readr::read_csv(file.path(reference.dir, 
                              paste0('gencode.v', gencode_ver, '.tx.to.gene.csv')),
                    col_names = c('tx', 'gene')) %>% 
    tidyr::separate(tx, sep = '\\|', 
                    into = c('enst','ensg',NA,NA,'tx','gene','len','biotype'))
  
  reference_meta_data$gencode_tx_to_gene.df %>% 
    dplyr::select(-enst) %>% 
    dplyr::group_by(biotype) %>% 
    dplyr::tally() -> reference_meta_data$gencode_biotype_count.df
  
  reference_meta_data$gencode_tx_to_gene.df %>% 
    dplyr::select(ensg,biotype) %>% 
    dplyr::group_by(ensg) %>% 
    dplyr::filter(all(biotype == 'lncRNA')) %>% 
    dplyr::distinct() -> reference_meta_data$gencode_lncRNA_gene_names.df
  
  reference_meta_data$ucsc_rmsk_tx_to_gene.df <-  
    readr::read_csv(file.path(reference.dir, 
                              'ucsc.rmsk.insert.analysis.tx.to.gene.csv'),
                    col_names = c('insert', 'info', 'gene', 'len', 'biotype')) %>% 
    mutate(enst = insert, ensg = gene, tx = insert) %>% 
    select(enst, ensg, tx, gene, len, biotype, -insert, -info)
  
  reference_meta_data$total_tx_to_gene.df <- 
    rbind(reference_meta_data$gencode_tx_to_gene.df,
          reference_meta_data$ucsc_rmsk_tx_to_gene.df)
  
  saveRDS(reference_meta_data, file.path(meta_data.dir, 'reference_meta_data_df.rds'))
  
} else {
  reference_meta_data <- readRDS(file.path(meta_data.dir, 'reference_meta_data_df.rds'))
}

## sample_meta_data
if (! file.exists(file.path(meta_data.dir, 'sample_meta_data_df.rds'))) {
  
  list.files(meta_data.dir, pattern = '*_meta_data.csv') -> meta_file.list
  names(meta_file.list) <- meta_file.list
  
  meta_file.list %>% 
    purrr::imap(function(name, file) {
      readr::read_csv(file.path(meta_data.dir, file))
    }) -> sample_meta_data
  
  saveRDS(sample_meta_data, file.path(meta_data.dir, 'sample_meta_data_df.rds'))
  
} else {
  sample_meta_data <- readRDS(file.path(meta_data.dir, 'sample_meta_data_df.rds'))
}

```

# import_data
## load_tximeta_obj
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             load.tximeta.object.list,
             parse.tximeta.quant.metadata)

salmon_quant <- load.tximeta.object.list('salmon', 
                                         output_data.dir = output_data.dir)

salmon_quant <- parse.tximeta.quant.metadata(salmon_quant)


ucsc.rmsk.salmon_quant <- load.tximeta.object.list('ucsc.rmsk.salmon', 
                                                   output_data.dir = output_data.dir)


ucsc.rmsk.salmon_quant <- parse.tximeta.quant.metadata(ucsc.rmsk.salmon_quant)


process.aware.salmon_quant <- load.tximeta.object.list('process.aware.salmon', 
                                                       output_data.dir = output_data.dir)

process.aware.salmon_quant <- parse.tximeta.quant.metadata(process.aware.salmon_quant)
```

# analysis_INTERACTIVE
## QC_filter
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             subset.tximeta.se)

salmon_quant$bioIvt_panc_salmon <- 
  subset.tximeta.se(salmon_quant$bioIvt_panc_salmon, 
                    filter_list = qc_fails)

ucsc.rmsk.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 
  subset.tximeta.se(ucsc.rmsk.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon, 
                    filter_list = qc_fails)

process.aware.salmon_quant$bioIvt_panc_process.aware.salmon <- 
  subset.tximeta.se(process.aware.salmon_quant$bioIvt_panc_process.aware.salmon, 
                    filter_list = qc_fails)

##

salmon_quant$bioIvt_covid_salmon <- 
  subset.tximeta.se(salmon_quant$bioIvt_covid_salmon, 
                    filter_list = qc_fails)

ucsc.rmsk.salmon_quant$bioIvt_covid_ucsc.rmsk.salmon <- 
  subset.tximeta.se(ucsc.rmsk.salmon_quant$bioIvt_covid_ucsc.rmsk.salmon, 
                    filter_list = qc_fails)

process.aware.salmon_quant$bioIvt_covid_process.aware.salmon <- 
  subset.tximeta.se(process.aware.salmon_quant$bioIvt_covid_process.aware.salmon, 
                    filter_list = qc_fails)
```

## construct_analysis_sets
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             build.analysis.set)
##
salmon_quant$analysis_set$panc_ctrl <- 
  build.analysis.set(se_list = salmon_quant, 
                     se_1 = 'bioIvt_panc_salmon', 
                     se_2 = 'pittsburgh_ctrl_salmon',
                     sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)

salmon_quant$analysis_set$covid_ctrl <- 
  build.analysis.set(se_list = salmon_quant, 
                     se_1 = 'bioIvt_covid_salmon', 
                     se_2 = 'pittsburgh_ctrl_salmon',
                     sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)

salmon_quant$analysis_set$ctrl_panc_covid <- 
  build.analysis.set(se_list = salmon_quant, 
                     se_1 = 'bioIvt_panc_salmon', 
                     analysis_set_2 = salmon_quant$analysis_set$covid_ctrl,
                     sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
##
ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl <- 
    build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
                       se_1 = 'bioIvt_panc_ucsc.rmsk.salmon', 
                       se_2 = 'pittsburgh_ctrl_ucsc.rmsk.salmon',
                       sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)

ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl <- 
    build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
                       se_1 = 'bioIvt_covid_ucsc.rmsk.salmon', 
                       se_2 = 'pittsburgh_ctrl_ucsc.rmsk.salmon',
                       sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid <- 
    build.analysis.set(se_list = ucsc.rmsk.salmon_quant, 
                       se_1 = 'bioIvt_panc_ucsc.rmsk.salmon', 
                       analysis_set_2 = ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl,
                       sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
##
process.aware.salmon_quant$analysis_set$panc_ctrl <- 
    build.analysis.set(se_list = process.aware.salmon_quant, 
                       se_1 = 'bioIvt_panc_process.aware.salmon', 
                       se_2 = 'pittsburgh_ctrl_process.aware.salmon',
                       sample_meta_in = sample_meta_data$`2022.01.14_bioIVTAndPitts_meta_data.csv`)

process.aware.salmon_quant$analysis_set$covid_ctrl <- 
    build.analysis.set(se_list = process.aware.salmon_quant, 
                       se_1 = 'bioIvt_covid_process.aware.salmon', 
                       se_2 = 'pittsburgh_ctrl_process.aware.salmon',
                       sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)

process.aware.salmon_quant$analysis_set$ctrl_panc_covid <- 
    build.analysis.set(se_list = process.aware.salmon_quant, 
                       se_1 = 'bioIvt_panc_process.aware.salmon', 
                       analysis_set_2 = process.aware.salmon_quant$analysis_set$covid_ctrl,
                       sample_meta_in = sample_meta_data$`2022.01.14_combined_meta_data.csv`)
```

## save memory
```{r}
salmon_quant$bioIvt_covid_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$bioIvt_ctrl_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$bioIvt_luad_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$panc1_intra_ucsc.rmsk.salmon <- 'NULL'
salmon_quant$pittsburgh_ctrl_ucsc.rmsk.salmon <- 'NULL'

ucsc.rmsk.salmon_quant$bioIvt_covid_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$bioIvt_ctrl_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$bioIvt_luad_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$panc1_intra_ucsc.rmsk.salmon <- 'NULL'
ucsc.rmsk.salmon_quant$pittsburgh_ctrl_ucsc.rmsk.salmon <- 'NULL'

process.aware.salmon_quant$bioIvt_covid_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$bioIvt_panc_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$bioIvt_ctrl_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$bioIvt_luad_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$panc1_intra_ucsc.rmsk.salmon <- 'NULL'
process.aware.salmon_quant$pittsburgh_ctrl_ucsc.rmsk.salmon <- 'NULL'
```

## run_de_seq
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              run.de.seq,
              run.de.seq.individual)

salmon_quant$analysis_set$ctrl_panc_covid$deseq <- 
  run.de.seq(type = 'gxi', 
             input_se = salmon_quant$analysis_set$ctrl_panc_covid, 
             ref_type = 'salmon')

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq <- 
  run.de.seq(type = 'gxi', 
             input_se = ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid, 
             ref_type = 'ucsc.rmsk')


salmon_quant$analysis_set$panc_ctrl$deseq <- 
  run.de.seq.individual(input_se = salmon_quant$analysis_set$panc_ctrl,
                        type = 'gxi',
                        base_level = 'panc',
                        top_level = 'ctrl',
                        ref_type = 'salmon',
                        dds_formula = as.formula('~age+diabetes+condition'))

salmon_quant$analysis_set$covid_ctrl$deseq <- 
  run.de.seq.individual(input_se = salmon_quant$analysis_set$covid_ctrl,
                        type = 'gxi',
                        base_level = 'ctrl',
                        top_level = 'covid',
                        ref_type = 'salmon',
                        dds_formula = as.formula('~age+condition'))

ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq <- 
  run.de.seq.individual(input_se = ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl,
                        type = 'gxi',
                        base_level = 'panc',
                        top_level = 'ctrl',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = as.formula('~age+diabetes+condition'))

ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq <- 
  run.de.seq.individual(input_se = ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl,
                        type = 'gxi',
                        base_level = 'ctrl',
                        top_level = 'covid',
                        ref_type = 'ucsc.rmsk',
                        dds_formula = as.formula('~age+condition'))


SummarizedExperiment::assay(process.aware.salmon_quant$analysis_set$panc_ctrl$gxi.split, 'unspliced')

SummarizedExperiment::rowRanges(process.aware.salmon_quant$analysis_set$panc_ctrl$gxi)

reference_meta_data$process_aware_tx_to_gene <-   
  SummarizedExperiment::rowRanges(process.aware.salmon_quant$analysis_set$panc_ctrl$gxi) %>% 
    as.data.frame() %>% 
    select(gene_id) %>% 
    separate(gene_id, sep = '-', into = c('gene_id', 'intron')) %>% 
    mutate(intron = ifelse(is.na(intron), 'E', intron)) %>% 
    merge(reference_meta_data$gencode_tx_to_gene.df, by.x = 'gene_id', by.y = 'ensg') %>% 
    mutate(gene_id = ifelse(intron == 'I', paste0(gene_id, '-I'), gene_id)) %>% 
    select(-intron) %>% 
    dplyr::rename('ensg' = 'gene_id') %>% 
    distinct()


process.aware.salmon_quant$analysis_set$panc_ctrl$deseq <- 
  run.de.seq.individual(input_se = process.aware.salmon_quant$analysis_set$panc_ctrl, 
                        type = 'gxi.split',
                        base_level = 'panc',
                        top_level = 'ctrl',
                        ref_type = 'process.aware',
                        dds_formula = as.formula('~age+diabetes+condition'))

process.aware.salmon_quant$analysis_set$covid_ctrl$deseq <- 
  run.de.seq.individual(input_se = process.aware.salmon_quant$analysis_set$covid_ctrl,
                        type = 'gxi.split',
                        base_level = 'ctrl',
                        top_level = 'covid',
                        ref_type = 'process.aware',
                        dds_formula = as.formula('~age+condition'))




process.aware.salmon_quant$analysis_set$panc_ctrl$deseq$de_out %>% 
  filter(grepl('-I', ensg))
```

## run_pca
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              run.pca, extract.meta.pca.correlates)

salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca <-
  run.pca(input_de = salmon_quant$analysis_set$ctrl_panc_covid$deseq,
          identity_color_pal = identity_color_pal)

salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_corr_out.df <- 
  extract.meta.pca.correlates(pca.out =
                            salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_out.df)

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca <-
  run.pca(input_de = ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq,
          identity_color_pal = identity_color_pal)

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_corr_out.df <- 
  extract.meta.pca.correlates(pca.out =
                            ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_out.df)


te_only_deseq <- ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq


te_only_deseq$vst_counts.df <- 
  te_only_deseq$vst_counts.df[!rownames(te_only_deseq$vst_counts.df) %in% 
                                reference_meta_data$gencode_tx_to_gene.df$gene, ]

te_only_deseq$pca <-
  run.pca(input_de = te_only_deseq,
          identity_color_pal = identity_color_pal)

```

## run_fgsea
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
              make.fgsea.ranks)

import::from(.from = 'msigdbr',
             msigdbr)

msig.df <- 
  msigdbr(species = 'Homo sapiens', category = 'H') %>% 
  dplyr::select(gene_symbol, gs_name) %>% 
  split(x = .$gene_symbol, f = .$gs_name)

salmon_quant$analysis_set$ctrl_panc_covid$deseq$fgsea$panc_v_ctrl <- 
  make.fgsea.ranks(de.seq = salmon_quant$analysis_set$panc_ctrl$deseq$de_out)

salmon_quant$analysis_set$ctrl_panc_covid$deseq$fgsea$covid_v_ctrl <- 
  make.fgsea.ranks(de.seq = salmon_quant$analysis_set$covid_ctrl$deseq$de_out)

```

## run_process_aware
```{r}
import::from(.directory = r_code.dir, 
             .from = 'helper_analysisFunctions.R', 
             generate.unsplice.data)

process.aware.salmon_quant$analysis_set$ctrl_panc_covid$unsplice_data.df <- 
  generate.unsplice.data(process.aware.salmon_quant$analysis_set$ctrl_panc_covid)
```

# Figures
# Fig_1
## Fig_flowchart
```{r}
flow_chart.plt <- magick::image_read_pdf(path = file.path(figure.dir, 'fig.1', 'ip_flowchart_tiny.pdf'))

```
## Fig_1A
```{r 1A}



fig.1A_1.plt <- 
  salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_1v2.plt +
  annotate(geom = 'text', x = -175, y = -100, label = 'TE-aware', size = txt.mm_to_pts(1.25)) +
  labs(tag = 'B') + coord_flip() 
  
fig.1A_2.plt <- 
  salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_2v3.plt +
  xlim(layer_scales(fig.1A_1.plt)$y$range$range) 



# + 
#   annotate(geom = 'text', x = -105, y = -200, label = 'TE-aware', size = txt.mm_to_pts(1.5))

```
## Fig_1B
```{r 1B}
salmon_quant$analysis_set$ctrl_panc_covid$quant_meta %>% 
  gather(var, value, -sample, -condition, -sex, -context) %>% 
  mutate(value = as.numeric(value),
         condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) -> tidy_quant_meta.df

meta_of_interest <- c('star_multimapped_percent',
                      'star_uniquely_mapped_percent')

tidy_quant_meta.df %>%  
  filter(var %in% meta_of_interest) %>% 
  mutate(var = sub('star_', '', var),
         var = case_when(var == 'uniquely_mapped_percent' ~ 'uniquely-mapped', 
                         var == 'multimapped_percent' ~ 'multi-mapped'),
         var = factor(var, levels = c('uniquely-mapped', 'multi-mapped'))) %>% 
  ggplot(aes(condition, value, color = condition)) + 
  geom_boxplot(fill = NA, outlier.colour = NA, show.legend = F) + 
  geom_point(position = position_jitter(width = 0.2), size = rel(2), alpha = 1) +
  # scale_shape_manual(values = c(21,25)) +
  ylab('percent mapped') + xlab('') +
  ggforce::facet_row(~var, scales = 'free_y') + 
  scale_color_manual(values = identity_color_pal) + 
  theme(legend.position = 'right', legend.justification = 'center') +
  ggpubr::stat_compare_means(comparisons = list(c('panc', 'covid'),
                                                c('ctrl', 'covid'), 
                                                c('ctrl', 'panc')), 
                             method = 'wilcox', size = 2.5, method.args = list(exact =T)) -> mapping_rate_dist.plt

# save.manuscript.panel(figure = 1,
#                       figure.dir = figure.dir,
#                       name = 'mapping_rate_dist_1B',
#                       width = figure_single_column_width,
#                       height = figure_depth/2,
#                       plot.in = mapping_rate_dist.plt)

fig.1B.plt <- mapping_rate_dist.plt + labs(tag = 'C')
```
## Fig_1C
```{r 1C}

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$quant_meta %>% 
  gather(var, value, -sample, -condition, -sex, -context) %>% 
  mutate(value = as.numeric(value),
         condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  filter(var == 'salmon_percent_mapped') %>% 
  dplyr::rename('TE-aware' = value) %>% 
  merge(tidy_quant_meta.df %>% select(sample, var, value) %>% 
        filter(var == 'salmon_percent_mapped') %>% 
               dplyr::rename('gencode' = value) %>% 
          select(-var), by = 'sample') -> mapping_rate_compare.df

mapping_rate_compare.df %>% 
  gather(var, value, -sample, -context, -sex, -condition, -var) %>% 
  # filter(condition == 'panc') %>% 
  ggplot(aes(var, value, color = condition)) + 
  geom_boxplot(fill = NA, outlier.colour = NA, show.legend = F) + 
  geom_point(size = rel(2), alpha = 1) +
  geom_line(aes(group = sample), alpha = 0.2, show.legend = F) +
  # scale_shape_manual(values = c(21,25)) +
  ylab('% mapped') + xlab('') + 
  ggforce::facet_row(~condition, strip.position = 'bottom') +
  scale_color_manual(values = identity_color_pal) + 
  ggpubr::stat_compare_means(comparisons = list(c('gencode', 'TE-aware')), 
                             method = 'wilcox', size = 2.5, 
                             method.args = list(exact = TRUE, paired = T)) -> mapping_rate_compare.plt

fig.1C.plt <- mapping_rate_compare.plt + labs(tag = 'D')

```
### Fig_1_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


fig_1_layout <- "
FA
FB
DD
CC
EE
"

wrap_plots(fig.1A_1.plt + theme(axis.title.x = element_blank()),
           fig.1A_2.plt,
           fig.1B.plt + coord_cartesian(clip = 'off'),
           guide_area(),
           fig.1C.plt + coord_cartesian(clip = 'off'),
           wrap_elements(full = magick::image_ggplot(flow_chart.plt)) + labs(tag = 'A'),
           design = fig_1_layout, 
           guides = 'collect',
           heights = c(0.75,0.75,0.0825,1,1)) & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 1.25),
        legend.justification = c(0.5, 0.5)) -> fig.1.patchwork


save.manuscript.panel(figure = 1,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_1',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.1.patchwork)


```

# Fig_S1
## Fig_S1A
```{r S1A}
fig.S1A.plt <- 
  salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_3v4.plt
```
## Fig_S1B
```{r S1A}
salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_corr_out.df %>% 
  group_by(pc) %>% 
  mutate(pc = paste0('PC', pc)) %>% 
  filter(!grepl('num', var),
         ! var %in% c('input_vol', 'age'),
         grepl('map', var), grepl('percent', var)) %>% 
  top_n(7, wt = abs(cor)) %>% 
  mutate(var = ifelse(var == 'salmon_percent_mapped', 'salmon_mapped_percent', var)) %>% 
  dplyr::rename('gencode' = 'cor') -> salmon_pca_corr_top_7.df

ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$pca$pca_corr_out.df %>% 
  group_by(pc) %>% 
  mutate(pc = paste0('PC', pc)) %>%
  # filter(var %in% salmon_pca_corr_top_7.df$var) %>% 
  mutate(var = ifelse(var == 'salmon_percent_mapped', 'salmon_mapped_percent', var)) %>% 
  dplyr::rename('TE-aware' = 'cor') -> ucsc.rmsk.salmon_pca_corr_compare.df

salmon_pca_corr_top_7.df %>% 
  merge(ucsc.rmsk.salmon_pca_corr_compare.df, by = c('pc', 'var')) %>% 
  gather(reference, cor, -pc, -var) %>% 
  ggplot(aes(reorder(var, -abs(cor)), abs(cor), fill = reference)) + 
  geom_col(color = 'white', position = position_dodge()) +
  coord_flip() + 
  ggforce::facet_row(~pc) + 
  xlab('') + ylab('pearson coeff.') + 
  geom_hline(yintercept = c(0.5), linetype = 'dashed', alpha = 0.4) + 
  theme(legend.position = 'bottom', legend.justification = 'center') + 
  scale_fill_manual(values =RColorBrewer::brewer.pal(n = 8, 'Dark2')[8:3]) -> pca_correlation_top7.plt
  
  
  
fig.S1B.plt <- pca_correlation_top7.plt

# save.manuscript.panel(figure = 's1',
#                       figure.dir = figure.dir,
#                       name = 'pca_correlation_s1A',
#                       width = figure_single_column_width,
#                       height = figure_depth,
#                       plot.in = pca_correlation_top7.plt)
```
## Fig_S1C
```{r 1B}
# tidy_quant_meta.df %>% 
#   filter(var %in% c('age')) %>%  
#   ggplot(aes(condition, value, color = condition)) + 
#   geom_boxplot(fill = NA, outlier.colour = NA, show.legend = F) + 
#   geom_point(size = rel(2), alpha = 1) +
#   # scale_shape_manual(values = c(21,25)) +
#   scale_color_manual(values = identity_color_pal) + 
#   ylab('Age -- years') + xlab('') -> fig.S1C.plt
# 
# tidy_quant_meta.df %>% 
#   filter(var %in% c('input_vol')) %>%  
#   ggplot(aes(condition, value, color = condition)) + 
#   geom_boxplot(fill = NA, outlier.colour = NA, show.legend = F) + 
#   geom_point(size = rel(2), alpha = 1) +
#   # scale_shape_manual(values = c(21,25)) +
#   scale_color_manual(values = identity_color_pal) + 
#   ylab('Input Volume -- mL') + xlab('') -> fig.S1D.plt

salmon_quant$analysis_set$ctrl_panc_covid$quant_meta %>% 
  gather(var, value, -sample, -condition, -sex, -context) %>% 
  mutate(value = as.numeric(value),
         condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  filter(var %in% c('age', 'input_vol')) %>% 
  spread(var, value) %>% 
  filter(! sample %in% qc_fails) %>% 
  gridExtra::tableGrob(theme = gridExtra::ttheme_minimal(base_size = 8,
                                                         core = list(padding=unit(c(1, 1.25), "mm"))), 
                       rows = NULL) ->
  fig.S1C.meta_table.grob

```
### Fig_S1_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)


fig_S1_layout <- "
AA
BB
"

wrap_plots(fig.S1B.plt,
           patchwork::wrap_elements(fig.S1C.meta_table.grob, ignore_tag = F),
           design = fig_S1_layout, 
           widths = c(1,1)) + plot_annotation(tag_levels = 'A') -> fig.S1.patchwork

save.manuscript.panel(figure = 's1',
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_s1',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S1.patchwork)


```

# Fig_2
## Fig_2A
```{r}
import::from(.from = 'SummarizedExperiment',
             rowRanges)

rowRanges(ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$gxi) %>% 
  as.data.frame() %>% 
  filter(seqnames == 'chrM') %>% 
  select(group_name) %>% 
  unlist() %>% unname() -> chrM.filter.list

ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(!ensg %in% chrM.filter.list,
         !grepl('^MT', gene)) -> panc_annotated_rmsk_de

panc_label_list <- panc_annotated_rmsk_de %>% 
  filter(grepl('LTR|Alu', gene)) %>% 
  top_n(6, wt = log2FoldChange)

panc_label_list_dn <- panc_annotated_rmsk_de %>% 
  filter(grepl('LTR|Alu', gene)) %>% 
  top_n(3, wt = -log2FoldChange)

panc_label_lnc_list_dn <- panc_annotated_rmsk_de %>% 
  filter(clade == 'gencode_lncRNA',
         !grepl('^ENSG', gene)) %>% 
  top_n(3, wt = -log2FoldChange)

panc_label_list <- rbind(panc_label_list, panc_label_list_dn, panc_label_lnc_list_dn)

panc_annotated_rmsk_de %>%
  filter(clade == 'gencode_coding') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) + 
  geom_point(size = 2, alpha = 0.6, show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt + 
  geom_point(data = filter(panc_annotated_rmsk_de, clade != 'gencode_coding') %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
             aes(log2FoldChange, -log10(padj), color = clade), size = 2, alpha = 0.8) +
  scale_color_manual(values = te_color_pal, name = 'biotype/clade') + 
  ggrepel::geom_text_repel(data = panc_annotated_rmsk_de %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
                      aes(label = ifelse(gene %in% panc_label_list$gene, gene, '')), 
                           show.legend = F, color = 'black', 
               max.overlaps = 100, box.padding = unit(4.5, 'mm'), segment.colour = 'grey') -> fig.2A.plt

fig.2A.plt

```
## Fig_2B
```{r}
ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out %>% 
# ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$covid_vs_ctrl %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(!ensg %in% chrM.filter.list,
         !grepl('^MT', gene)) -> covid_annotated_rmsk_de

covid_label_list <- covid_annotated_rmsk_de %>% 
  top_n(3, wt = log2FoldChange)

covid_label_lnc_list_dn <- covid_annotated_rmsk_de %>% 
  filter(clade == 'gencode_lncRNA',
         !grepl('^ENSG', gene)) %>% 
  top_n(3, wt = -log2FoldChange)

covid_label_list <- rbind(covid_label_list, covid_label_lnc_list_dn)

covid_annotated_rmsk_de %>%
  filter(clade == 'gencode_coding') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) + 
  geom_point(size = 2, alpha = 0.6, show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt + 
  geom_point(data = filter(covid_annotated_rmsk_de, clade != 'gencode_coding') %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
             aes(log2FoldChange, -log10(padj), color = clade), size = 2, alpha = 0.8) +
  scale_color_manual(values = te_color_pal, name = 'biotype/clade') + 
  ggrepel::geom_text_repel(data = covid_annotated_rmsk_de %>% 
             mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
                    aes(label = ifelse(gene %in% covid_label_list$gene, gene, '')), 
                         show.legend = F, color = 'black', max.overlaps = 1000) + 
  xlim(-7.5,7.5) -> fig.2B.plt

fig.2B.plt
```
## Fig_2C
```{r}
ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$norm_counts.df %>% 
  rownames_to_column('gene') %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(gene %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(!gene %in% chrM.filter.list) -> total_annotated_rmsk_counts

total_annotated_rmsk_counts %>% 
  gather(sample, count, -gene, -clade, -family, -type) %>% 
  merge(ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$scaled_quant_meta_for_de.df %>%
          select(sample, condition), by = 'sample') -> tidy_total_annotated_rmsk_counts

tidy_total_annotated_rmsk_counts %>% 
  group_by(sample, condition, clade) %>% 
  summarize(clade_sum = sum(count)) %>% 
  mutate(clade_frac = clade_sum/sum(clade_sum),
         condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  ggplot(aes(sample, clade_frac, fill = clade)) + 
  geom_col(color = 'white', show.legend = F) + 
  scale_fill_manual(values = te_color_pal, name = 'biotype/clade') + 
  ggforce::facet_row(~condition, scales = 'free_x') +
  theme(axis.text.x = element_blank()) +
  xlab('sample') + ylab('normalized count fraction') -> fig.2C.plt


```
## Fig_2D
```{r}
unique(c(filter(ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out,
                abs(log2FoldChange) > 3.5)$ensg,
  filter(ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out,
         abs(log2FoldChange) > 1.5)$ensg)) -> de_ensg_names


ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$norm_counts.df %>% 
  rownames_to_column('ensg') %>% 
  filter(ensg %in% de_ensg_names,
         ensg %in% reference_meta_data$ucsc_rmsk_insert_info.df$gene) %>% 
  mutate_if(is.numeric, ~scale(log2(. + 1), center = T)) %>% 
  column_to_rownames('ensg') %>% as.matrix() %>% t() -> hm_count_data

hm_meta_data <- ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$scaled_quant_meta_for_de.df

left_hma <- ComplexHeatmap::rowAnnotation(df = hm_meta_data %>% select(condition), 
                                          col = list(condition = identity_color_pal), 
                                          show_annotation_name = F, simple_anno_size = unit(.3, "cm"))


reference_meta_data$ucsc_rmsk_insert_info.df %>% 
  filter(gene %in% colnames(hm_count_data)) %>% 
  select(gene, clade) %>% 
  mutate(clade = ifelse(clade %in% names(te_color_pal), clade, 'other')) %>% 
  column_to_rownames('gene') -> hm_te_data

hm_te_data <- hm_te_data[match(colnames(hm_count_data), rownames(hm_te_data)), , drop = F]

top_hma <- ComplexHeatmap::columnAnnotation(df = hm_te_data, 
                                            col = list(clade = te_color_pal), 
                                            show_annotation_name = T,
                                            annotation_name_side = 'left',
                                            annotation_name_gp = grid::gpar(fontsize = 10, fontface = 'italic'),
                                            show_legend = F, 
                                            simple_anno_size = unit(.375, "cm"))

set.seed(129)
ComplexHeatmap::Heatmap(hm_count_data, 
                        show_row_names = F, 
                        show_column_names = T, 
                        heatmap_width = figure_double_column_width * 0.85,
                        left_annotation = left_hma, 
                        column_dend_height = unit(.75, "cm"),
                        heatmap_legend_param = 
                          list(legend_gp = grid::gpar(fontsize = 8)),
                        # col = circlize::colorRamp2(breaks = c(-4,-2,0,2,4),
                        #                            colors = viridis::rocket(n = 5)),
                        top_annotation = top_hma,
                        column_names_gp = grid::gpar(fontsize = 8),
                        name = 'Z-score') -> fig.2D.chm
  
```
### Fig_2_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)


fig_2_layout <- "
AA
DD
BC
EE
"

wrap_plots(fig.2C.plt,
           fig.2A.plt + labs(title = 'panc'),
           fig.2B.plt + labs(title = 'covid'),
           guide_area(),
           patchwork::wrap_elements(full = grid::grid.grabExpr(ComplexHeatmap::draw(fig.2D.chm), 
                                                                width = figure_double_column_width)),
           design = fig_2_layout, 
           guides = 'collect',
           heights = c(0.75,0.0937,0.75,1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 0.5),
        legend.justification = c(0.5, 0.5)) -> fig.2.patchwork

save.manuscript.panel(figure = 2,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_2',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.2.patchwork)


```
# Fig_S2
## Fig_S2A
```{r}
bind_rows(list('panc' = salmon_quant$analysis_set$ctrl_panc_covid$deseq$fgsea$panc_v_ctrl,
          'covid' = salmon_quant$analysis_set$ctrl_panc_covid$deseq$fgsea$covid_v_ctrl),
          .id = 'condition') %>% 
  select(condition, pathway, padj, NES) %>% 
  mutate(padj = round(padj, 10),
         NES = round(NES, 3)) %>% 
  gridExtra::tableGrob(theme = gridExtra::ttheme_minimal(), rows = NULL) -> fig.S2A.fgsea_table.grob

```
## Fig_S2B
```{r}
de_compare_list <- list('panc' = ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out,
                        'covid' = ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out)

purrr::imap(de_compare_list, function(de, de_name) {
  
  de %>% 
    filter(gene %in% msig.df$HALLMARK_MYC_TARGETS_V1,
           padj < 0.05,
           abs(log2FoldChange) > 0.5) %>% 
    mutate(id = de_name)
  
}) %>% bind_rows() -> de_upset.df

de_upset.df %>% 
  group_by(gene) %>% 
  summarize(context = list(id)) %>% 
  ggplot(aes(context)) + 
  geom_bar(fill = 'white', color = 'black') + 
  ggupset::scale_x_upset() +
  geom_text(stat='count', aes(label=after_stat(count)), nudge_y = -2) + 
  xlab('') + ylab('MYC Target V1 genes') -> fig.S2B.plt


de_upset.df %>% 
  group_by(id) %>% 
  top_n(5, wt = log2FoldChange) %>% 
  ggplot(aes(reorder(gene, -log2FoldChange), log2FoldChange)) + 
  geom_col(fill = NA, color = 'black') + 
  coord_flip() + 
  ggforce::facet_col(~id, scales = 'free_y') + 
  geom_hline(yintercept = 1.0, linetype = 'dashed', alpha = 0.6) + 
  xlab('')

de_upset.df %>% 
  select(gene, log2FoldChange, id) %>% 
  spread(id, log2FoldChange) %>% 
  ggplot(aes(covid, panc, label = gene)) + 
  geom_point() + 
  geom_hline(yintercept = 0, linetype = 'dashed', alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = 'dashed', alpha = 0.6) + 
  xlab('covid log2FoldChange') + ylab('panc log2FoldChange') +
  ggrepel::geom_text_repel() -> fig.S2B_2.plt

```
## Fig_S2C
```{r}
import::from(.from = 'SummarizedExperiment',
             rowRanges)

rowRanges(ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$gxi) %>% 
  as.data.frame() %>% 
  filter(seqnames == 'chrM') %>% 
  select(group_name) %>% 
  unlist() %>% unname() -> chrM.filter.list

ucsc.rmsk.salmon_quant$analysis_set$panc_ctrl$deseq$de_out %>% 
# ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$deseq$panc_vs_ctrl %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels[c(1,8)])) %>% 
  filter(ensg %in% chrM.filter.list | grepl('^MT', gene)) -> mt_panc_annotated_rmsk_de

mt_panc_label_list <- mt_panc_annotated_rmsk_de %>% 
  top_n(6, wt = abs(log2FoldChange))

mt_panc_annotated_rmsk_de %>%
  filter(clade == 'gencode_coding') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) + 
  geom_point(size = 2, alpha = 0.6, show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt + 
  geom_point(data = filter(mt_panc_annotated_rmsk_de, clade != 'gencode_coding') %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels[c(1,8)])),
             aes(log2FoldChange, -log10(padj), color = clade), size = 2, alpha = 0.8) +
  scale_color_manual(values = te_color_pal[c(1,8)], name = 'biotype/clade') + 
  ggrepel::geom_text_repel(data = mt_panc_annotated_rmsk_de %>% 
             mutate(clade = factor(clade, levels = te_aware_annotation_levels[c(1,8)])),
                    aes(label = ifelse(gene %in% mt_panc_label_list$gene, gene, '')), 
                         show.legend = F, color = 'black', max.overlaps = 1000) + 
  xlim(-8.5,8.5) + 
  ggtitle('chrM panc') -> fig.S2C.plt

fig.S2C.plt
```
## Fig_S2D
```{r}
ucsc.rmsk.salmon_quant$analysis_set$covid_ctrl$deseq$de_out %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by = 'gene', all.x = T) %>% 
  mutate(family = ifelse(ensg %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) %>% 
  filter(ensg %in% chrM.filter.list | grepl('^MT', gene)) -> mt_covid_annotated_rmsk_de

mt_covid_label_list <- mt_covid_annotated_rmsk_de %>% 
  top_n(6, wt = abs(log2FoldChange))

mt_covid_annotated_rmsk_de %>%
  filter(clade == 'gencode_coding') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = clade)) + 
  geom_point(size = 2, alpha = 0.6, show.legend = FALSE) -> gencode_layer.plt

gencode_layer.plt + 
  geom_point(data = filter(mt_covid_annotated_rmsk_de, clade != 'gencode_coding') %>% 
               mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
             aes(log2FoldChange, -log10(padj), color = clade), size = 2, alpha = 0.8) +
  scale_color_manual(values = te_color_pal[c(1,8)], name = 'biotype/clade') + 
  ggrepel::geom_text_repel(data = mt_covid_annotated_rmsk_de %>% 
             mutate(clade = factor(clade, levels = te_aware_annotation_levels)),
                    aes(label = ifelse(gene %in% mt_covid_label_list$gene, gene, '')), 
                         show.legend = F, color = 'black', max.overlaps = 1000) + 
  xlim(-7.5,7.5) + 
  ggtitle('chrM covid') -> fig.S2D.plt

fig.S2D.plt
```
### Fig_S2_patchwork
```{r Fig1}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)


fig_S2_layout <- "
AA
BC
DD
EF
"

wrap_plots(patchwork::wrap_elements(fig.S2A.fgsea_table.grob, ignore_tag = F),
           patchwork::wrap_elements(full = fig.S2B.plt),
           fig.S2B_2.plt,
           guide_area(),
           fig.S2C.plt,
           fig.S2D.plt,
           design = fig_S2_layout, 
           guides = 'collect',
           heights = c(0.35,1,0.0937,1,1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag.position = c(0.01, 0.99), 
        legend.position = 'bottom',
        legend.title = element_text(vjust = 0.5),
        legend.justification = c(0.5, 0.5)) -> fig.S2.patchwork

save.manuscript.panel(figure = 's2',
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S2',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.S2.patchwork)


```

# Fig_Nanopore
## read_len load
```{r}
panc.7.1.1_read_len <- read_csv(file.path(output_data.dir, 'nanopore', 
                                          'nanopore_read_len', 'panc.7.1.1_biotype_read_lengths.csv')) %>% 
  separate(sample, sep = '[.]', into = c(NA,NA,'biotype',NA)) %>% 
  mutate(biotype = sub('_extraction', '', biotype))

panc.6.1.1_read_len <- read_csv(file.path(output_data.dir, 'nanopore', 
                                          'nanopore_read_len', 'panc.6.1.1_biotype_read_lengths.csv')) %>% 
  separate(sample, sep = '[.]', into = c(NA,NA,'biotype',NA)) %>% 
  mutate(biotype = sub('_extraction', '', biotype))

ctrl.6.1.5_read_len <- read_csv(file.path(output_data.dir, 'nanopore',
                                          'nanopore_read_len', 'ctrl.6.1.5_biotype_read_lengths.csv')) %>%
  separate(sample, sep = '[.]', into = c(NA,NA,'biotype',NA)) %>%
  mutate(biotype = sub('_extraction', '', biotype))

panc.7.1.1_read_len %>% 
  mutate(sample = 'panc.7.1.1') %>% 
  rbind(panc.6.1.1_read_len %>%
         mutate(sample = 'panc.6.1.1')) %>% 
  rbind(ctrl.6.1.5_read_len %>%
         mutate(sample = 'ctrl.6.1.5')) %>%
  group_by(biotype) -> panc_nanopore_read_length.df

illumina_read_len <- list.files(file.path(output_data.dir, 'nanopore', 'illumina_read_len'), full.names = T)[1:31]
names(illumina_read_len) <- gsub(basename(illumina_read_len), pattern = '.csv', replacement = '')[1:31]

name_conversion <- data.frame('in_name' = stringr::str_split_fixed(names(illumina_read_len), '[.]', n = 2)[,1])

name_conversion$out_name <- c('panc.1.2.3', 'panc.2.2.7', 'panc.4.3.9', 
                              'panc.5.4.5', 'panc.6.2.5', 'panc.7.2.5',
                              'panc.9.2.5', 'panc.7.1.1', 'panc.9.1.1', 
                              'panc.10.1.2', 'panc.6.1.1', 'covid.400.0.56', 'covid.381.0.80',
                              'covid.396.0.68', 'covid.411.0.75', 'covid.412.0.64',
                              'covid.426.0.80', 'covid.432.0.58', 'covid.441.0.64',
                              'covid.442.0.61', 'covid.450.0.84', 'ctrl.12.1.1', 
                              'ctrl.5.1.3', 'ctrl.7.1.2', 'ctrl.9.1.2', 'ctrl.13.0.7', 
                              'ctrl.8.1.2', 'ctrl.10.0.4', 'ctrl.6.1.5', 'ctrl.11.1.1','ctrl.4.1.3')

illumina_roster_names <- read_csv(file.path(output_data.dir, 'nanopore', 'illumina_read_len', 'ROSTER.csv'),
                                  col_names = c('read', 'sample'))

# lapply(illumina_read_len, function(file) {
# 
#   read_len_file <- read_csv(file = file,
#                             col_names = c('read', 'read_length', 'seq_1',
#                                           'seq_2', 'originally_multisample',
#                                           'tx', 'sample'))
#   read_len_file %>%
#     mutate(tx = ifelse(grepl('^ENST', tx),
#             str_split_fixed(tx, pattern = '[|]', n = 10)[,1],
#             tx)) %>%
#     mutate(tx = ifelse(grepl('_range', tx),
#             str_split_fixed(tx, pattern = '::', n = 2)[,1],
#             tx)) %>%
#   mutate(sample = stringr::str_split_fixed(sample, '[.]', n = 2)[,1],
#          sample = gsub(pattern = 'panc_', replacement = 'panc', sample)) %>%
#     merge(name_conversion, by.x = 'sample', by.y = 'in_name') %>%
#     merge(reference_meta_data$total_tx_to_gene.df, by.x = 'tx', by.y = 'enst') %>%
#     dplyr::rename('sample_name' = 'out_name')
# 
# 
# }) -> illumina_read_len.list
# 
# 
# saveRDS(object = illumina_read_len.list, file = file.path(output_data.dir, 'nanopore', 'illumina_read_len.rds'))
# illumina_read_len.list <- readRDS(file = file.path(output_data.dir, 'nanopore', 'illumina_read_len.rds'))

# illumina_read_len.list %>%
#   bind_rows(.id = 'sample') %>%
#   filter(!sample %in% qc_fails) %>%
#   merge(sample_meta_data$`2022.01.14_combined_meta_data.csv`, by.x = 'sample_name', by.y = 'patient') %>%
#   group_by(condition, biotype) %>%
#   mutate(z_score = scale(abs(read_length))) %>%
#   filter(between(z_score, -2.5, 2.5)) -> illumina_read_len.df
# 
# saveRDS(object = illumina_read_len.df, file = file.path(output_data.dir, 'nanopore',
#                                                            'illumina_read_len.df.rds'))
# rm(illumina_read_len.list)

# illumina_read_len.df <- readRDS(file = file.path(output_data.dir, 'nanopore',
#                                                            'illumina_read_len.df.rds'))
# 
# illumina_read_len.df$seq_1 <- NULL
# illumina_read_len.df$seq_2 <- NULL
# 
# vroom::vroom_write(illumina_read_len.df, file = file.path(output_data.dir, 'nanopore','illumina_read_len_no_seq.tsv.gz'))

illumina_read_len.df <-
  vroom::vroom(file = file.path(output_data.dir,'nanopore','illumina_read_len_no_seq.tsv.gz'), num_threads = 16)
```
## Fig_NA
```{r}
table(illumina_read_len.df$biotype) %>% 
  as.data.frame() %>% 
  select(biotype = Var1) %>% 
  filter(biotype %in% c('LINE', 'lncRNA', 'LTR', 'protein_coding', 'SINE')) %>% 
  mutate(biolabel = c('LINE', 'gencode_lncRNA', 'LTR', 'gencode_coding', 'SINE')) -> illumina_biotype_labels

illumina_read_len.df %>% 
  filter(biotype %in% illumina_biotype_labels$biotype,
         ! sample %in% qc_fails) -> illumina_biotype_to.plt

illumina_read_len.df %>% 
  filter(! sample %in% qc_fails) %>% 
  group_by(sample, biotype, condition) %>% 
  summarize(read_length = median(abs(read_length))) -> tmp_mean_read_len.df
  

tmp_mean_read_len.df %>%
  group_by(biotype, condition) %>%
  filter(n() == 10, ! biotype %in% c('polymorphic_pseudogene', 'TR_C_gene', 'TR_V_gene', 'IG_V_gene', 'IG_C_gene',
                                   'TEC', 'non_stop_decay', 'nonsense_mediated_decay'),
         condition != 'covid') %>% 
  mutate(biotype = ifelse(biotype == 'lncRNA', 'gencode_lncRNA', biotype),
         biotype = ifelse(biotype == 'protein_coding', 'gencode_coding', biotype)) %>% 
  mutate(biotype = factor(biotype, levels = c('SINE', 'LINE', 'LTR', 'gencode_lncRNA', 
                                              'retained_intron', 'gencode_coding'))) %>% 
  ggplot(aes(condition, read_length, color = condition)) +
  geom_boxplot(outlier.colour = NA) + 
  geom_jitter(width = 0.24, alpha = 0.2) +
  facet_wrap(~biotype, scales = 'free', ncol = 3, strip.position = 'bottom') +
  scale_color_manual(values = identity_color_pal, guide = 'none') + 
  ggpubr::stat_compare_means(method = 'wilcox', comparisons = list(c('panc', 'ctrl')), size = txt.mm_to_pts(0.8)) +
  coord_cartesian(clip = 'off') + 
  theme(strip.placement = 'inside') +
  xlab('') + ylab('median fragment size (bp)') -> plt_NA.plt
```
## Fig_NB
```{r}
tmp_mean_read_len.df %>% 
  filter(condition != 'covid',
         ! sample %in% qc_fails) %>% 
  pivot_wider(names_from = biotype, values_from = read_length) %>% 
  select(-condition) %>% 
  column_to_rownames('sample') -> read_len_pca.tmp
  
pca_tmp_in_sd <- apply(read_len_pca.tmp, 2, sd)
pca_tmp_in_zero_sd <- read_len_pca.tmp[,pca_tmp_in_sd!=0 & !is.na(pca_tmp_in_sd)]
non_zero_pca <- prcomp(pca_tmp_in_zero_sd, center = T, scale. = T, rank. = 50)

summary(non_zero_pca)
pcs.of.interest <- apply(non_zero_pca$x, 2, var)
pcs.props <-  pcs.of.interest/sum(pcs.of.interest)
cumsum(pcs.props)[c(1,2)]
print(as.data.frame(pcs.props) %>% 
        rownames_to_column('pc') %>% 
        mutate(pc = as.numeric(sub('PC', '', pc))) %>% 
        ggplot(aes(pc, pcs.props)) + 
        geom_col())

pca.out <- as.data.frame(non_zero_pca$x) %>% 
  rownames_to_column('sample') %>% 
  merge(tmp_mean_read_len.df %>% select(sample, condition) %>% ungroup() %>% distinct(), by = 'sample') %>% 
  ungroup() %>% 
  select(-biotype) %>% 
  distinct()

pca.out.summary <- 
  as.data.frame(summary(non_zero_pca)$importance) %>% 
  rownames_to_column('metric') %>% 
  gather(pc, value, -metric) %>% 
  spread(metric, value)

pca.out %>% 
  ggplot(aes(PC1, PC2,
             color = condition)) +
  geom_point(size = rel(2), alpha = 1) + 
  # scale_shape_manual(values = c(21,25)) +
  xlab(paste('PC1', round(cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
  ylab(paste('PC2', round(cumsum(pcs.props)[2] - cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
  geom_vline(xintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) +
  geom_hline(yintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) + 
  scale_color_manual(values = identity_color_pal[1:2]) + 
  annotate(geom = 'text', x = -3.75, y = -3.25, label = 'intron-aware', size = txt.mm_to_pts(1)) +
  theme(legend.position = c(0.95,1), legend.direction = 'horizontal') -> plt_NB.plt
```
## Fig_NC
```{r}
panc_nanopore_read_length.df %>% 
  group_by(biotype) %>% 
  mutate(z_score = scale(abs(read_length))) %>% 
  filter(between(z_score, -2.5, 2.5))-> panc_nanopore_read_length.df

table(panc_nanopore_read_length.df$biotype) %>% 
  as.data.frame() %>% 
  select(biotype = Var1) %>% 
  mutate(biolabel = c('LINE', 'gencode_lncRNA', 'LTR', 'gencode_coding', 'SINE')) -> nanopore_biotype_labels

panc_nanopore_read_length.df %>% 
  group_by(biotype) %>%
  filter(!grepl('ctrl', sample)) %>% 
  merge(nanopore_biotype_labels, by = 'biotype') %>% 
  mutate(biolabel = factor(biolabel, levels = te_aware_annotation_levels),
         sample = case_when(sample == 'panc.7.1.1' ~ 'panc 7', 
                            sample == 'panc.6.1.1' ~ 'panc 6')) %>% 
  ggplot(aes(abs(read_length), fill = sample)) + 
  geom_histogram(aes(y=stat(density*width)), bins = 100) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01)) +
  ggforce::facet_col(~biolabel, scales = 'free') +
  scale_fill_manual(values = viridisLite::plasma(20)[c(8,10)]) +
  ylab('proportion of nanopore biotype/clade fragment lengths') + xlab('nanopore fragment size (bp)') +
  theme(legend.position = c(0.55,0.99), legend.direction = 'horizontal') -> plt_NC.plt
```
## Fig_ND
```{r}
panc_nanopore_read_length.df %>% 
  ungroup() %>% 
  mutate(originally_multisample = ifelse(grepl('^ENST', originally_multisample), 
            str_split_fixed(originally_multisample, pattern = '[|]', n = 10)[,1],
            originally_multisample)) %>% 
  mutate(originally_multisample = ifelse(grepl('_range', originally_multisample),
            str_split_fixed(originally_multisample, pattern = '::', n = 2)[,1],
            originally_multisample)) %>%
  merge(reference_meta_data$total_tx_to_gene.df, by.x = 'originally_multisample', by.y = 'enst') %>% 
  mutate(len = as.numeric(len)) -> len_compare.df

len_compare.df %>%
  filter(biotype.x == 'SINE', sample == 'ctrl.6.1.5') -> ctrl.6.1.5_nanopore_hex_to.plt

len_compare.df %>% 
  filter(biotype.x == 'SINE', sample == 'panc.6.1.1') -> panc.6.1.1_nanopore_hex_to.plt

len_compare.df %>% 
  filter(biotype.x == 'SINE', sample == 'panc.7.1.1') -> panc.7.1.1_nanopore_hex_to.plt

# illumina_read_len.df %>% 
#   filter(! sample %in% qc_fails,
#          abs(read_length) <= 1000,
#          condition != 'covid') %>% 
#   mutate(read_length = abs(read_length)) %>% 
#   group_by(condition) %>% 
#   select(sample_name, biotype, read_length, condition) -> read_len_cdf_tmp
# 
# read_len_cdf_tmp %>% 
#   filter(sample_name == 'ctrl.6.1.5', biotype == 'SINE') %>% 
#   pull(read_length) %>% 
#   AnalystHelper::ecdf_fun(CI = T, CI.interval = 0.99) %>% 
#   mutate(sample = 'ctrl 6') %>% 
#   rbind(read_len_cdf_tmp %>% 
#     filter(sample_name == 'panc.6.1.1', biotype == 'SINE') %>% 
#     pull(read_length) %>% 
#     AnalystHelper::ecdf_fun(CI = T, CI.interval = 0.99) %>% 
#     mutate(sample = 'panc 6')) %>% 
#   rbind(read_len_cdf_tmp %>% 
#     filter(sample_name == 'panc.7.1.1', biotype == 'SINE') %>% 
#     pull(read_length) %>% 
#     AnalystHelper::ecdf_fun(CI = T, CI.interval = 0.99) %>% 
#     mutate(sample = 'panc 7')) %>% 
#   ggplot(aes(x = value, y = proportion, min = lwr.CI, ymax = upr.CI, color = sample)) + 
#   geom_ribbon(alpha = 0.05) + 
#   geom_step() +
#   # xlim(130,315) +
#   scale_color_manual(values = c(three_color_pal[3], three_color_pal[1], three_color_pal[2])) + 
#   ylab('cumulative proportion (99% CI)') + 
#   xlab('read length') + 
#   theme(legend.position = c(0.25, 0.99)) -> plt_ND_1.plt

ctrl.6.1.5_nanopore_hex_to.plt %>% 
  pull(read_length) %>% 
  AnalystHelper::ecdf_fun(CI = T, CI.interval = 0.99) %>% 
  mutate(sample = 'ctrl 6') %>% 
  rbind(panc.6.1.1_nanopore_hex_to.plt %>% 
        pull(read_length) %>% 
        AnalystHelper::ecdf_fun(CI = T, CI.interval = 0.99) %>% 
          mutate(sample = 'panc 6')) %>% 
  rbind(panc.7.1.1_nanopore_hex_to.plt %>% 
        pull(read_length) %>% 
        AnalystHelper::ecdf_fun(CI = T, CI.interval = 0.99) %>% 
          mutate(sample = 'panc 7')) %>% 
  ggplot(aes(x = value, y = proportion, min = lwr.CI, ymax = upr.CI, color = sample)) + 
  geom_ribbon(alpha = 0.05) + 
  geom_step() + 
  xlim(130,315) +
  scale_color_manual(values = viridisLite::plasma(20)[c(1,8,10)]) +
  ylab('cumulative prop. (99% CI)') + 
  xlab('nanopore SINE fragment size (bp)') + 
  theme(legend.position = c(0.25, 0.99)) -> plt_ND_2.plt

# p4 <- ggplot(data.frame(l = plt_ND_2.plt$labels$y, x = 1, y = 1)) +
#       geom_text(aes(x, y, label = l), angle = 90) + 
#       theme_void() +
#       coord_cartesian(clip = "off")
# 
# panel_ND_layout <- "
# CA
# CB
# "
# 
# wrap_plots(plt_ND_1.plt + ylab('') + xlab(''),
#            plt_ND_2.plt + ylab(''),
#            p4,
#            widths = c(0.02,1),
#            design = panel_ND_layout) -> panel.ND.patchwork
```
## Fig_NE
```{r}
panc.6.1.1_nanopore_hex_to.plt %>% 
  group_by(tx, len, biotype.x, sample) %>% 
  summarize(read_length = mean(read_length)) %>% 
  merge(nanopore_biotype_labels, by.x = 'biotype.x', by.y = 'biotype') %>% 
  mutate(biolabel = factor(biolabel, levels = te_aware_annotation_levels),
         condition = ifelse(grepl('ctrl', sample), 'ctrl', 'panc')) %>% 
  # ggplot(aes(read_length, len, fill = scale(..count../(sum(..count..) * 1e6)))) + 
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  # geom_vline(xintercept = median(panc.6.1.1_nanopore_hex_to.plt$read_length), color = 'grey', linetype = 'dashed') +
  annotate(geom = 'text', x = 215, y = 120, label = 'panc 6') +
  xlab('avg. observed SINE fragment size (bp)') + ylab('expected size (bp)') +
  # ggforce::facet_col(~sample) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', breaks = c(0,1)) +
  scale_y_continuous(breaks = c(100,200,300,400), limits = c(75,425)) +
  scale_x_continuous(breaks = c(100,200,300,400), limits = c(75,370)) +
  theme(legend.position = c(0.98,0.45), legend.direction = 'horizontal', legend.key.width = unit(1, 'mm')) +
  guides(fill = guide_colorbar(title.position = 'left', title.vjust = 1)) -> plt_NE.plt
```
### Fig_Nanopore_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


fig_N_layout <- "
AA
BB
CD
ED
FD
"

wrap_plots(plt_NA.plt,
           guide_area(),
           plt_NB.plt,
           plt_NC.plt,
           wrap_elements(full = plt_NE.plt),
           wrap_elements(full = plt_ND_2.plt),
           design = fig_N_layout, 
           guides = 'collect',
           heights = c(1.2,0.025,0.5,1,1)) +
  plot_annotation(tag_levels = 'A') &
  theme(legend.justification = 'center', legend.position = 'bottom') -> fig.N.patchwork


# fig.N.patchwork

save.manuscript.panel(figure = 3,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_3',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.N.patchwork)
```

# Fig_supp_nanopore
## Fig_SNA
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer)

ctrl.6.1.5_nanopore_hex_to.plt %>%
  group_by(tx, len, biotype.x, sample) %>%
  summarize(read_length = mean(read_length)) %>%
  merge(nanopore_biotype_labels, by.x = 'biotype.x', by.y = 'biotype') %>%
  mutate(biolabel = factor(biolabel, levels = te_aware_annotation_levels),
         condition = ifelse(grepl('ctrl', sample), 'ctrl', 'panc')) %>%
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) +
  geom_hex(bins = 120) +
  annotate(geom = 'text', x = 275, y = 150, label = 'ctrl 6') +
  # geom_vline(xintercept = median(ctrl.6.1.5_nanopore_hex_to.plt$read_length), 
  #            color = 'grey', linetype = 'dashed') +
  xlab('avg. observed fragment length') + ylab('expected insertion length') +
  # ggforce::facet_col(~sample) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', guide = 'none') +
  scale_y_continuous(breaks = c(100,200,300,400), limits = c(75,425)) +
  scale_x_continuous(breaks = c(100,200,300,400), limits = c(75,370)) -> plt_SNA_1.plt


panc.7.1.1_nanopore_hex_to.plt %>% 
  group_by(tx, len, biotype.x, sample) %>% 
  summarize(read_length = mean(read_length)) %>% 
  merge(nanopore_biotype_labels, by.x = 'biotype.x', by.y = 'biotype') %>% 
  mutate(biolabel = factor(biolabel, levels = te_aware_annotation_levels),
         condition = ifelse(grepl('ctrl', sample), 'ctrl', 'panc')) %>% 
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  # geom_vline(xintercept = median(panc.7.1.1_nanopore_hex_to.plt$read_length), color = 'grey', linetype = 'dashed') +
  annotate(geom = 'text', x = 275, y = 150, label = 'panc 7') +
  xlab('avg. observed fragment length') + ylab('expected insertion length') +
  # ggforce::facet_col(~sample) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', guide = 'none') +
  scale_y_continuous(breaks = c(100,200,300,400), limits = c(75,425)) +
  scale_x_continuous(breaks = c(100,200,300,400), limits = c(75,370)) -> plt_SNA_3.plt
  
panel_SNA_layout <- "
AB
"

wrap_plots(plt_SNA_1.plt + xlab(''),
           plt_SNA_3.plt + ylab('') + xlab(''),
           design = panel_SNA_layout) -> panel.SNA.patchwork
```
## Fig_SNA_dep
```{r}
illumina_biotype_to.plt %>% 
  filter(biotype == 'SINE') %>% 
  group_by(tx, len, biotype, condition) %>% 
  mutate(len = as.numeric(len)) %>%
  summarize(read_length = median(abs(read_length))) -> tmp

tmp %>% 
  filter(condition == 'ctrl') -> ctrl_hex_to.plt

ctrl_hex_to.plt %>% 
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  # geom_vline(xintercept = median(ctrl_hex_to.plt$read_length), color = 'grey', linetype = 'dashed') +
  annotate(geom = 'text', x = 275, y = 175, label = 'ctrl') +
  xlab('median observed SINE fragment length') + ylab('expected insertion length') +
  # ggforce::facet_col(~sample) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', breaks = c(0,1), guide = 'none') +
  scale_y_continuous(breaks = c(50,100,200,300,400, 500), limits = c(0,500)) +
  scale_x_continuous(breaks = c(50,100,200,300,400, 500), limits = c(0,350)) -> plt_SNA_1.plt

tmp %>% 
  filter(condition == 'panc') -> panc_hex_to.plt

panc_hex_to.plt %>% 
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  # geom_vline(xintercept = median(panc_hex_to.plt$read_length), color = 'grey', linetype = 'dashed') +
  annotate(geom = 'text', x = 275, y = 175, label = 'panc') +
  xlab('avg. observed fragment length') + ylab('expected insertion length') +
  # ggforce::facet_col(~sample) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', breaks = c(0,1)) +
  scale_y_continuous(breaks = c(50,100,200,300,400, 500), limits = c(0,500)) +
  scale_x_continuous(breaks = c(50,100,200,300,400, 500), limits = c(0,350)) +
  theme(legend.position = c(0.95,0.25), legend.direction = 'horizontal', legend.key.width = unit(1, 'mm')) +
  guides(fill = guide_colorbar(title.position = 'left', title.vjust = 1)) -> plt_SNA_2.plt

tmp %>% 
  filter(condition == 'covid') -> covid_hex_to.plt

covid_hex_to.plt %>% 
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  # geom_vline(xintercept = median(covid_hex_to.plt$read_length), color = 'grey', linetype = 'dashed') +
  annotate(geom = 'text', x = 275, y = 175, label = 'covid') +
  xlab('avg. observed fragment length') + ylab('expected insertion length') +
  # ggforce::facet_col(~sample) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', breaks = c(0,1), guide = 'none') +
  scale_y_continuous(breaks = c(50,100,200,300,400, 500), limits = c(0,500)) +
  scale_x_continuous(breaks = c(50,100,200,300,400, 500), limits = c(0,350)) -> plt_SNA_3.plt

p4 <- ggplot(data.frame(l = plt_SNA_1.plt$labels$x, x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 0, size = txt.mm_to_pts(0.95)) + 
      theme_void() +
      coord_cartesian(clip = "off")
  
panel_SNA_layout <- "
ABC
"

wrap_plots(plt_SNA_1.plt + xlab(''),
           plt_SNA_2.plt + xlab('') + ylab(''),
           plt_SNA_3.plt + xlab('') + ylab(''),
           heights = c(1),
           design = panel_SNA_layout) -> panel.SNA.patchwork
```
## Fig_SNB
```{r}
illumina_biotype_to.plt %>% 
  filter(biotype == 'SINE',
         sample_name %in% c('panc.6.1.1', 'panc.7.1.1', 'ctrl.6.1.5')) %>% 
  group_by(tx, len, biotype, sample_name) %>% 
  mutate(len = as.numeric(len)) %>% 
  summarize(read_length = median(abs(read_length))) -> tmp

tmp %>%
  filter(sample_name == 'ctrl.6.1.5') -> ctrl_hex_to.plt

ctrl_hex_to.plt %>%
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) +
  geom_hex(bins = 120) +
  annotate(geom = 'text', x = 250, y = 175, label = 'ctrl 6') +
  # geom_vline(xintercept = median(ctrl_hex_to.plt$read_length), color = 'grey', linetype = 'dashed') +
  xlab('avg. observed fragment length') + ylab('expected insertion length') +
  scale_y_continuous(breaks = c(100,200,300,400), limits = c(75,425)) +
  scale_x_continuous(breaks = c(100,200,300,400), limits = c(75,370)) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', breaks = c(0,1), guide = 'none') -> plt_SNB_1.plt
  

tmp %>% 
  filter(sample_name == 'panc.6.1.1') -> panc.6.1.1_hex_to.plt

panc.6.1.1_hex_to.plt %>% 
  mutate(bin = ifelse(read_length > 180, 'large', 'small')) %>% 
  group_by(tx) %>%
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  annotate(geom = 'text', x = 250, y = 175, label = 'panc 6') +
  # geom_vline(xintercept = median(panc.6.1.1_hex_to.plt$read_length), color = 'grey', linetype = 'dashed') +
  xlab('avg. observed fragment length') + ylab('expected insertion length') +
  scale_y_continuous(breaks = c(100,200,300,400), limits = c(75,425)) +
  scale_x_continuous(breaks = c(100,200,300,400), limits = c(75,370)) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', breaks = c(0,1)) +
  theme(legend.position = c(0.95,0.25), legend.direction = 'horizontal', legend.key.width = unit(1, 'mm')) +
  guides(fill = guide_colorbar(title.position = 'left', title.vjust = 1)) -> plt_SNB_2.plt


tmp %>%
  filter(sample_name == 'panc.7.1.1') -> panc.7.1.1_hex_to.plt

panc.7.1.1_hex_to.plt %>% 
  ggplot(aes(read_length, len, fill = scales::rescale((..count../(sum(..count..) * 1e6))))) + 
  geom_hex(bins = 120) +
  annotate(geom = 'text', x = 250, y = 175, label = 'panc 7') +
  # geom_vline(xintercept = median(panc.7.1.1_hex_to.plt$read_length), color = 'grey', linetype = 'dashed') +
  xlab('median observed SINE fragment length') + ylab('expected insertion length') +
  scale_y_continuous(breaks = c(100,200,300,400), limits = c(75,425)) +
  scale_x_continuous(breaks = c(100,200,300,400), limits = c(75,370)) +
  scale_fill_viridis_c(option = 'viridis', direction = 1, name = 'scaled cpm', breaks = c(0,1), guide = 'none') -> plt_SNB_3.plt

p4 <- ggplot(data.frame(l = plt_SNB_3.plt$labels$x, x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 0, size = txt.mm_to_pts(0.95)) + 
      theme_void() +
      coord_cartesian(clip = "off")
  
panel_SNB_layout <- "
ABC
DDD
"

wrap_plots(plt_SNB_1.plt + xlab(''),
           plt_SNB_2.plt + xlab('') + ylab(''),
           plt_SNB_3.plt + xlab('') + ylab(''),
           p4,
           heights = c(1,0.06),
           design = panel_SNB_layout) -> panel.SNB.patchwork

```
## Fig_SNC
```{r}
tmp_mean_read_len.df %>%
  group_by(biotype, condition) %>%
  filter(n() == 10, ! biotype %in% c('polymorphic_pseudogene', 'TR_C_gene', 'TR_V_gene', 'IG_V_gene', 'IG_C_gene',
                                   'TEC', 'non_stop_decay', 'nonsense_mediated_decay'),
         condition != 'panc') %>% 
  mutate(biotype = ifelse(biotype == 'lncRNA', 'gencode_lncRNA', biotype),
         biotype = ifelse(biotype == 'protein_coding', 'gencode_coding', biotype)) %>% 
  mutate(biotype = factor(biotype, levels = c('SINE', 'LINE', 'LTR', 'gencode_lncRNA', 'retained_intron', 'gencode_coding'))) %>% 
  ggplot(aes(condition, read_length, color = condition)) +
  geom_boxplot(outlier.colour = NA) + 
  geom_jitter(width = 0.24, alpha = 0.2) +
  facet_wrap(~biotype, scales = 'free', ncol = 3, strip.position = 'bottom') +
  scale_color_manual(values = identity_color_pal, guide = 'none') + 
  ggpubr::stat_compare_means(method = 'wilcox', comparisons = list(c('covid', 'ctrl')), size = txt.mm_to_pts(0.8)) +
  coord_cartesian(clip = 'off') + 
  theme(strip.placement = 'inside') +
  xlab('') + ylab('median fragment length') -> plt_SNC.plt
```
## Fig_SND
```{r}
tmp_mean_read_len.df %>% 
  filter(condition != 'panc',
         ! sample %in% qc_fails) %>% 
  pivot_wider(names_from = biotype, values_from = read_length) %>% 
  select(-condition) %>% 
  column_to_rownames('sample') -> read_len_pca.tmp
  
pca_tmp_in_sd <- apply(read_len_pca.tmp, 2, sd)
pca_tmp_in_zero_sd <- read_len_pca.tmp[,pca_tmp_in_sd!=0 & !is.na(pca_tmp_in_sd)]
non_zero_pca <- prcomp(pca_tmp_in_zero_sd, center = T, scale. = T, rank. = 50)

summary(non_zero_pca)
pcs.of.interest <- apply(non_zero_pca$x, 2, var)
pcs.props <-  pcs.of.interest/sum(pcs.of.interest)
cumsum(pcs.props)[c(1,2)]
print(as.data.frame(pcs.props) %>% 
        rownames_to_column('pc') %>% 
        mutate(pc = as.numeric(sub('PC', '', pc))) %>% 
        ggplot(aes(pc, pcs.props)) + 
        geom_col())

pca.out <- as.data.frame(non_zero_pca$x) %>% 
  rownames_to_column('sample') %>% 
  merge(tmp_mean_read_len.df %>% select(sample, condition) %>% ungroup() %>% distinct(), by = 'sample') %>% 
  ungroup() %>% 
  select(-biotype) %>% 
  distinct()

pca.out.summary <- 
  as.data.frame(summary(non_zero_pca)$importance) %>% 
  rownames_to_column('metric') %>% 
  gather(pc, value, -metric) %>% 
  spread(metric, value)

pca.out %>% 
  ggplot(aes(PC1, PC2,
             color = condition)) +
  geom_point(size = rel(2), alpha = 1) + 
  # scale_shape_manual(values = c(21,25)) +
  xlab(paste('PC1', round(cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
  ylab(paste('PC2', round(cumsum(pcs.props)[2] - cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
  geom_vline(xintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) +
  geom_hline(yintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) + 
  scale_color_manual(values = identity_color_pal[c(1,3)]) + 
  theme(legend.position ='top', legend.direction = 'horizontal') -> plt_SND.plt
```
### Fig_SNanopore_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


fig_SN_layout <- "
AA
BB
CC
DD
"

wrap_plots(wrap_elements(full = panel.SNA.patchwork),
           wrap_elements(full = panel.SNB.patchwork),
           plt_SNC.plt,
           plt_SND.plt,
           heights = c(1.25,1.25,1,0.5),
           design = fig_SN_layout) +
  plot_annotation(tag_levels = 'A') -> fig.SN.patchwork

save.manuscript.panel(figure = 's3',
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S3',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.SN.patchwork)
```

# Fig_supp_nanopore_2
## Fig_SN2_patchwork
```{r}
panc.7.1.1_nanopore_tpm <- 
  read_tsv(file.path(output_data.dir, 'nanopore', 'gencode_39_rmsk_nanopore_abundance', 'panc.7.1.1_gene_abundance.tsv'))

panc.6.1.1_nanopore_tpm <- 
  read_tsv(file.path(output_data.dir, 'nanopore', 'gencode_39_rmsk_nanopore_abundance', 'panc.6.1.1_gene_abundance.tsv'))

import::from(.from = 'SummarizedExperiment', assay)

count_matrix.df <- as.data.frame(as.matrix(assay(ucsc.rmsk.salmon_quant$analysis_set$ctrl_panc_covid$gxi, 'counts')))

count_matrix.df[, 'panc.7.1.1', drop = F] %>% rownames_to_column('Gene ID') %>% 
  mutate(panc.7.1.1_tpm = panc.7.1.1*1e6/(sum(panc.7.1.1))) %>% 
  merge(panc.7.1.1_nanopore_tpm %>% select(`Gene ID`, TPM), by = 'Gene ID') %>% 
  dplyr::rename('panc.7.1.1_nanopore_tpm' = TPM) %>%
  group_by(`Gene ID`) %>% 
  summarize(panc_7_tpm = mean(panc.7.1.1_tpm),
            panc_7_nanopore_tpm = mean(panc.7.1.1_nanopore_tpm)) %>% 
  distinct() -> panc_7.1.1_tpm

count_matrix.df[, 'panc.6.1.1', drop = F] %>% rownames_to_column('Gene ID') %>%
  mutate(panc.6.1.1_tpm = panc.6.1.1 *1e6/(sum(panc.6.1.1))) %>% 
  merge(panc.6.1.1_nanopore_tpm %>% select(`Gene ID`, TPM), by = 'Gene ID') %>% 
  dplyr::rename('panc.6.1.1_nanopore_tpm' = TPM) %>% 
  group_by(`Gene ID`) %>% 
  summarize(panc_6_tpm = mean(panc.6.1.1_tpm),
            panc_6_nanopore_tpm = mean(panc.6.1.1_nanopore_tpm)) %>% 
  distinct() -> panc_6.1.1_tpm


merge(panc_7.1.1_tpm, panc_6.1.1_tpm, by = 'Gene ID') -> panc_compare.df


panc_compare.df %>% 
  merge(reference_meta_data$ucsc_rmsk_insert_info.df, by.x = 'Gene ID', by.y = 'gene', all.x = T) %>% 
  mutate(family = ifelse(`Gene ID` %in% reference_meta_data$gencode_lncRNA_gene_names.df$ensg,
                         'gencode_lncRNA', family),
         family = ifelse(is.na(family), 'gencode_coding', family),
         clade = ifelse(grepl('gencode', family), family, clade),
         clade = ifelse(clade %in% c('gencode_coding',
                                     'gencode_lncRNA',
                                     'LINE',
                                     'SINE',
                                     'LTR',
                                     'DNA',
                                     'Simple_repeat'), clade, 'other'),
         type = ifelse(grepl('gencode',family), 'GENCODE', 'TE'),
         clade = factor(clade, levels = te_aware_annotation_levels)) -> panc_compare_annotated.df

lm(panc_6_tpm ~ panc_7_tpm, data = panc_compare_annotated.df) %>% 
  summary() -> panc_lm_out

b <- round(panc_lm_out$coefficients[1,1], 2)
m <- round(panc_lm_out$coefficients[2,1], 2)
r2 <- round(panc_lm_out$adj.r.squared, 2)

panc_compare_annotated.df %>% 
  ggplot(aes(log2(panc_6_tpm + 1), log2(panc_7_tpm + 1), color = clade, fill = clade)) + 
  geom_hex(alpha = 0.4, bins = 250) +
  annotate(geom = 'text', x = 3, y = 15, fontface = 'italic',
           label = paste0('y', ' ', ' = ',b,' + ',m,'x; adj. R2 = ', r2), 
           size = rel(3.75), alpha = 0.8) + 
  scale_color_manual(values = te_color_pal) + 
  scale_fill_manual(values = te_color_pal) -> plt_SN2A.plt

lm(panc_7_nanopore_tpm ~ panc_7_tpm, data = panc_compare_annotated.df) %>% 
  summary() -> panc_lm_out

b <- round(panc_lm_out$coefficients[1,1], 2)
m <- round(panc_lm_out$coefficients[2,1], 2)
r2 <- round(panc_lm_out$adj.r.squared, 2)

panc_compare_annotated.df %>% 
  ggplot(aes(log2(panc_7_nanopore_tpm + 1), log2(panc_7_tpm + 1), color = clade, fill = clade)) + 
  geom_hex(alpha = 0.4, bins = 250) +
  annotate(geom = 'text', x = 6, y = 16, fontface = 'italic',
         label = paste0('y', ' ', ' = ',b,' + ',m,'x; adj. R2 = ', r2), 
         size = rel(3.75), alpha = 0.8) + 
  scale_color_manual(values = te_color_pal) + 
  scale_fill_manual(values = te_color_pal)-> plt_SN2B.plt

lm(panc_6_nanopore_tpm ~ panc_6_tpm, data = panc_compare_annotated.df) %>% 
  summary() -> panc_lm_out

b <- round(panc_lm_out$coefficients[1,1], 2)
m <- round(panc_lm_out$coefficients[2,1], 2)
r2 <- round(panc_lm_out$adj.r.squared, 2)

panc_compare_annotated.df %>% 
  ggplot(aes(log2(panc_6_nanopore_tpm + 1), log2(panc_6_tpm + 1), color = clade, fill = clade)) + 
  geom_hex(alpha = 0.4, bins = 250) +
  annotate(geom = 'text', x = 6, y = 16, fontface = 'italic',
         label = paste0('y', ' ', ' = ',b,' + ',m,'x; adj. R2 = ', r2), 
         size = rel(3.75), alpha = 0.8) +
  scale_color_manual(values = te_color_pal) + 
  scale_fill_manual(values = te_color_pal) -> plt_SN2C.plt

lm(panc_6_nanopore_tpm ~ panc_7_nanopore_tpm, data = panc_compare_annotated.df) %>% 
  summary() -> panc_lm_out

b <- round(panc_lm_out$coefficients[1,1], 2)
m <- round(panc_lm_out$coefficients[2,1], 2)
r2 <- round(panc_lm_out$adj.r.squared, 2)

panc_compare_annotated.df %>% 
  ggplot(aes(log2(panc_6_nanopore_tpm + 1), log2(panc_7_nanopore_tpm + 1), color = clade, fill = clade)) + 
  geom_hex(alpha = 0.4, bins = 250) +
  annotate(geom = 'text', x = 3, y = 15, fontface = 'italic',
         label = paste0('y', ' ', ' = ',b,' + ',m,'x; adj. R2 = ', r2), 
         size = rel(3.75), alpha = 0.8) +
  scale_color_manual(values = te_color_pal) + 
  scale_fill_manual(values = te_color_pal) -> plt_SN2D.plt

import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


fig_SN2_layout <- "
AA
BB
CD
EE
"

wrap_plots(plt_SN2A.plt + ggtitle('illumina v illumina'),
           guide_area(),
           plt_SN2B.plt + ggtitle('nanopore v illumina'),
           plt_SN2C.plt + ggtitle('nanopore v illumina'),
           plt_SN2D.plt + ggtitle('nanopore v nanopore'),
           guides = 'collect',
           design = fig_SN2_layout,
           heights = c(1,0.25,1,1)) +
  plot_annotation(tag_levels = 'A') & 
  theme(legend.position = 'bottom')-> fig.SN2.patchwork

save.manuscript.panel(figure = 's3',
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_S3_2',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.SN2.patchwork)


```

# Figure_process_aware
## Fig_4A
```{r}
process.aware.salmon_quant$analysis_set$ctrl_panc_covid$unsplice_data.df %>% 
  merge(process.aware.salmon_quant$analysis_set$ctrl_panc_covid$quant_meta, by = 'sample') %>% 
  # filter(condition != 'covid') %>% 
  mutate(condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  ggplot(aes(condition, unsplice_rate, color = condition)) + 
  geom_boxplot(fill = NA, outlier.colour = NA) + 
  geom_point() + 
  scale_color_manual(values = identity_color_pal, guide = 'none') + 
  theme(legend.position = c(0.99,0.99)) + 
  coord_cartesian(clip = 'off') +
  ggpubr::stat_compare_means(method = 'wilcox', 
                             comparisons = list(c('panc', 'ctrl'), c('covid', 'ctrl'),  c('panc', 'covid'))) + 
  xlab('') + ylab('detection rate of un-spliced genes') -> plt_4A.plt
```
## Fig_4B
```{r}
SummarizedExperiment::assay(process.aware.salmon_quant$analysis_set$ctrl_panc_covid$gxi.split,
                            'unspliced') %>% as.data.frame() -> unsplice_counts_pca.df

unsplice_counts_pca.df %>% 
  select(!contains(qc_fails)) %>% 
  t() %>% 
  as.data.frame() -> unsplice_counts_pca.tmp
  
pca_tmp_in_sd <- apply(unsplice_counts_pca.tmp, 2, sd)
pca_tmp_in_zero_sd <- unsplice_counts_pca.tmp[,pca_tmp_in_sd!=0 & !is.na(pca_tmp_in_sd)]
non_zero_pca <- prcomp(pca_tmp_in_zero_sd, center = T, scale. = T, rank. = 50)

summary(non_zero_pca)
pcs.of.interest <- apply(non_zero_pca$x, 2, var)
pcs.props <-  pcs.of.interest/sum(pcs.of.interest)
cumsum(pcs.props)[c(1,2)]
print(as.data.frame(pcs.props) %>% 
        rownames_to_column('pc') %>% 
        mutate(pc = as.numeric(sub('PC', '', pc))) %>% 
        ggplot(aes(pc, pcs.props)) + 
        geom_col())

pca.out <- as.data.frame(non_zero_pca$x) %>% 
  rownames_to_column('sample') %>% 
  merge(process.aware.salmon_quant$analysis_set$ctrl_panc_covid$quant_meta %>% 
          select(sample, condition) %>% 
          ungroup() %>% distinct(), by = 'sample')

pca.out.summary <- 
  as.data.frame(summary(non_zero_pca)$importance) %>% 
  rownames_to_column('metric') %>% 
  gather(pc, value, -metric) %>% 
  spread(metric, value)

pca.out %>% 
  ggplot(aes(PC1, PC2,
             color = condition)) +
  geom_point(size = rel(2), alpha = 1) + 
  # scale_shape_manual(values = c(21,25)) +
  xlab(paste('PC1', round(cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
  ylab(paste('PC2', round(cumsum(pcs.props)[2] - cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
  geom_vline(xintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) +
  geom_hline(yintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) + 
  scale_color_manual(values = identity_color_pal) + 
  theme(legend.position = c(0.95,1), legend.direction = 'horizontal') -> plt_4B.plt
```
### Fig_4_patchwork
```{r}
import::from(.from = 'patchwork', plot_annotation, wrap_plots, guide_area, plot_spacer, wrap_elements)


fig_4_layout <- "
AABB
CCCC
CCCC
"

wrap_plots(plt_4A.plt,
           plt_4B.plt,
           plot_spacer(),
           design = fig_4_layout) +
  plot_annotation(tag_levels = 'A') -> fig.4.patchwork

save.manuscript.panel(figure = 4,
                      figure.dir = figure.dir,
                      name = 'patchwork_full_fig_4',
                      width = figure_double_column_width,
                      height = figure_depth,
                      plot.in = fig.4.patchwork)
```

```{r}
process.aware.salmon_quant$analysis_set$ctrl_panc_covid$unsplice_data.df %>% 
  merge(process.aware.salmon_quant$analysis_set$ctrl_panc_covid$quant_meta, by = 'sample') %>%
  mutate(condition = factor(condition, levels = c('panc', 'ctrl', 'covid'))) %>% 
  ggplot(aes(unsplice_rate, star_multimapped_percent, color = condition)) + 
  geom_point() + 
  ggforce::facet_col(~condition) + 
  geom_smooth(method = 'lm', se = F, linetype = 'dashed') + 
  scale_color_manual(values = identity_color_pal, guide = 'none')

SummarizedExperiment::assay(process.aware.salmon_quant$analysis_set$panc_ctrl$gxi, 'counts')  %>% 
  as.data.frame() %>% 
  rownames_to_column('ensg') %>% 
  filter(ensg == 'ENSG00000230021.10-I') %>% 
  gather(sample, count, -ensg) %>% 
  mutate(condition = ifelse(grepl('panc', sample), 'panc', 'ctrl')) %>% 
  ggplot(aes(condition, count)) + 
  geom_boxplot()
  


process.aware.salmon_quant$analysis_set$covid_ctrl$deseq$de_out %>% 
  merge(salmon_quant$analysis_set$covid_ctrl$deseq$de_out, by = 'gene') %>% 
  # filter(grepl('-I', ensg)) %>% View()
  ggplot(aes(log2FoldChange.x, log2FoldChange.y, label = gene)) +
  geom_point() + 
  ggrepel::geom_text_repel() + 
  geom_hline(yintercept = 0, linetype = 'dashed') +
  geom_vline(xintercept = 0, linetype = 'dashed')

unsplice_counts_pca.df %>% 
  rownames_to_column('ensg') %>% 
  merge(reference_meta_data$gencode_tx_to_gene.df %>% select(ensg, gene) %>% distinct(), by = 'ensg')

```


